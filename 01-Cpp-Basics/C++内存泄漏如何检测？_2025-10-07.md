å˜¿ï¼äº²çˆ±çš„ç¨‹åºå‘˜æˆ˜å‹ä»¬ï¼Œæˆ‘æ˜¯å°åº·ã€‚

ä»Šå¤©æˆ‘è¦è·Ÿä½ ä»¬èŠä¸€ä¸ªæœ‰è¶£çš„è¯é¢˜ â€” å¦‚ä½•æŠ“ä½ç¨‹åºä¸­æœ€ç‹¡çŒ¾çš„å°å·ï¼š**å†…å­˜æ³„æ¼ï¼**ğŸ•µï¸â€â™‚ï¸

æƒ³è±¡ä¸€ä¸‹è¿™ä¸ªåœºæ™¯: ä½ è¾›è¾›è‹¦è‹¦å†™äº†ä¸€ä¸ªç¨‹åºï¼Œåˆšå¼€å§‹è¿è¡Œå¾—å¥½å¥½çš„...

+ 1åˆ†é’Ÿå: "å—¯ï¼Œä¸€åˆ‡æ­£å¸¸!" ğŸ‘
+ 10åˆ†é’Ÿå: "æ€ä¹ˆæ„Ÿè§‰æœ‰ç‚¹å¡?" ğŸ¤”
+ 30åˆ†é’Ÿå: "æˆ‘çš„å†…å­˜å»å“ªäº†ï¼Ÿ!" ğŸ˜±
+ 1å°æ—¶å: "å•Šå•Šå•Š...ç¨‹åºå´©æºƒäº†!" ğŸ˜­

æ˜¯ä¸æ˜¯ç‰¹åˆ«çœ¼ç†Ÿï¼Ÿæ”¾è½»æ¾ï¼Œä¸æ˜¯ä½ ä¸€ä¸ªäºº! æ®è°ƒæŸ¥ï¼Œ90%çš„ç¨‹åºå‘˜éƒ½æ›¾ä¸å†…å­˜æ³„æ¼è¿™ä¸ª"éšå½¢æ€æ‰‹"æ–—æ™ºæ–—å‹‡ã€‚

ä»Šå¤©ï¼Œæˆ‘ä»¬å°±è¦åŒ–èº«ç¨‹åºç•Œçš„"åä¾¦æ¢æŸ¯å—"ï¼Œå­¦ä¹ å¦‚ä½•ç«çœ¼é‡‘ç›åœ°å‘ç°å†…å­˜æ³„æ¼ï¼Œè®©å®ƒæ— å¤„éå½¢ï¼æˆ‘æ‰¿è¯ºï¼Œçœ‹å®Œè¿™ç¯‡æ–‡ç« ï¼Œä½ å°±èƒ½åƒç ´æ¡ˆä¸€æ ·è½»æ¾åœ°è§£å†³å†…å­˜æ³„æ¼é—®é¢˜ï¼ğŸ”

è®©æˆ‘ä»¬å¼€å§‹ä»Šå¤©çš„ç ´æ¡ˆä¹‹æ—…å§ï¼âœ¨

## Windows å¹³å°ç¯‡ï¼šä» Visual Leak Detector (VLD) å¼€å§‹

### Visual Leak Detectorï¼šæœ€å‹å¥½çš„å†…å­˜æ£€æµ‹å·¥å…·

VLD æ˜¯ä¸€ä¸ªä¸“ä¸º Windows å¹³å° C++ å¼€å‘è®¾è®¡çš„å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·ï¼Œå®ƒçš„ä¼˜åŠ¿åœ¨äºï¼š

+ ä½¿ç”¨ç®€å•ï¼Œé…ç½®æ–¹ä¾¿
+  æ”¯æŒå¤šç§ç¼–è¯‘å™¨ç¯å¢ƒï¼ˆåŒ…æ‹¬ VC++ 6.0ã€Visual Studio ç­‰ï¼‰  
+ è‡ªåŠ¨ç”Ÿæˆè¯¦ç»†çš„è°ƒç”¨æ ˆä¿¡æ¯
+ å¯¹ç¨‹åºæ€§èƒ½å½±å“å°
+ å®Œå…¨å…è´¹ä¸”å¼€æº

#### å®‰è£…æ­¥éª¤ï¼š
**1ã€ä¸‹è½½ VLD**
+ è®¿é—® GitHub å®˜æ–¹ä»“åº“ï¼š[https://github.com/KindDragon/vld/releases](https://github.com/KindDragon/vld/releases)
+ ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„å®‰è£…åŒ…ï¼ˆä¾‹å¦‚ï¼švld-2.7.0-setup.exeï¼‰

**2ã€å®‰è£… VLD**
+ è¿è¡Œä¸‹è½½çš„å®‰è£…ç¨‹åº
+ é€‰æ‹©å®‰è£…è·¯å¾„ï¼Œå®Œæˆå®‰è£…

**3ã€é…ç½® Visual Studio é¡¹ç›®** 
+ å³é”®ç‚¹å‡»é¡¹ç›® -> å±æ€§
+ åœ¨"VC++ ç›®å½•"ä¸­ï¼š 
    - åŒ…å«ç›®å½•ï¼šæ·»åŠ  `å®‰è£…è·¯å¾„\Visual Leak Detector\include`
    - åº“ç›®å½•ï¼šæ·»åŠ  `å®‰è£…è·¯å¾„\Visual Leak Detector\lib\Win64` æˆ– `Win32`ï¼ˆæ ¹æ®ä½ çš„é¡¹ç›®å¹³å°é€‰æ‹©ï¼‰

#### ä½¿ç”¨æ–¹æ³•ï¼š
åœ¨ä½ çš„ä¸»ç¨‹åºæ–‡ä»¶é¡¶éƒ¨æ·»åŠ ï¼š

```c++
#include <vld.h>
```

ç¼–è¯‘å¹¶è¿è¡Œç¨‹åºï¼ŒVLD ä¼šè‡ªåŠ¨å·¥ä½œã€‚å½“ç¨‹åºç»“æŸæ—¶ï¼Œå®ƒä¼šåœ¨è¾“å‡ºçª—å£æ˜¾ç¤ºè¯¦ç»†çš„å†…å­˜æ³„æ¼æŠ¥å‘Šã€‚

#### ç¤ºä¾‹ä»£ç ï¼š
```c++
#include <vld.h>
#include <iostream>

int main() {
    // åˆ¶é€ ä¸€ä¸ªå†…å­˜æ³„æ¼
    int* leakedMemory = new int[100];
    
    std::cout << "ç¨‹åºè¿è¡Œä¸­..." << std::endl;
    // æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰ delete[] leakedMemory
    
    return 0;
}
```

#### è°ƒè¯•æŠ€å·§ï¼š
+ VLD æŠ¥å‘Šä¼šæ˜¾ç¤ºå†…å­˜æ³„æ¼çš„å…·ä½“ä½ç½®ï¼ˆæ–‡ä»¶åå’Œè¡Œå·ï¼‰
+ æ˜¾ç¤ºå®Œæ•´çš„è°ƒç”¨æ ˆï¼Œå¸®ä½ è¿½è¸ªæ³„æ¼çš„æ¥æº
+ å¦‚æœå‘ç°å¤§é‡é‡å¤çš„æ³„æ¼ï¼Œå¾ˆå¯èƒ½æ˜¯åœ¨å¾ªç¯ä¸­å¿˜è®°é‡Šæ”¾å†…å­˜
+ Debug æ¨¡å¼ä¸‹ä½¿ç”¨ VLD æ•ˆæœæœ€ä½³

## ğŸ§ Linuxå¹³å°ç¯‡
### 1. mtrace - å°å·§ç²¾æ‚çš„å†…å­˜è¿½è¸ªå™¨
mtrace å°±åƒä¸€ä½å°½èŒçš„å°ç®¡å®¶ï¼Œé»˜é»˜è®°å½•ç€æ¯ä¸€ç¬”"å†…å­˜è´¦å•"ã€‚å®ƒæ˜¯ glibc çš„ä¸€éƒ¨åˆ†ï¼Œç®€å•æ˜“ç”¨ï¼  

#### ä½¿ç”¨æ­¥éª¤ï¼š

**1ã€åœ¨ä»£ç ä¸­å¸ƒç½®"ç›‘æ§"**:

```c++
#include <mcheck.h>

int main() {
    mtrace();    // å¼€å¯è®°è´¦æœ¬
    
    // ä½ çš„ä»£ç ...
    
    muntrace();  // åˆä¸Šè®°è´¦æœ¬
    return 0;
}
```

**2ã€è¿è¡Œæ£€æµ‹**ï¼š

```bash
# è®¾ç½®æ—¥å¿—æ–‡ä»¶
export MALLOC_TRACE=mtrace.log

# ç¼–è¯‘å¹¶è¿è¡Œ
g++ -g program.cpp -o program
./program

# æŸ¥çœ‹ç»“æœ
mtrace ./program mtrace.log
```

**æ£€æµ‹æŠ¥å‘Šç¤ºä¾‹**ï¼š

```bash
Memory not freed:
-----------------
           Address     Size     Caller
0x000055974621b6a0      0x4  at 0x7f94b084170c
0x000055974621b6c0     0x14  at 0x7f94b084170c

```

**å°ç®¡å®¶çš„è´¦æœ¬ä¼šå‘Šè¯‰ä½ **ï¼š

+  å“ªäº›å†…å­˜è¢«åˆ†é…äº†ä½†æ²¡æœ‰é‡Šæ”¾ï¼ˆAddress åˆ—ï¼‰  
+ æ³„æ¼äº†å¤šå°‘å†…å­˜ï¼ˆSize åˆ—ï¼Œè¿™é‡Œæ˜¯ 4 å­—èŠ‚å’Œ 20 å­—èŠ‚ï¼‰
+ è°ƒç”¨è€…çš„å†…å­˜åœ°å€ï¼ˆCaller åˆ—ï¼‰- ä¸è¿‡éœ€è¦é¢å¤–å·¥å…·è½¬æ¢æˆå…·ä½“è¡Œå·

mtrace çš„ä¼˜åŠ¿åœ¨äºè½»é‡çº§ï¼Œå‡ ä¹ä¸å½±å“ç¨‹åºè¿è¡Œé€Ÿåº¦ã€‚ä½†å®ƒçš„è¾“å‡ºç¡®å®æ¯”è¾ƒåŸå§‹ï¼Œéœ€è¦ç»“åˆ addr2line ç­‰å·¥å…·æ¥è·å–æ›´å‹å¥½çš„ä¿¡æ¯ã€‚

å¯¹äºå¿«é€Ÿæ£€æŸ¥å°ç¨‹åºæ˜¯å¦å­˜åœ¨æ³„æ¼ï¼Œè¿™ä½å°ç®¡å®¶å·²ç»å¤Ÿç”¨äº†ï¼å¦‚æœéœ€è¦æ›´è¯¦ç»†çš„åˆ†æï¼Œè¿˜æ˜¯å»ºè®®ä½¿ç”¨ Valgrind è¿™æ ·çš„é‡é‡çº§å·¥å…·ã€‚

### 2. Dr. Memory - è·¨å¹³å°ç¥å™¨
Dr. Memory å°±åƒä¸€ä½ç»éªŒä¸°å¯Œçš„åŒ»ç”Ÿï¼Œèƒ½ç²¾ç¡®è¯Šæ–­å‡ºä½ çš„ç¨‹åºå“ªé‡Œ"ç”Ÿç—…"äº†ã€‚å®ƒä¸ä»…èƒ½å‘ç°å†…å­˜æ³„æ¼ï¼Œè¿˜èƒ½æŸ¥å‡ºå…¶ä»–å†…å­˜æ–¹é¢çš„"é¡½ç–¾"ï¼

#### å®‰è£…æ­¥éª¤ï¼š
```bash
# ä¸‹è½½å®‰è£…åŒ… DrMemory-Linux-2.6.0.tar.gz
è®¿é—®ç½‘å€: https://drmemory.org/page_download.html 
# è§£å‹å¹¶è®¾ç½®
tar -zxvf DrMemory-Linux-2.6.0.tar.gz
echo 'export PATH=$PATH:~/drmemory/DrMemory-Linux-2.5.0/bin' >> ~/.bashrc
source ~/.bashrc
```

#### ä½¿ç”¨æ–¹æ³•ï¼š
```bash
# ç¼–è¯‘æ—¶æ·»åŠ è°ƒè¯•ä¿¡æ¯
g++ -g your_program.cpp -o your_program

# å¯åŠ¨æ£€æµ‹
drmemory -- ./your_program
```

#### è¯Šæ–­æŠ¥å‘Šç¤ºä¾‹ï¼š
```bash
# éƒ¨åˆ†è¾“å‡ºï¼š
ERRORS FOUND:
~~Dr.M~~ 0 unique, 0 total unaddressable access(es)      # æœªåˆ†é…å†…å­˜è®¿é—®
~~Dr.M~~ 0 unique, 0 total uninitialized access(es)      # æœªåˆå§‹åŒ–å†…å­˜
~~Dr.M~~ 0 unique, 0 total invalid heap argument(s)      # æ— æ•ˆçš„å †æ“ä½œ
~~Dr.M~~ 0 unique, 0 total warning(s)                    # è­¦å‘Šä¿¡æ¯
~~Dr.M~~ 1 unique, 1 total, 20 byte(s) of leak(s)       # ç¡®è®¤çš„å†…å­˜æ³„æ¼
~~Dr.M~~ 0 unique, 0 total, 0 byte(s) of possible leak(s) # å¯èƒ½çš„å†…å­˜æ³„æ¼
```

**ä»è¿™ä»½"ä½“æ£€æŠ¥å‘Š"å¯ä»¥çœ‹å‡º**ï¼š

+ ç¨‹åºå­˜åœ¨ä¸€å¤„å†…å­˜æ³„æ¼
+ æ³„æ¼å¤§å°ä¸º20å­—èŠ‚
+ å…¶ä»–å†…å­˜ä½¿ç”¨éƒ½å¾ˆå¥åº·

**æŠ¥å‘Šè¿˜ä¼šæ¸…æ™°åœ°æ˜¾ç¤º**:

+ å†…å­˜æ³„æ¼çš„ä½ç½®
+ æ³„æ¼çš„å¤§å°
+ è°ƒç”¨æ ˆä¿¡æ¯ç­‰

### 3. Valgrind - å†…å­˜æ£€æµ‹ç•Œçš„"è€å¸æœº"
Valgrind å°±åƒä¸€ä½ç»éªŒä¸°å¯Œçš„è€å¸æœºï¼Œèƒ½å¸¦ä½ ç¨³ç¨³åœ°æ‰¾å‡ºç¨‹åºä¸­å„ç§éšè”½çš„å†…å­˜é—®é¢˜ã€‚å®ƒä¸ä»…èƒ½æ‰¾å‡ºå†…å­˜æ³„æ¼ï¼Œè¿˜èƒ½æ£€æµ‹æ•°ç»„è¶Šç•Œã€æ‚¬å‚æŒ‡é’ˆå’Œå„ç§æœªå®šä¹‰è¡Œä¸ºï¼Œæ˜¯ Linux å¹³å°ä¸Šæœ€å…¨é¢çš„å†…å­˜æ£€æµ‹å·¥å…·ä¹‹ä¸€ï¼

#### å®‰è£…ä¸åŸºæœ¬ä½¿ç”¨ï¼š
```bash
# å®‰è£…
sudo apt-get install valgrind

# ä½¿ç”¨ g++ ç¼–è¯‘ C++ ç¨‹åº
g++ -g -O0 your_program.cpp -o your_program

# åŸºæœ¬ä½¿ç”¨
valgrind --leak-check=full ./your_program
```

#### Valgrind å¸¸ç”¨é€‰é¡¹ï¼š
**1ã€å†…å­˜æ³„æ¼æ£€æµ‹ç›¸å…³ï¼š**

```bash
--leak-check=full          # è¯¦ç»†çš„å†…å­˜æ³„æ¼æ£€æµ‹
--show-leak-kinds=all      # æ˜¾ç¤ºæ‰€æœ‰ç±»å‹çš„æ³„æ¼
--track-origins=yes        # è¿½è¸ªæœªåˆå§‹åŒ–å€¼çš„æ¥æº
--verbose                  # æ˜¾ç¤ºæ›´è¯¦ç»†çš„ä¿¡æ¯
```

 **2ã€å·¥å…·é€‰æ‹©ï¼š**

```bash
--tool=memcheck            # é»˜è®¤å·¥å…·ï¼Œæ£€æµ‹å†…å­˜é”™è¯¯
--tool=helgrind            # æ£€æµ‹çº¿ç¨‹é”™è¯¯ï¼Œå¦‚æ•°æ®ç«äº‰
--tool=cachegrind          # ç¼“å­˜å’Œåˆ†æ”¯é¢„æµ‹åˆ†æ
--tool=callgrind           # å‡½æ•°è°ƒç”¨åˆ†æ
--tool=massif              # å †å†…å­˜ä½¿ç”¨åˆ†æ
```

#### Valgrind æŠ¥å‘Šè§£è¯»ï¼š
+ **definitely lost**ï¼šç¡®å®šçš„å†…å­˜æ³„æ¼ï¼Œå¿…é¡»ä¿®å¤
+ **indirectly lost**ï¼šç”±äºæŒ‡é’ˆç»“æ„é—®é¢˜å¯¼è‡´çš„æ³„æ¼
+ **possibly lost**ï¼šå¯èƒ½çš„æ³„æ¼ï¼Œå–å†³äºä½ å¦‚ä½•ç®¡ç†æŒ‡é’ˆ
+ **still reachable**ï¼šç¨‹åºç»“æŸæ—¶ä»å¯è®¿é—®ä½†æœªé‡Šæ”¾çš„å†…å­˜
+ **Invalid read/write**ï¼šè¯»/å†™æ— æ•ˆå†…å­˜åœ°å€
+ **Source and destination overlap**ï¼šå†…å­˜é‡å æ‹·è´

#### å®æˆ˜åœºæ™¯1ï¼šå†…å­˜æ³„æ¼æ£€æµ‹
```c++
#include <stdlib.h>

int main() {
    // åˆ†é…å†…å­˜ä½†å¿˜è®°é‡Šæ”¾
    int* array = (int*)malloc(10 * sizeof(int));
    return 0;
}
```

**è¿è¡Œç»“æœï¼š**

```bash
$ valgrind --leak-check=full ./memory_leak
==15673== Memcheck, a memory error detector
==15673== Command: ./memory_leak
==15673== 
==15673== HEAP SUMMARY:
==15673==     in use at exit: 40 bytes in 1 blocks
==15673==   total heap usage: 1 allocs, 0 frees, 40 bytes allocated
==15673== 
==15673== 40 bytes in 1 blocks are definitely lost in loss record 1 of 1
==15673==    at 0x4C31B25: malloc (vg_replace_malloc.c:299)
==15673==    by 0x400544: main (memory_leak.c:5)
==15673== 
==15673== LEAK SUMMARY:
==15673==    definitely lost: 40 bytes in 1 blocks
==15673==    indirectly lost: 0 bytes in 0 blocks
==15673==    possibly lost: 0 bytes in 0 blocks
==15673==    still reachable: 0 bytes in 0 blocks
==15673==    suppressed: 0 bytes in 0 blocks
```

çœ‹è¿™æŠ¥å‘Šå¤šè¯¦ç»†ï¼šä¸ä»…å‘Šè¯‰ä½ æ³„æ¼äº†40å­—èŠ‚ï¼Œè¿˜ç²¾ç¡®æŒ‡å‡ºæ˜¯åœ¨ memory_leak.c çš„ç¬¬5è¡Œï¼

#### å®æˆ˜åœºæ™¯2ï¼šæ•°ç»„è¶Šç•Œè®¿é—®
```c++
#include <string.h>

int main() {
    char buffer[10];
    // è¶Šç•Œå†™å…¥
    strcpy(buffer, "This string is too long for the buffer");
    return 0;
}
```

**è¿è¡Œç»“æœï¼š**

```bash
xioakang@ubuntu:~/C++/memoryLeak$ valgrind ./test 
==14614== Memcheck, a memory error detector
==14614== Command: ./test
==14614== 
*** stack smashing detected ***: terminated
==14614== 
==14614== Process terminating with default action of signal 6 (SIGABRT)
==14614==    at 0x4B0E00B: raise (raise.c:51)
==14614==    by 0x4AED858: abort (abort.c:79)
==14614==    by 0x4B58265: __libc_message (libc_fatal.c:156)
==14614==    by 0x4BFACD9: __fortify_fail (fortify_fail.c:26)
==14614==    by 0x4BFACA5: __stack_chk_fail (stack_chk_fail.c:24)
==14614==    by 0x109208: main (test.cpp:6)
==14614== 
==14614== HEAP SUMMARY:
==14614==     in use at exit: 0 bytes in 0 blocks
==14614==   total heap usage: 1 allocs, 1 frees, 73,728 bytes allocated
==14614== 
==14614== All heap blocks were freed -- no leaks are possible
```

è€å¸æœºç«‹åˆ»å°±å‘ç°äº†ï¼Œä½ åœ¨å†™å…¥ç¬¬11ä¸ªå­—èŠ‚æ—¶å·²ç»è¶Šç•Œäº†ï¼

#### å®æˆ˜åœºæ™¯3ï¼šä½¿ç”¨æœªåˆå§‹åŒ–çš„å†…å­˜
```c++
#include <stdio.h>

int main() {
    int a;  // æœªåˆå§‹åŒ–
    if (a > 0) {  // ä½¿ç”¨æœªåˆå§‹åŒ–çš„å€¼
        printf("a is positive\n");
    }
    return 0;
}
```

**è¿è¡Œç»“æœï¼š**

```bash
xioakang@ubuntu:~/C++/memoryLeak$ valgrind --track-origins=yes ./test 
==14842== Memcheck, a memory error detector
==14842== Command: ./test
==14842== 
==14842== Conditional jump or move depends on uninitialised value(s)
==14842==    at 0x109199: main (test.cpp:8)
==14842==  Uninitialised value was created by a stack allocation
==14842==    at 0x109189: main (test.cpp:6)
==14842== 
==14842== 
==14842== HEAP SUMMARY:
==14842==     in use at exit: 0 bytes in 0 blocks
==14842==   total heap usage: 1 allocs, 1 frees, 73,728 bytes allocated
==14842== 
==14842== All heap blocks were freed -- no leaks are possible
```

è€å¸æœºåˆå‘ç°é—®é¢˜äº†ï¼šåœ¨ç¬¬5è¡Œï¼Œä½ ç”¨ä¸€ä¸ªæœªåˆå§‹åŒ–çš„å€¼è¿›è¡Œäº†æ¡ä»¶åˆ¤æ–­ï¼

#### å®æˆ˜åœºæ™¯4ï¼šä½¿ç”¨å·²é‡Šæ”¾çš„å†…å­˜ï¼ˆæ‚¬å‚æŒ‡é’ˆï¼‰
```c++
#include <stdlib.h>
#include <stdio.h>

int main() {
    int* ptr = (int*)malloc(sizeof(int));
    *ptr = 10;
    free(ptr);        // é‡Šæ”¾å†…å­˜
    *ptr = 20;        // ä½¿ç”¨å·²é‡Šæ”¾çš„å†…å­˜
    printf("%d\n", *ptr);
    
    return 0;
}
```

**è¿è¡Œç»“æœï¼š**

```bash
$ valgrind ./use_after_free
==17982== Memcheck, a memory error detector
==17982== Command: ./use_after_free
==17982== 
==17982== Invalid write of size 4
==17982==    at 0x400563: main (use_after_free.c:8)
==17982==  Address 0x5204040 is 0 bytes inside a block of size 4 free'd
==17982==    at 0x4C30D3B: free (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==17982==    by 0x400558: main (use_after_free.c:7)
==17982== 
==17982== Invalid read of size 4
==17982==    at 0x400572: main (use_after_free.c:9)
==17982==  Address 0x5204040 is 0 bytes inside a block of size 4 free'd
==17982==    at 0x4C30D3B: free (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==17982==    by 0x400558: main (use_after_free.c:7)
```

Valgrind ç«‹å³å‘ç°äº†ä¸¤å¤„ä¸¥é‡é”™è¯¯ï¼šåœ¨é‡Šæ”¾å†…å­˜åï¼Œä½ ä»ç„¶åœ¨ç¬¬8è¡Œå†™å…¥æ•°æ®ï¼Œç¬¬9è¡Œè¯»å–æ•°æ®ï¼è¿™ç§"æ‚¬å‚æŒ‡é’ˆ"é—®é¢˜æ˜¯å†…å­˜æ¼æ´çš„ä¸»è¦æ¥æºï¼  

#### å®æˆ˜åœºæ™¯5ï¼šé‡å¤é‡Šæ”¾åŒä¸€å—å†…å­˜
```c++
#include <iostream>
#include <cstring>

#include <stdlib.h>

int main() {
    int* ptr = (int*)malloc(sizeof(int));

    free(ptr);    // ç¬¬ä¸€æ¬¡é‡Šæ”¾
    free(ptr);    // ç¬¬äºŒæ¬¡é‡Šæ”¾ï¼ˆé”™è¯¯ï¼‰

    return 0;
}

```

**è¿è¡Œç»“æœï¼š**

```bash
xioakang@ubuntu:~/C++/memoryLeak$ valgrind ./test 
==15063== Memcheck, a memory error detector
==15063== Command: ./test
==15063== 
==15063== Invalid free() / delete / delete[] / realloc()
==15063==    at 0x483CA3F: free (in /usr/lib/x86_64-linux-gnu/valgrind/vgpreload_memcheck-amd64-linux.so)
==15063==    by 0x1091DA: main (test.cpp:10)
==15063==  Address 0x4e48080 is 0 bytes inside a block of size 4 free'd
==15063==    at 0x483CA3F: free (in /usr/lib/x86_64-linux-gnu/valgrind/vgpreload_memcheck-amd64-linux.so)
==15063==    by 0x1091CE: main (test.cpp:9)
==15063==  Block was alloc'd at
==15063==    at 0x483B7F3: malloc (in /usr/lib/x86_64-linux-gnu/valgrind/vgpreload_memcheck-amd64-linux.so)
==15063==    by 0x1091BE: main (test.cpp:7)
==15063== 
==15063== 
==15063== HEAP SUMMARY:
==15063==     in use at exit: 0 bytes in 0 blocks
==15063==   total heap usage: 2 allocs, 3 frees, 73,732 bytes allocated
==15063== 
==15063== All heap blocks were freed -- no leaks are possible
```

Valgrind ç«‹å³æŠ“ä½äº†ç¬¬7è¡Œçš„è‡´å‘½é”™è¯¯ï¼šä½ æ­£åœ¨å°è¯•ç¬¬äºŒæ¬¡é‡Šæ”¾åŒä¸€å—å†…å­˜ï¼è¿™ç§"åŒé‡é‡Šæ”¾"é—®é¢˜ä¼šç ´åå†…å­˜ç®¡ç†å™¨çš„æ•°æ®ç»“æ„ï¼Œå¯èƒ½å¼•å‘ç¨‹åºå´©æºƒ ã€‚

#### å®æˆ˜åœºæ™¯6ï¼šé”™ä½çš„å†…å­˜é‡Šæ”¾ï¼ˆmalloc/new ä¸ free/delete ä¸åŒ¹é…ï¼‰
```c++
#include <stdlib.h>
#include <new>

int main() {
    // ä½¿ç”¨ new åˆ†é…
    int* ptr1 = new int;
    
    // é”™è¯¯ï¼šä½¿ç”¨ free é‡Šæ”¾
    free(ptr1);
    
    // ä½¿ç”¨ malloc åˆ†é…
    int* ptr2 = (int*)malloc(sizeof(int));
    
    // é”™è¯¯ï¼šä½¿ç”¨ delete é‡Šæ”¾
    delete ptr2;
    
    return 0;
}
```

**è¿è¡Œç»“æœï¼š**

```bash
xioakang@ubuntu:~/C++/memoryLeak$ valgrind ./test 
==16032== Memcheck, a memory error detector
==16032== Command: ./test
==16032== 
==16032== Mismatched free() / delete / delete []
==16032==    at 0x483CA3F: free (in /usr/lib/x86_64-linux-gnu/valgrind/vgpreload_memcheck-amd64-linux.so)
==16032==    by 0x10920E: main (test.cpp:12)
==16032==  Address 0x4e48080 is 0 bytes inside a block of size 4 alloc'd
==16032==    at 0x483BE63: operator new(unsigned long) (in /usr/lib/x86_64-linux-gnu/valgrind/vgpreload_memcheck-amd64-linux.so)
==16032==    by 0x1091FE: main (test.cpp:9)
==16032== 
==16032== Mismatched free() / delete / delete []
==16032==    at 0x483D1CF: operator delete(void*, unsigned long) (in /usr/lib/x86_64-linux-gnu/valgrind/vgpreload_memcheck-amd64-linux.so)
==16032==    by 0x109232: main (test.cpp:18)
==16032==  Address 0x4e480d0 is 0 bytes inside a block of size 4 alloc'd
==16032==    at 0x483B7F3: malloc (in /usr/lib/x86_64-linux-gnu/valgrind/vgpreload_memcheck-amd64-linux.so)
==16032==    by 0x109218: main (test.cpp:15)

```

Valgrind å‘ç°äº†å†…å­˜é‡Šæ”¾æ–¹å¼ä¸åŒ¹é…çš„é”™è¯¯ï¼è®°ä½è¿™ä¸ªé»„é‡‘æ³•åˆ™ï¼š**new é…å¯¹ deleteï¼Œmalloc é…å¯¹ free**ï¼Œæ··ç”¨ä¼šå¯¼è‡´å†…å­˜ç®¡ç†å™¨å†…éƒ¨ç»“æ„è¢«ç ´åï¼  

#### å®æˆ˜åœºæ™¯7ï¼šå¤šçº¿ç¨‹æ•°æ®ç«äº‰
```c++
#include <pthread.h>
#include <stdio.h>

int shared_counter = 0;

void* increment_counter(void* arg) {
    for (int i = 0; i < 100000; i++) {
        shared_counter++; // æ— é”ä¿æŠ¤çš„å…±äº«æ•°æ®è®¿é—®
    }
    return NULL;
}

int main() {
    pthread_t thread1, thread2;
    
    pthread_create(&thread1, NULL, increment_counter, NULL);
    pthread_create(&thread2, NULL, increment_counter, NULL);
    
    pthread_join(thread1, NULL);
    pthread_join(thread2, NULL);
    
    printf("Final counter value: %d\n", shared_counter);
    return 0;
}
```

**è¿è¡Œç»“æœï¼š**

```c++
$ g++ -pthread -g thread_race.cpp -o thread_race
$ valgrind --tool=helgrind ./thread_race
==19245== Helgrind, a thread error detector
==19245== Command: ./thread_race
==19245== 
==19245== Possible data race during read of size 4 at 0x601068 by thread #3
==19245==    at 0x400664: increment_counter(void*) (thread_race.cpp:8)
==19245==  This conflicts with a previous write of size 4 by thread #2
==19245==    at 0x400664: increment_counter(void*) (thread_race.cpp:8)
==19245==  Address 0x601068 is 0 bytes inside global var "shared_counter"
==19245==    declared at thread_race.cpp:4
```

Valgrind é€šè¿‡ Helgrind å·¥å…·ç²¾ç¡®å‘ç°äº†ç¬¬8è¡Œçš„å¤šçº¿ç¨‹æ•°æ®ç«äº‰é—®é¢˜ï¼ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹ shared_counter å˜é‡å´æ²¡æœ‰åŒæ­¥æœºåˆ¶ï¼Œå¯¼è‡´è®¡æ•°ç»“æœä¸å¯é¢„æµ‹ï¼Œè¿™æ˜¯å¤šçº¿ç¨‹ç¨‹åºä¸­æœ€å¸¸è§ä¹Ÿæœ€éš¾æ’æŸ¥çš„é—®é¢˜ç±»å‹ä¹‹ä¸€ã€‚  

### 4. AddressSanitizer (ASan) - æ€§èƒ½ä¸æ˜“ç”¨çš„å®Œç¾å¹³è¡¡
AddressSanitizer å°±åƒæ˜¯ç¨‹åºä»£ç ä¸­çš„é˜²ç›—æŠ¥è­¦ç³»ç»Ÿï¼Œåœ¨é—®é¢˜å‘ç”Ÿçš„é‚£ä¸€åˆ»å°±èƒ½å“èµ·è­¦æŠ¥ï¼å®ƒç›´æ¥é›†æˆåœ¨ç¼–è¯‘å™¨ä¸­ï¼Œæ— éœ€é¢å¤–å·¥å…·ï¼Œä¸€æ¡ç¼–è¯‘å‘½ä»¤å°±èƒ½æ¿€æ´»è¿™ä½24å°æ—¶å€¼ç­çš„å®ˆå«ã€‚  

#### ä½¿ç”¨æ–¹æ³•ï¼š
```bash
# ç¼–è¯‘æ—¶å¼€å¯ ASanï¼ˆæ¯”æ™®é€šè°ƒè¯•åªæ…¢2-3å€ï¼ï¼‰
g++ -fsanitize=address -g your_program.cpp -o your_program

# ç›´æ¥è¿è¡Œå³å¯
./your_program
```

#### å¸¸è§å†…å­˜é—®é¢˜åŠå®ä¾‹:

**1ã€æ•°ç»„è¶Šç•Œè®¿é—®**:

```c++
int main() {
    int array[5] = {0};
    array[10] = 1;  // è¶Šç•Œè®¿é—®
    return 0;
}
```

**è¾“å‡º:**

```bash
==30498==ERROR: AddressSanitizer: stack-buffer-overflow on address 0x7ffd46e3503c at pc 0x5632a6f8b1a9 bp 0x7ffd46e34ff0 sp 0x7ffd46e34fe0
WRITE of size 4 at 0x7ffd46e3503c thread T0
    #0 0x5632a6f8b1a8 in main example.cpp:3
```

**2ã€é‡Šæ”¾åä½¿ç”¨**:

```c++
int main() {
    int* p = new int(42);
    delete p;
    *p = 10;  // ä½¿ç”¨å·²é‡Šæ”¾çš„å†…å­˜
    return 0;
}
```

**è¾“å‡º:**

```bash
==30655==ERROR: AddressSanitizer: heap-use-after-free on address 0x606000000040 at pc 0x7fb5617bb1a9 bp 0x7ffc28c56f10 sp 0x7ffc28c56f00
WRITE of size 4 at 0x606000000040 thread T0
    #0 0x7fb5617bb1a8 in main example.cpp:4
```

**3ã€å†…å­˜æ³„æ¼**:

```c++
int main() {
    int* p = new int[100];  // æ²¡æœ‰é…å¯¹çš„ delete[]
    return 0;
}
```

**è¾“å‡º:**

```bash
==31041==ERROR: LeakSanitizer: detected memory leaks
Direct leak of 400 bytes in 1 objects allocated from:
    #0 0x7f84e5bd4bc8 in operator new[](unsigned long) 
    #1 0x55907893a1b9 in main example.cpp:2
```

**4ã€æ ˆç¼“å†²åŒºæº¢å‡º**:

```c++
void function() {
    char buffer[10];
    strcpy(buffer, "This string is too long for the buffer");
}
```

**è¾“å‡º:**

```bash
==31299==ERROR: AddressSanitizer: stack-buffer-overflow on address 0x7ffce822c8aa at pc 0x7f9e5f43282c
WRITE of size 38 at 0x7ffce822c8aa thread T0
    #0 0x7f9e5f43282b in strcpy
    #1 0x561fe803a1c9 in function example.cpp:3
```

AddressSanitizer æ˜¯å¼€å‘é˜¶æ®µæœ€é«˜æ•ˆçš„å†…å­˜æ£€æµ‹å·¥å…·ä¹‹ä¸€ã€‚å®ƒç›´æ¥é›†æˆåˆ°ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œè¿è¡Œé€Ÿåº¦å¿«ï¼ˆåªæ¯”æ™®é€šè°ƒè¯•æ…¢2-3å€ï¼‰ï¼ŒåŒæ—¶èƒ½æ•è·ç»å¤§å¤šæ•°å†…å­˜é—®é¢˜ã€‚æ— éœ€é¢å¤–å®‰è£…ï¼Œä¸€é”®å¼€å¯ï¼Œæ˜¯ç°ä»£ C/C++ å¼€å‘çš„å¿…å¤‡ç¥å™¨ï¼

### 5. Memory Sanitizer (MSan) - æœªåˆå§‹åŒ–å†…å­˜æ£€æµ‹ä¸“å®¶
Memory Sanitizer å°±åƒæ˜¯ä¸€ä½ä¸“æ³¨äºç‰¹å®šé¢†åŸŸçš„å®‰å…¨ä¸“å®¶ï¼Œå®ƒçš„ç‹¬é—¨ç»æŠ€æ˜¯ï¼šå‘ç°å¹¶æŠ¥å‘Šç¨‹åºä¸­ä½¿ç”¨æœªåˆå§‹åŒ–å†…å­˜çš„é—®é¢˜ã€‚è¿™ç±»é—®é¢˜ç‰¹åˆ«éšè”½ï¼Œå¾€å¾€ä¼šå¯¼è‡´ç¨‹åºè¡Œä¸ºä¸å¯é¢„æµ‹ï¼ŒMSan æ­£æ˜¯ä¸ºæ­¤è€Œç”Ÿï¼

#### ä½¿ç”¨æ–¹æ³•ï¼š
```bash
# g++ å¯èƒ½ä¸æ”¯æŒ MSanï¼Œä½†æ˜¯ clang æ”¯æŒ
# å®‰è£… Clang
sudo apt-get install clang

# ç¼–è¯‘æ—¶å¼€å¯ MSan 
clang -fsanitize=memory -fPIE -pie -g your_program.cpp -o your_program
```

**å‚æ•°è¯´æ˜**ï¼š

+ `-fsanitize=memory`: å¯ç”¨ Memory Sanitizer
+ `-fPIE` å’Œ `-pie`: ç”Ÿæˆä½ç½®æ— å…³çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆMSan éœ€è¦ï¼‰
+ `-g`: æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼Œä½¿æŠ¥å‘Šæ˜¾ç¤ºæºç è¡Œå·

#### å…¸å‹é—®é¢˜ç¤ºä¾‹ï¼š

**1ã€æœªåˆå§‹åŒ–çš„å±€éƒ¨å˜é‡**ï¼š

```c++
int main() {
    int value;  // æœªåˆå§‹åŒ–
    int result = value + 10;  // ä½¿ç”¨æœªåˆå§‹åŒ–çš„å€¼
    return result;
}
```

**è¾“å‡º:**

```bash
==31604==WARNING: MemorySanitizer: use-of-uninitialized-value
    #0 0x7f3a53be02cf in main uninit_var.cpp:3:18
    #1 0x7f3a53814023 in __libc_start_main (...) 
    #2 0x7f3a53be014e in _start (...)
SUMMARY: MemorySanitizer: use-of-uninitialized-value uninit_var.cpp:3:18 in main
```

**2ã€ç»“æ„ä½“éƒ¨åˆ†åˆå§‹åŒ–**ï¼š

```c++
struct Point {
    int x;
    int y;
};

int main() {
    Point p;
    p.x = 5;  // åªåˆå§‹åŒ–äº†x
    // p.y æœªåˆå§‹åŒ–
    
    int sum = p.x + p.y;  // ä½¿ç”¨æœªåˆå§‹åŒ–çš„p.y
    
    // æ·»åŠ æ¡ä»¶åˆ¤æ–­ï¼Œä½¿æœªåˆå§‹åŒ–å€¼çš„ä½¿ç”¨æ›´æ˜æ˜¾
    if (sum > 10) {
        return 1;
    }
    
    return 0;
}
```

**è¾“å‡º:**

```bash
==31842==WARNING: MemorySanitizer: use-of-uninitialized-value
    #0 0x7f52f8abd32f in main struct_partial_init.cpp:9:20
    #1 0x7f52f87cb023 in __libc_start_main (...)
    #2 0x7f52f8abd14e in _start (...)
SUMMARY: MemorySanitizer: use-of-uninitialized-value struct_partial_init.cpp:9:20 in main
```

**3ã€é€šè¿‡æŒ‡é’ˆä¼ æ’­æœªåˆå§‹åŒ–å€¼**ï¼š

```c++
void copy(int* dst, int* src) {
    *dst = *src;  // ä¼ æ’­å¯èƒ½æœªåˆå§‹åŒ–çš„å€¼
}

int main() {
    int a;  // æœªåˆå§‹åŒ–
    int b;
    
    copy(&b, &a);  // å°†æœªåˆå§‹åŒ–çš„aå¤åˆ¶åˆ°b
    return b;  // ä½¿ç”¨å¯èƒ½æœªåˆå§‹åŒ–çš„å€¼
}
```

**è¾“å‡º:**

```bash
==32067==WARNING: MemorySanitizer: use-of-uninitialized-value
    #0 0x7fef55aa834e in copy pointer_propagation.cpp:2:13
    #1 0x7fef55aa83a1 in main pointer_propagation.cpp:8:5
    #2 0x7fef557b6023 in __libc_start_main (...)
SUMMARY: MemorySanitizer: use-of-uninitialized-value pointer_propagation.cpp:2:13 in copy
```

**4ã€æ¡ä»¶åˆ†æ”¯ä¸­çš„æœªåˆå§‹åŒ–**ï¼š

```c++
int main(int argc, char* argv[]) {
    int value;
    
    if (argc > 1) {
        value = 10;  // åªåœ¨æ¡ä»¶ä¸ºçœŸæ—¶åˆå§‹åŒ–
    }
    
    return value;  // å¦‚æœargc <= 1ï¼Œvalueæœªåˆå§‹åŒ–
}
```

**è¾“å‡º:**

```bash
==32301==WARNING: MemorySanitizer: use-of-uninitialized-value
    #0 0x7f9df5c7c3f6 in main conditional_init.cpp:8:12
    #1 0x7f9df5a8a023 in __libc_start_main (...)
SUMMARY: MemorySanitizer: use-of-uninitialized-value conditional_init.cpp:8:12 in main
```

#### MSan çš„ç‰¹ç‚¹ï¼š
+ ä¸“æ³¨äºå•ä¸€ä»»åŠ¡ï¼šåªæ£€æµ‹æœªåˆå§‹åŒ–å†…å­˜ä½¿ç”¨
+ è¯¯æŠ¥ç‡ä½ï¼šå‡ ä¹æ²¡æœ‰å‡é˜³æ€§ç»“æœ
+ è¯¦ç»†çš„è°ƒç”¨æ ˆä¿¡æ¯ï¼šå‡†ç¡®å®šä½é—®é¢˜æºå¤´
+ æ£€æµ‹å¤æ‚ä¼ æ’­ï¼šè·Ÿè¸ªæœªåˆå§‹åŒ–å€¼å¦‚ä½•åœ¨ç¨‹åºä¸­æµåŠ¨

#### ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼š

**MSan éœ€è¦æ‰€æœ‰ä»£ç éƒ½å¼€å¯æ£€æµ‹**ï¼š

```bash
# ç¼–è¯‘ä½ çš„åº“æ—¶ä¹Ÿè¦åŠ ä¸Šè¿™äº›é€‰é¡¹
g++ -fsanitize=memory -fPIE -pie -g your_library.cpp -c
```

- ä¸ ASan ä¸èƒ½åŒæ—¶ä½¿ç”¨ï¼ˆéœ€åˆ†å¼€ç¼–è¯‘æ£€æµ‹ï¼‰
- ä¸»è¦ç”¨äº Linux/Clang ç¯å¢ƒï¼ŒGCC æ”¯æŒæœ‰é™

Memory Sanitizer æ˜¯æŸ¥æ‰¾é‚£äº›"å¹½çµèˆ¬"é—®é¢˜çš„åˆ©å™¨ â€” å½“ä½ çš„ç¨‹åºè¡Œä¸ºä¸ä¸€è‡´ï¼Œä¸”å…¶ä»–å·¥å…·æ‰¾ä¸å‡ºåŸå› æ—¶ï¼ŒMSan å¾ˆå¯èƒ½æ˜¯ä½ éœ€è¦çš„æ•‘æ˜Ÿï¼

### 6. heaptrack - ç°ä»£åŒ–çš„å†…å­˜åˆ†æå™¨
heaptrack å°±åƒä¸€ä½ç²¾æ˜çš„è´¢åŠ¡é¡¾é—®ï¼Œä¸ä»…å‘Šè¯‰ä½ "é’±å“ªé‡Œæ¼äº†"ï¼Œè¿˜èƒ½è¯¦ç»†åˆ†æ"é’±æ€ä¹ˆèŠ±çš„"ï¼å®ƒæ˜¯ä¸€ä¸ªå…¨æ–¹ä½çš„å†…å­˜åˆ†æå·¥å…·ï¼Œèƒ½å¤Ÿè¿½è¸ªæ‰€æœ‰å†…å­˜åˆ†é…ã€é‡Šæ”¾æƒ…å†µï¼Œå¹¶ç”Ÿæˆç›´è§‚çš„å¯è§†åŒ–æŠ¥å‘Šï¼Œè®©ä½ ä¸€çœ¼çœ‹æ¸…å†…å­˜ä½¿ç”¨çš„å…¨è²Œã€‚

#### å®‰è£…ä¸ä½¿ç”¨ï¼š
```bash
# å®‰è£…
sudo apt-get install heaptrack heaptrack-gui
# ç¼–è¯‘ç¨‹åº
g++ -g your_program.cpp -o your_program

# åŸºæœ¬ä½¿ç”¨
heaptrack ./your_program
# æˆ–è€…é™„åŠ åˆ°æ­£åœ¨è¿è¡Œçš„ç¨‹åº
heaptrack -p $(pidof your_program)

# åˆ†æç»“æœ
heaptrack_gui heaptrack.your_program.12345.gz
```

#### å®æˆ˜åœºæ™¯1ï¼šå†…å­˜æ³„æ¼æ£€æµ‹
```c++
#include <stdlib.h>
#include <unistd.h>

void leak_memory() {
    void* ptr = malloc(1024);
    // å¿˜è®°é‡Šæ”¾
}

int main() {
    for (int i = 0; i < 100; i++) {
        leak_memory();
        usleep(10000);  // çŸ­æš‚æš‚åœï¼Œä¾¿äºè§‚å¯Ÿ
    }
    return 0;
}
```

**è¿è¡Œç»“æœï¼š**

```bash
$ heaptrack ./memory_leak
heaptrack output will be written to "heaptrack.memory_leak.12345.gz"
starting application...
...
$ heaptrack_gui heaptrack.memory_leak.12345.gz
```

heaptrack_gui ä¼šæ‰“å¼€ä¸€ä¸ªå›¾å½¢ç•Œé¢ï¼Œæ˜¾ç¤ºï¼š

+ ç²¾ç¡®çš„å†…å­˜æ³„æ¼ä½ç½®å’Œæ•°é‡
+ éšæ—¶é—´å˜åŒ–çš„å†…å­˜ä½¿ç”¨å›¾è¡¨
+ å†…å­˜åˆ†é…è°ƒç”¨æ ˆå’Œçƒ­ç‚¹å‡½æ•°
+ å†…å­˜åˆ†é…å¤§å°åˆ†å¸ƒ

ä½ èƒ½æ¸…æ™°åœ°çœ‹åˆ° leak_memory() å‡½æ•°åœ¨ä¸æ–­åˆ†é…å†…å­˜ä½†ä»ä¸é‡Šæ”¾ï¼Œæ€»å†…å­˜ä½¿ç”¨é‡å‘ˆé˜¶æ¢¯çŠ¶ä¸Šå‡ï¼

#### å®æˆ˜åœºæ™¯2ï¼šå†…å­˜åˆ†é…çƒ­ç‚¹åˆ†æ
```c++
#include <stdlib.h>
#include <string.h>

void allocate_small() {
    for (int i = 0; i < 1000; i++) {
        char* buffer = (char*)malloc(64);
        memset(buffer, 0, 64);
        free(buffer);
    }
}

void allocate_large() {
    for (int i = 0; i < 10; i++) {
        char* buffer = (char*)malloc(1024 * 1024);
        memset(buffer, 0, 1024 * 1024);
        free(buffer);
    }
}

int main() {
    allocate_small();
    allocate_large();
    return 0;
}
```

**è¿è¡Œç»“æœï¼š**

```bash
$ heaptrack ./allocation_hotspots
heaptrack output will be written to "heaptrack.allocation_hotspots.12345.gz"
...
$ heaptrack_gui heaptrack.allocation_hotspots.12345.gz
```

heaptrack_gui ä¼šæ˜¾ç¤ºï¼š

+ allocate_small() å‡½æ•°æœ‰æœ€å¤šçš„åˆ†é…æ¬¡æ•°
+ allocate_large() å‡½æ•°æœ‰æœ€å¤§çš„å†…å­˜ååé‡
+ å®Œæ•´è°ƒç”¨æ ˆå’Œæ¯ä¸ªå‡½æ•°çš„åˆ†é…æƒ…å†µ
+ åˆ†é…çš„å…·ä½“å¤§å°åˆ†å¸ƒå›¾è¡¨

#### å®æˆ˜åœºæ™¯3ï¼šé™„åŠ åˆ°è¿è¡Œä¸­çš„è¿›ç¨‹
å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„æœåŠ¡å™¨ç¨‹åºï¼Œå®ƒåœ¨è¿è¡Œä¸€æ®µæ—¶é—´åå†…å­˜ä½¿ç”¨é‡å¼‚å¸¸å¢é•¿ï¼š

```c++
#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>

void slowly_leak() {
    static int iteration = 0;
    iteration++;
    
    // æ¯10æ¬¡è¿­ä»£æ³„æ¼ä¸€äº›å†…å­˜
    if (iteration % 10 == 0) {
        void* leak = malloc(1024 * 100);  // æ³„æ¼çº¦100KB
        printf("Iteration %d: Potential leak at %p\n", iteration, leak);
    }
    
    // æ­£å¸¸åˆ†é…å’Œé‡Šæ”¾çš„å†…å­˜
    void* normal = malloc(2048);
    free(normal);
    
    sleep(1);  // æ¯ç§’æ‰§è¡Œä¸€æ¬¡
}

int main() {
    printf("Server started with PID: %d\n", getpid());
    printf("Waiting for connections...\n");
    
    // æ¨¡æ‹ŸæœåŠ¡å™¨ä¸»å¾ªç¯
    while (1) {
        slowly_leak();
    }
    
    return 0;
}
```

**è¿è¡Œä¸åˆ†ææ­¥éª¤ï¼š**

**1ã€ç¼–è¯‘å¹¶å¯åŠ¨æœåŠ¡å™¨ç¨‹åº**ï¼š

```bash
$ g++ -g server.c -o server
$ ./server
Server started with PID: 23456
Waiting for connections...
Iteration 10: Potential leak at 0x55f7a83e12a0
Iteration 20: Potential leak at 0x55f7a83e1940
...
```

**2ã€åœ¨å¦ä¸€ä¸ªç»ˆç«¯çª—å£ï¼Œé™„åŠ  heaptrack åˆ°è¿è¡Œä¸­çš„è¿›ç¨‹**ï¼š

```bash
$ heaptrack -p 23456
heaptrack output will be written to "heaptrack.server.23456.12345.gz"
injecting into application via GDB, this might take some time...
injection finished
```

**3ã€è®©æœåŠ¡å™¨ç»§ç»­è¿è¡Œä¸€æ®µæ—¶é—´ï¼Œç„¶ååœ¨ heaptrack ç»ˆç«¯æŒ‰ Ctrl+C ç»“æŸè¿½è¸ª**
**4ã€åˆ†æç»“æœ**ï¼š

```bash
$ heaptrack_gui heaptrack.server.23456.12345.gz
```

#### heaptrack çš„ç‹¬ç‰¹ä¼˜åŠ¿ï¼š
**1ã€å®æ—¶åˆ†æ**ï¼šå¯ä»¥åœ¨ç¨‹åºè¿è¡Œæ—¶å®æ—¶æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ

```bash
heaptrack -o output_file ./your_program &
heaptrack_gui output_file
```
**2ã€æœ€å°åŒ–ç¨‹åºå¹²æ‰°**ï¼šæ¯” Valgrind æ›´è½»é‡ï¼Œå¯¹ç¨‹åºæ‰§è¡Œé€Ÿåº¦å½±å“å°

```bash
# heaptrackçš„æ€§èƒ½å¼€é”€é€šå¸¸ä¸º20-50%
# valgrindçš„æ€§èƒ½å¼€é”€é€šå¸¸ä¸º3-10å€
```

**3ã€ç›´è§‚å¯è§†åŒ–**ï¼šæä¾›äº¤äº’å¼å›¾å½¢ç•Œé¢

```bash
# æ”¯æŒå¤šç§è§†å›¾
# - æ—¶é—´çº¿è§†å›¾ï¼šæŸ¥çœ‹å†…å­˜ä½¿ç”¨éšæ—¶é—´å˜åŒ–
# - ç«ç„°å›¾ï¼šæŸ¥çœ‹å†…å­˜åˆ†é…è°ƒç”¨æ ˆ
# - çƒ­ç‚¹å‡½æ•°ï¼šæŸ¥çœ‹å†…å­˜åˆ†é…æœ€é¢‘ç¹çš„å‡½æ•°
```

**4ã€å‘½ä»¤è¡Œåˆ†æé€‰é¡¹**ï¼š

```bash
# ä¸ä½¿ç”¨GUIä¹Ÿå¯ä»¥æŸ¥çœ‹ç»“æœ
heaptrack_print heaptrack.your_program.12345.gz
```

heaptrack æ˜¯å†…å­˜åˆ†æå·¥å…·ä¸­çš„æ–°ç§€ï¼Œå®ƒç»“åˆäº†è¯¦ç»†çš„åˆ†æèƒ½åŠ›å’Œç°ä»£åŒ–çš„ç•Œé¢ï¼Œç‰¹åˆ«é€‚åˆéœ€è¦æ·±å…¥äº†è§£ç¨‹åºå†…å­˜ä½¿ç”¨æ¨¡å¼çš„å¼€å‘è€…ã€‚å®ƒä¸åªå‘Šè¯‰ä½ "æœ‰æ²¡æœ‰æ³„æ¼"ï¼Œè¿˜èƒ½å‘Šè¯‰ä½ "å†…å­˜éƒ½ç”¨åœ¨å“ªäº†"ï¼Œå¸®åŠ©ä½ ä¼˜åŒ–ç¨‹åºçš„æ•´ä½“å†…å­˜ä½¿ç”¨æ•ˆç‡ï¼

### 7. gperftools - Googleå‡ºå“çš„é«˜æ€§èƒ½å·¥å…·é›†
gperftools å°±åƒä¸€å¥—ä¸“ä¸šçš„ç¨‹åºæ€§èƒ½è¯Šç–—è®¾å¤‡ï¼Œç”± Google å¼€å‘ï¼ŒåŒ…å«äº†å†…å­˜åˆ†æã€CPU åˆ†æå’Œå †æ£€æŸ¥ç­‰å¤šç§å·¥å…·ã€‚å®ƒä»¥é«˜æ•ˆã€ä½å¼€é”€è‘—ç§°ï¼Œæ˜¯ Google å†…éƒ¨å¤§è§„æ¨¡ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–çš„ç§˜å¯†æ­¦å™¨ï¼Œå°¤å…¶æ˜¯å…¶ä¸­çš„ TCMalloc å†…å­˜åˆ†é…å™¨ï¼Œæ¯”æ ‡å‡†åº“çš„ malloc æ€§èƒ½æ›´å¼ºï¼

#### å®‰è£…ä¸ä½¿ç”¨ï¼š
```bash
# å®‰è£…
sudo apt-get install google-perftools libgoogle-perftools-dev

# ç¼–è¯‘ç¨‹åº
g++ -g your_program.cpp -o your_program

# åŸºæœ¬ä½¿ç”¨ï¼ˆå†…å­˜æ³„æ¼æ£€æµ‹ï¼‰
LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libtcmalloc.so HEAPCHECK=normal ./your_program

# CPU æ€§èƒ½åˆ†æ
LD_PRELOAD=/usr/lib/libprofiler.so CPUPROFILE=cpu.prof ./your_program
google-pprof --text ./your_program cpu.prof
```

#### å®æˆ˜åœºæ™¯1ï¼šå†…å­˜æ³„æ¼æ£€æµ‹
```c++
#include <stdlib.h>

void leaky_function() {
    int* data = new int[100];  // åˆ†é…ä½†ä¸é‡Šæ”¾
}

int main() {
    for (int i = 0; i < 10; i++) {
        leaky_function();
    }
    return 0;
}
```

**è¿è¡Œç»“æœï¼š**

```bash
$ g++ -g memory_leak.cpp -o memory_leak 
$ LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libtcmalloc.so HEAPCHECK=normal ./memory_leak

WARNING: Perftools heap leak checker is active -- Performance may suffer
Have memory regions w/o callers: might report false leaks
Leak check _main_ detected leaks of 4000 bytes in 10 objects
The 1 largest leaks:
Using local file ./memory_leak.
/usr/bin/addr2line: DWARF error: section .debug_info is larger than its filesize! (0x93f189 vs 0x530e70)
Leak of 4000 bytes in 10 objects allocated from:
	@ 55881f71719f leaky_function
	@ 55881f7171c4 main
	@ 7f99004e5083 __libc_start_main
	@ 55881f7170ce _start


... [more similar leaks] ...

If this is a false positive, try running with HEAP_CHECK_DRACONIAN.
```

gperftools çš„å †æ£€æŸ¥å™¨æ¸…æ™°åœ°æ ‡è¯†å‡ºäº†æ³„æ¼ä½ç½®å’Œå¤§å°ï¼ŒæŒ‰ç…§å¤§å°æ’åºå±•ç¤ºæœ€ä¸¥é‡çš„æ³„æ¼ï¼

#### å®æˆ˜åœºæ™¯2ï¼šé«˜æ€§èƒ½å†…å­˜åˆ†é…å™¨ TCMalloc
```c++
#include <stdlib.h>
#include <stdio.h>
#include <time.h>
#include <vector>
#include <thread>

void memory_task(int thread_id) {
    std::vector<void*> pointers;
    
    for (int i = 0; i < 1000000; i++) {
        size_t size = 8 + (i % 64) * 16;
        void* ptr = malloc(size);
        pointers.push_back(ptr);
        
        if (i % 7 == 0 && !pointers.empty()) {
            size_t index = i % pointers.size();
            free(pointers[index]);
            pointers[index] = NULL;
        }
    }
    
    // æ¸…ç†
    for (void* ptr : pointers) {
        if (ptr) free(ptr);
    }
}

int main() {
    clock_t start = clock();
    
    // åˆ›å»º8ä¸ªçº¿ç¨‹ï¼ŒåŒæ—¶è¿›è¡Œå†…å­˜å¯†é›†æ“ä½œ
    std::thread threads[8];
    for (int i = 0; i < 8; i++) {
        threads[i] = std::thread(memory_task, i);
    }
    
    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
    for (int i = 0; i < 8; i++) {
        threads[i].join();
    }
    
    clock_t end = clock();
    printf("Execution time: %f seconds\n", (double)(end - start) / CLOCKS_PER_SEC);
    
    return 0;
}
```

**è¿è¡Œç»“æœå¯¹æ¯”ï¼š**

```bash
# ä½¿ç”¨æ ‡å‡†åº“ malloc
$ g++ -g malloc_benchmark.cpp -o std_malloc
$ ./std_malloc
Execution time: 35.994701 seconds

# ä½¿ç”¨ TCMalloc
$ g++ -g malloc_benchmark.cpp -o tcmalloc_version -ltcmalloc
$ ./tcmalloc_version
Execution time: 8.005729 seconds
```

TCMalloc åœ¨è¿™ç§å¤šçº¿ç¨‹é¢‘ç¹åˆ†é…/é‡Šæ”¾åœºæ™¯ä¸‹ï¼Œæ€§èƒ½æå‡å¥½å‡ å€ï¼

#### å®æˆ˜åœºæ™¯3ï¼šCPU æ€§èƒ½åˆ†æ
```c++
#include <math.h>
#include <stdio.h>
#include <unistd.h>

void cpu_intensive_function1() {
    double result = 0;
    for (int i = 0; i < 1000000; i++) {
        result += sin(i) * cos(i);
    }
}

void cpu_intensive_function2() {
    double result = 0;
    for (int i = 0; i < 2000000; i++) {
        result += sqrt(i) * log(i+1);
    }
}

void mixed_function() {
    cpu_intensive_function1();
    sleep(1);  // IOç­‰å¾…
    cpu_intensive_function2();
}

int main() {
    mixed_function();
    return 0;
}
```

**è¿è¡Œä¸åˆ†æï¼š**

```bash
$ g++ -g cpu_profile.cpp -o cpu_profile
$ LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libprofiler.so CPUPROFILE=cpu.prof CPUPROFILE_FREQUENCY=1000 ./cpu_profile
$ google-pprof --text ./cpu_profile cpu.prof
Using local file cpu.prof.
/usr/bin/addr2line: DWARF error: section .debug_info is larger than its filesize! (0x17356f vs 0x13c5f8)
/usr/bin/addr2line: DWARF error: section .debug_info is larger than its filesize! (0x93f189 vs 0x530e70)
Total: 6 samples
       4  66.7%  66.7%        4  66.7% f64xsubf128
       1  16.7%  83.3%        3  50.0% cpu_intensive_function2
       1  16.7% 100.0%        1  16.7% logf64
       0   0.0% 100.0%        6 100.0% __libc_start_main
       0   0.0% 100.0%        6 100.0% _start
       0   0.0% 100.0%        3  50.0% cpu_intensive_function1
       0   0.0% 100.0%        6 100.0% main
       0   0.0% 100.0%        6 100.0% mixed_function
       0   0.0% 100.0%        1  16.7% std::cos
       0   0.0% 100.0%        2  33.3% std::log
       0   0.0% 100.0%        2  33.3% std::sin
```

```bash
$ google-pprof --web ./test cpu.prof
```

ç”Ÿæˆä¸€ä¸ªå¯è§†åŒ–çš„è°ƒç”¨å›¾ï¼Œæ¸…æ™°æ˜¾ç¤ºæ¯ä¸ªå‡½æ•°æ¶ˆè€—çš„ CPU æ—¶é—´æ¯”ä¾‹ï¼Œå¸®ä½ ç²¾ç¡®å®šä½æ€§èƒ½ç“¶é¢ˆï¼

#### gperftools çš„ç‹¬ç‰¹ä¼˜åŠ¿ï¼š
**1ã€TCMalloc - é«˜æ€§èƒ½å†…å­˜åˆ†é…å™¨**ï¼š

```bash
# ç®€å•ä½¿ç”¨
g++ your_program.cpp -o your_program -ltcmalloc

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨ç»Ÿè®¡
$ MALLOCSTATS=1 ./your_program
```

**2ã€ä½å¼€é”€çš„åˆ†æå·¥å…·**ï¼š

```bash
# æ¯” Valgrind ç­‰å·¥å…·çš„æ€§èƒ½å½±å“å°å¾—å¤š
# é€‚åˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨
```

**3ã€çµæ´»çš„å†…å­˜æ³„æ¼æ£€æµ‹çº§åˆ«**ï¼š

```bash
# ä¸åŒçº§åˆ«çš„æ£€æŸ¥
HEAPCHECK=minimal   # æœ€å¿«ï¼Œä»…æ£€æŸ¥æ˜æ˜¾æ³„æ¼
HEAPCHECK=normal    # å¹³è¡¡æ€§èƒ½å’Œæ£€æµ‹èƒ½åŠ›
HEAPCHECK=strict    # æ›´ä¸¥æ ¼çš„æ£€æŸ¥
HEAPCHECK=draconian # æœ€ä¸¥æ ¼çš„æ£€æŸ¥
```

**4ã€å¯ä¸å…¶ä»–å·¥å…·æ•´åˆ**ï¼š

```bash
# é…åˆ pprof å¯è§†åŒ–å·¥å…·ä½¿ç”¨
google-pprof --web ./your_program cpu.prof  # åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹
```

gperftools æ˜¯ä¸€å¥—å¼ºå¤§è€Œå…¨é¢çš„æ€§èƒ½å·¥å…·é›†ï¼Œç‰¹åˆ«é€‚åˆå¯¹æ€§èƒ½æœ‰ä¸¥æ ¼è¦æ±‚çš„å¤§å‹é¡¹ç›®ã€‚å®ƒä¸ä»…èƒ½å¸®ä½ æ‰¾å‡ºå†…å­˜é—®é¢˜ï¼Œè¿˜èƒ½å¸®ä½ ä¼˜åŒ–ç¨‹åºçš„æ•´ä½“æ€§èƒ½ï¼Œæ˜¯èµ„æ·±å¼€å‘è€…çš„å¿…å¤‡å·¥å…·ï¼

## ğŸ¯ å®ç”¨å»ºè®®
### é€‰æ‹©åˆé€‚çš„å·¥å…·ï¼š 
+ **åˆšå…¥é—¨ï¼Ÿ** ä»ç®€å•çš„å·¥å…·å¼€å§‹ï¼ˆWindowsä¸Šçš„VLDï¼ŒLinuxä¸Šçš„mtraceï¼‰
+ **å¤§å‹é¡¹ç›®ï¼Ÿ** é€‰æ‹©å…¨é¢çš„åˆ†æå·¥å…·ï¼ˆValgrindæˆ–Dr. Memoryï¼‰
+ **å¯¹æ€§èƒ½æ•æ„Ÿï¼Ÿ** ä½¿ç”¨ç¼–è¯‘å™¨é›†æˆå·¥å…·ï¼ˆAddressSanitizerï¼‰
+ **éœ€è¦åˆ†æå†…å­˜ä½¿ç”¨æ¨¡å¼ï¼Ÿ** å°è¯•heaptrackæˆ–gperftools

### å„å·¥å…·æ€§èƒ½å¯¹æ¯”ï¼š 
- **mtrace**ï¼šæ€§èƒ½å¼€é”€æå°ï¼ˆ<5%ï¼‰ï¼Œå‡ ä¹ä¸å½±å“ç¨‹åºè¿è¡Œé€Ÿåº¦ï¼Œä½†åŠŸèƒ½å±€é™äºåŸºæœ¬å†…å­˜æ³„æ¼æ£€æµ‹
- **Valgrind**ï¼šæ€§èƒ½å¼€é”€æœ€å¤§ï¼Œä½¿ç¨‹åºè¿è¡Œé€Ÿåº¦é™ä½10-30å€ï¼Œä½†æä¾›æœ€å…¨é¢çš„å†…å­˜é”™è¯¯æ£€æµ‹ï¼ˆæ³„æ¼ã€è¶Šç•Œã€æœªåˆå§‹åŒ–ç­‰ï¼‰
- **Dr. Memory**ï¼šä¸­é«˜æ€§èƒ½å¼€é”€ï¼Œä½¿ç¨‹åºè¿è¡Œé€Ÿåº¦é™ä½5-10å€ï¼Œæ£€æµ‹èƒ½åŠ›æ¥è¿‘Valgrindä½†æ›´è½»é‡
- **AddressSanitizer**ï¼šä¸­ç­‰æ€§èƒ½å¼€é”€ï¼Œä½¿ç¨‹åºè¿è¡Œé€Ÿåº¦é™ä½2-3å€ï¼Œæ£€æµ‹æ•ˆç‡é«˜ï¼Œé€‚åˆå¼€å‘é˜¶æ®µæ—¥å¸¸ä½¿ç”¨
- **Memory Sanitizer**ï¼šä¸AddressSanitizerç±»ä¼¼ï¼Œä½¿ç¨‹åºè¿è¡Œé€Ÿåº¦é™ä½2-3å€ï¼Œä¸“æ³¨äºæœªåˆå§‹åŒ–å†…å­˜æ£€æµ‹
- **heaptrack**ï¼šä¸­ç­‰æ€§èƒ½å¼€é”€ï¼Œä½¿ç¨‹åºè¿è¡Œé€Ÿåº¦é™ä½1.5-3å€ï¼Œæä¾›è¯¦ç»†çš„å†…å­˜åˆ†é…åˆ†æå’Œå¯è§†åŒ–
- **gperftools**ï¼šä½æ€§èƒ½å¼€é”€ï¼Œä½¿ç¨‹åºè¿è¡Œé€Ÿåº¦é™ä½1.2-2å€ï¼Œæä¾›è‰¯å¥½çš„å†…å­˜åˆ†æèƒ½åŠ›ï¼Œé€‚åˆæ€§èƒ½æ•æ„Ÿç¯å¢ƒ

### æ£€æµ‹ç­–ç•¥å»ºè®®ï¼š 
+ **å¼€å‘é˜¶æ®µ**ï¼šä½¿ç”¨è½»é‡çº§å·¥å…·ï¼ˆAddressSanitizer/VLDï¼‰è¿›è¡Œé¢‘ç¹æ£€æµ‹
+ **é›†æˆæµ‹è¯•**ï¼šä½¿ç”¨å…¨é¢å·¥å…·ï¼ˆValgrind/Dr. Memoryï¼‰è¿›è¡Œæ·±å…¥æ£€æµ‹
+ **ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨ä½å¼€é”€å·¥å…·ï¼ˆgperftoolsï¼‰æˆ–é‡‡æ ·åˆ†æ

### é˜²æ‚£äºæœªç„¶çš„ä»£ç å®è·µï¼š 
+ ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆï¼ˆ`std::unique_ptr`, `std::shared_ptr`ï¼‰
+ é‡‡ç”¨RAIIåŸåˆ™ï¼ˆèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰
+ å°½é‡é¿å…è£¸æŒ‡é’ˆå’Œæ‰‹åŠ¨å†…å­˜ç®¡ç†
+ ä½¿ç”¨æ ‡å‡†å®¹å™¨è€ŒéåŸå§‹æ•°ç»„

### é’ˆå¯¹æ€§æ£€æµ‹ï¼š 
+ **å†…å­˜æ³„æ¼**ï¼šValgrind, VLD, Dr. Memory
+ **ç¼“å†²åŒºæº¢å‡º**ï¼šAddressSanitizer
+ **æœªåˆå§‹åŒ–å†…å­˜**ï¼šMemory Sanitizer, Valgrind
+ **æ€§èƒ½ç“¶é¢ˆåˆ†æ**ï¼šgperftools, heaptrack

## ğŸŒŸ æ€»ç»“
å†…å­˜é—®é¢˜æ˜¯C++å¼€å‘ä¸­æœ€å¸¸è§ä¸”æœ€æ£˜æ‰‹çš„æŒ‘æˆ˜ä¹‹ä¸€ã€‚å¹¸è¿çš„æ˜¯ï¼Œç°ä»£å·¥å…·é“¾æä¾›äº†ä¸°å¯Œçš„è§£å†³æ–¹æ¡ˆï¼Œä»ç®€å•çš„å†…ç½®å·¥å…·åˆ°å¤æ‚çš„ä¸“ä¸šåˆ†æå™¨ï¼Œå‡ ä¹æ¶µç›–äº†æ‰€æœ‰å¯èƒ½çš„å†…å­˜é”™è¯¯ç±»å‹ã€‚

å¯¹äºåˆå­¦è€…ï¼Œå»ºè®®ä»ç®€å•çš„å·¥å…·å¼€å§‹ï¼Œå¦‚ Windows ä¸Šçš„ VLD æˆ– Linux ä¸Šçš„ mtraceï¼Œè¿™äº›å·¥å…·å®¹æ˜“ä¸Šæ‰‹ä¸”èƒ½æ»¡è¶³åŸºæœ¬éœ€æ±‚ã€‚éšç€ç»éªŒçš„ç§¯ç´¯ï¼Œå¯ä»¥é€æ¸å°è¯•æ›´ä¸“ä¸šçš„å·¥å…·å¦‚ Valgrind æˆ– AddressSanitizerï¼Œå®ƒä»¬èƒ½æä¾›æ›´å…¨é¢çš„åˆ†æå’Œæ›´å‡†ç¡®çš„è¯Šæ–­ã€‚

å…³é”®æ˜¯è¦å°†å†…å­˜æ£€æµ‹ä½œä¸ºå¼€å‘æµç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯äº‹åè¡¥æ•‘çš„æªæ–½ã€‚è‰¯å¥½çš„ç¼–ç ä¹ æƒ¯ã€åˆé€‚çš„å·¥å…·é€‰æ‹©ä»¥åŠæŒç»­çš„æ£€æµ‹ï¼Œæ˜¯é˜²æ­¢å†…å­˜é—®é¢˜çš„æœ€ä½³ç»„åˆã€‚

è®°ä½ï¼Œæœ€å¥½çš„ä¿®å¤æ˜¯é¢„é˜² â€”â€” é€šè¿‡ä½¿ç”¨ç°ä»£ C++ ç‰¹æ€§å¦‚æ™ºèƒ½æŒ‡é’ˆã€RAII å’Œæ ‡å‡†å®¹å™¨ï¼Œå¯ä»¥ä»æ ¹æœ¬ä¸Šå‡å°‘å†…å­˜ç®¡ç†é”™è¯¯çš„å¯èƒ½æ€§ã€‚è®©æˆ‘ä»¬æ‹¥æŠ±è¿™äº›å·¥å…·å’ŒæŠ€æœ¯ï¼Œå†™å‡ºæ›´å¥å£®ã€æ›´å¯é çš„C++ä»£ç ï¼

---

å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹ã€Œ**èµ**ã€ğŸ‘ã€ç‚¹ä¸ªã€Œ**åœ¨çœ‹**ã€ğŸ‘€ã€**è½¬å‘**ï¼Œè®©æ›´å¤šäººçœ‹åˆ°ï¼ä¹Ÿæ¬¢è¿å„ä½å°ä¼™ä¼´å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€Œ**è·Ÿç€å°åº·å­¦ç¼–ç¨‹**ã€ï¼Œè·å–æ›´å¤šç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜ç»éªŒã€‚

æˆ‘æ˜¯å°åº·ï¼Œä¸€ä¸ªçƒ­çˆ±åˆ†äº«çš„ç¨‹åºå‘˜ï¼Œæˆ‘ä»¬ä¸‹æœŸè§ï¼ğŸ’ª è®°å¾—å…³æ³¨å“¦ï¼Œè€é“ä»¬ ~

#### æ€ä¹ˆå…³æ³¨æˆ‘çš„å…¬ä¼—å·ï¼Ÿ

ç‚¹å‡»ä¸‹æ–¹å…¬ä¼—å·åç‰‡å³å¯å…³æ³¨ã€‚

![](https://files.mdnice.com/user/48364/65158d3c-cd38-4604-861a-8f0379066dc0.png)

å¦å¤–ï¼Œå°åº·è¿˜å»ºäº†ä¸€ä¸ªæŠ€æœ¯äº¤æµç¾¤ï¼Œä¸“é—¨èŠæŠ€æœ¯ã€ç­”ç–‘è§£æƒ‘ã€‚å¦‚æœä½ åœ¨è¯»æ–‡ç« æ—¶ç¢°åˆ°ä¸æ‡‚çš„åœ°æ–¹ï¼Œéšæ—¶æ¬¢è¿æ¥ç¾¤é‡Œæé—®ï¼æˆ‘ä¼šå°½åŠ›å¸®å¤§å®¶è§£ç­”ï¼Œç¾¤é‡Œè¿˜æœ‰ä¸å°‘æŠ€æœ¯å¤§ä½¬åœ¨çº¿æ”¯æ´ï¼Œå’±ä»¬ä¸€èµ·å­¦ä¹ è¿›æ­¥ï¼Œäº’ç›¸æˆé•¿ï¼

![](https://files.mdnice.com/user/48364/971ccaa3-8f57-4e33-8bc9-d0863eeade81.png)