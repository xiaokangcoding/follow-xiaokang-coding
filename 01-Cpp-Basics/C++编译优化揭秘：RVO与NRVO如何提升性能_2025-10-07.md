> ä½ æœ‰æ²¡æœ‰å¥½å¥‡è¿‡ï¼Œä¸ºä»€ä¹ˆæœ‰æ—¶å€™ C++ ä»£ç æ˜æ˜åº”è¯¥å¾ˆæ…¢ï¼Œå´è·‘å¾—é£å¿«ï¼Ÿä»Šå¤©å’±ä»¬å°±ä¸€èµ·æ¥æ‰’ä¸€æ‰’ç¼–è¯‘å™¨èƒŒåçš„é‚£äº›å°åŠ¨ä½œï¼

## å‰è¨€ï¼šç¼–è¯‘å™¨èƒŒåçš„"æš—ç®±æ“ä½œ"

å˜¿ï¼Œå¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°åº·ã€‚

å‰æ®µæ—¶é—´æˆ‘åœ¨è°ƒè¯•ä¸€æ®µä»£ç æ—¶ï¼Œå‘ç°äº†ä¸€ä¸ªæœ‰è¶£çš„ç°è±¡ï¼šæˆ‘å†™äº†ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒè¿”å›äº†ä¸€ä¸ªè¶…å¤§çš„å¯¹è±¡ï¼ˆå‡ Gé‚£ç§ï¼‰ï¼ŒæŒ‰ç†è¯´è¿™ç©æ„å¤åˆ¶ä¸€æ¬¡å¾—èŠ±ä¸å°‘æ—¶é—´ï¼Œå¯å®é™…è¿è¡Œèµ·æ¥å´å¿«å¾—å‡ºå¥‡ã€‚

å½“æ—¶æˆ‘å°±çº³é—·äº†ï¼šè¿™ä¸ç§‘å­¦å•Šï¼

ç›´åˆ°æˆ‘æ·±ç©¶äº†"RVO"å’Œ"NRVO"ï¼Œè¿™æ‰æç„¶å¤§æ‚Ÿã€‚åŸæ¥ç¼–è¯‘å™¨æ—©å°±å·å·å¸®æˆ‘ä»¬åšäº†ä¼˜åŒ–ï¼Œåªæ˜¯æˆ‘ä»¬ä¸çŸ¥é“è€Œå·²ï¼

ä»Šå¤©ï¼Œå°±è®©æˆ‘ä»¬ä¸€èµ·æ¥æ‰’ä¸€æ‰’è¿™äº›ç¼–è¯‘å™¨èƒŒåçš„å°åŠ¨ä½œï¼Œçœ‹çœ‹å®ƒä»¬æ˜¯å¦‚ä½•åœ¨ä½ ä¸ç»æ„é—´å°±å¸®ä½ çš„ä»£ç æé€Ÿçš„ã€‚ä¸ç®¡ä½ æ˜¯åˆšå…¥é—¨çš„å°ç™½ï¼Œè¿˜æ˜¯å·²ç»å†™äº†å‡ å¹´ä»£ç çš„è€é¸Ÿï¼Œç›¸ä¿¡éƒ½èƒ½ä»ä¸­æœ‰æ‰€æ”¶è·ã€‚

## ä¸€ã€ä»€ä¹ˆæ˜¯è¿”å›å€¼ä¼˜åŒ–(RVO)ï¼Ÿ

### å…ˆæ¥èŠèŠæ²¡æœ‰ä¼˜åŒ–æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ

æƒ³è±¡ä¸€ä¸‹è¿™ä¸ªåœºæ™¯ï¼šä½ å†™äº†ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒéœ€è¦è¿”å›ä¸€ä¸ªå¤§å¯¹è±¡ï¼Œæ¯”å¦‚è¯´è¿™æ ·ï¼š

```c++
class BigObject {
    // å‡è®¾è¿™ä¸ªç±»å¾ˆå¤§ï¼Œæœ‰ä¸€å¤§å †æ•°æ®
    char *data;
    // ...å…¶ä»–æˆå‘˜
public:
    BigObject() { 
        cout << "æ„é€ å‡½æ•°è¢«è°ƒç”¨" << endl; 
    }
    
    BigObject(const BigObject& other) { 
        cout << "å¤åˆ¶æ„é€ å‡½æ•°è¢«è°ƒç”¨" << endl; 
        // å¤åˆ¶æ•°æ®
    }
    
    ~BigObject() { 
        cout << "ææ„å‡½æ•°è¢«è°ƒç”¨" << endl; 
    }
};

BigObject createBigObject() {
    // ç›´æ¥è¿”å›ä¸€ä¸ªä¸´æ—¶å¯¹è±¡
    return BigObject(); // è¿”å›ä¸€ä¸ªæ— åä¸´æ—¶å¯¹è±¡
}

int main() {
    BigObject myObj = createBigObject(); // è°ƒç”¨å‡½æ•°å¹¶æ¥æ”¶è¿”å›å€¼
    // ä½¿ç”¨myObj...
    return 0;
}
```

æŒ‰ç…§ C++ çš„åŸºæœ¬è§„åˆ™ï¼Œè¿™æ®µä»£ç çš„æ‰§è¡Œè¿‡ç¨‹åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š

1ã€åœ¨`createBigObject()`å‡½æ•°å†…éƒ¨åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„`BigObject`å¯¹è±¡

2ã€å½“å‡½æ•°è¿”å›æ—¶ï¼ŒæŠŠè¿™ä¸ªä¸´æ—¶å¯¹è±¡å¤åˆ¶ä¸€ä»½åˆ°`main()`å‡½æ•°çš„`myObj`å˜é‡ä¸­

3ã€é”€æ¯å‡½æ•°å†…çš„ä¸´æ—¶å¯¹è±¡

æ‰€ä»¥æŒ‰é“ç†è¯´ï¼Œè¿™é‡Œè‡³å°‘ä¼šè°ƒç”¨ä¸€æ¬¡æ„é€ å‡½æ•°å’Œä¸€æ¬¡å¤åˆ¶æ„é€ å‡½æ•°ï¼Œå¯¹å§ï¼Ÿ

ä½†æ˜¯ï¼å¦‚æœä½ å®é™…è¿è¡Œè¿™æ®µä»£ç å¹¶æ‰“å°å‡ºæ„é€ å’Œå¤åˆ¶æ„é€ çš„è°ƒç”¨æƒ…å†µï¼Œä½ å¾ˆå¯èƒ½ä¼šæƒŠè®¶åœ°å‘ç°ï¼š**å¤åˆ¶æ„é€ å‡½æ•°æ ¹æœ¬æ²¡è¢«è°ƒç”¨ï¼**

è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™å°±æ˜¯ä»Šå¤©çš„ä¸»è§’â€”â€”**è¿”å›å€¼ä¼˜åŒ–**(Return Value Optimization, **RVO**)åœ¨é»˜é»˜å‘æŒ¥ä½œç”¨ã€‚

### RVOæ˜¯ä»€ä¹ˆé¬¼ï¼Ÿ
RVOï¼Œå…¨ç§° Return Value Optimizationï¼Œä¸­æ–‡å«"è¿”å›å€¼ä¼˜åŒ–"ï¼Œæ˜¯ä¸€ç§ç¼–è¯‘å™¨ä¼˜åŒ–æŠ€æœ¯ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒå¯ä»¥æ¶ˆé™¤å‡½æ•°è¿”å›æ—¶çš„å¯¹è±¡å¤åˆ¶æ“ä½œã€‚

å›åˆ°åˆšæ‰çš„ä¾‹å­ï¼Œä½¿ç”¨ RVO åï¼Œç¼–è¯‘å™¨ä¼šç›´æ¥åœ¨`main()`å‡½æ•°çš„`myObj`å˜é‡æ‰€åœ¨çš„å†…å­˜ä½ç½®ä¸Šæ„é€ å¯¹è±¡ï¼Œè€Œä¸æ˜¯å…ˆåœ¨`createBigObject()`å‡½æ•°å†…æ„é€ ï¼Œå†å¤åˆ¶å‡ºæ¥ã€‚è¿™æ ·å°±å®Œå…¨çœå»äº†å¤åˆ¶çš„å¼€é”€ï¼

æ˜¯ä¸æ˜¯å¾ˆç¥å¥‡ï¼Ÿæ˜æ˜æˆ‘ä»¬å†™çš„ä»£ç é€»è¾‘ä¸Šéœ€è¦å¤åˆ¶ï¼Œä½†ç¼–è¯‘å™¨å´å·å·å¸®æˆ‘ä»¬ä¼˜åŒ–æ‰äº†ã€‚è¿™ç§ä¼˜åŒ–åœ¨ C++11 æ ‡å‡†ä¸­è¢«ç§°ä¸º"å¤åˆ¶çœç•¥"(copy elision)ï¼Œæ˜¯å°‘æ•°å‡ ä¸ªå…è®¸ç¼–è¯‘å™¨æ”¹å˜ç¨‹åºå¯è§‚å¯Ÿè¡Œä¸ºçš„ä¼˜åŒ–ä¹‹ä¸€ã€‚

## äºŒã€NRVOï¼šRVOçš„è¿‘äº²å…„å¼Ÿ
è¯´å®Œäº†RVOï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å®ƒçš„"è¿‘äº²å…„å¼Ÿ"â€”â€”**NRVO**ã€‚

NRVO  å…¨ç§°æ˜¯ Named Return Value Optimizationï¼Œä¸­æ–‡å¯ä»¥å«åš"å…·åè¿”å›å€¼ä¼˜åŒ–"ã€‚è¿™åå­—å¬èµ·æ¥æœ‰ç‚¹ç»•ï¼Œä½†å…¶å®å¾ˆå¥½ç†è§£ï¼šå®ƒå°±æ˜¯é’ˆå¯¹æœ‰åå­—çš„å±€éƒ¨å˜é‡çš„è¿”å›å€¼ä¼˜åŒ–ã€‚

**çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­**ï¼š

```c++
BigObject createBigObject() {
    BigObject result; // åˆ›å»ºä¸€ä¸ªå…·åå¯¹è±¡
    // å¯¹resultåšä¸€äº›å¤„ç†...
    return result; // è¿”å›è¿™ä¸ªå…·åå¯¹è±¡
}
```

è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º`result`çš„å±€éƒ¨å˜é‡ï¼Œå¹¶åœ¨æœ€åè¿”å›å®ƒã€‚è¿™å°±æ˜¯ NRVO çš„åº”ç”¨åœºæ™¯ã€‚

ç›¸æ¯”ä¹‹ä¸‹ï¼Œæˆ‘ä»¬å‰é¢å·²ç»çœ‹åˆ°äº†RVOçš„ä¾‹å­ï¼Œå®ƒæ˜¯é’ˆå¯¹è¿”å›æ— åä¸´æ—¶å¯¹è±¡çš„ä¼˜åŒ–ï¼š

```c++
BigObject createBigObject() {
    // ç›´æ¥è¿”å›ä¸€ä¸ªä¸´æ—¶å¯¹è±¡
    return BigObject();
}
```

è™½ç„¶ä¸¤è€…æœ‰ç»†å¾®å·®åˆ«ï¼Œä½†ç›®çš„éƒ½æ˜¯ä¸€æ ·çš„ï¼š**é¿å…ä¸å¿…è¦çš„å¯¹è±¡å¤åˆ¶ï¼Œæé«˜ç¨‹åºæ€§èƒ½ã€‚**

## ä¸‰ã€æ·±å…¥ç†è§£ï¼šRVOå’ŒNRVOå¦‚ä½•å®ç°ï¼Ÿ

å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬çŸ¥é“äº† RVO å’Œ NRVO æ˜¯ä»€ä¹ˆï¼Œä½†å®ƒä»¬æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿç¼–è¯‘å™¨åˆ°åº•åœ¨èƒŒååšäº†ä»€ä¹ˆé­”æ³•ï¼Ÿè®©æˆ‘ä»¬æ­å¼€è°œåº•ï¼

### ç¼–è¯‘å™¨çš„å·§å¦™æŠŠæˆ
ä¼ ç»Ÿæƒ…å†µä¸‹ï¼Œå½“å‡½æ•°è¿”å›ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä¼šç»å†è¿™æ ·çš„è¿‡ç¨‹ï¼š

1ã€åœ¨å‡½æ•°å†…åˆ›å»ºä¸€ä¸ªå±€éƒ¨å¯¹è±¡

2ã€å¤åˆ¶è¿™ä¸ªå¯¹è±¡åˆ°è¿”å›å€¼ä½ç½®

3ã€é”€æ¯å‡½æ•°å†…çš„å±€éƒ¨å¯¹è±¡

ä½†ä½¿ç”¨ RVO/NRVO æ—¶ï¼Œç¼–è¯‘å™¨è€äº†ä¸ªèªæ˜çš„æŠŠæˆï¼š

1ã€åœ¨è°ƒç”¨è€…çš„æ ˆä¸Šç›´æ¥åˆ†é…è¿”å›å€¼çš„ç©ºé—´

2ã€å°†è¿™ä¸ªç©ºé—´çš„åœ°å€å·å·ä¼ ç»™è¢«è°ƒç”¨å‡½æ•°

3ã€è¢«è°ƒç”¨å‡½æ•°ç›´æ¥åœ¨è¿™ä¸ªåœ°å€ä¸Šæ„é€ å¯¹è±¡

å°±è¿™ä¹ˆç®€å•ï¼æ²¡æœ‰å¤åˆ¶ï¼Œæ²¡æœ‰ç§»åŠ¨ï¼Œå¯¹è±¡ç›´æ¥åœ¨å®ƒæœ€ç»ˆåº”è¯¥åœ¨çš„ä½ç½®ä¸Šè¯ç”Ÿã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹è¿™åœ¨æ±‡ç¼–ä»£ç ä¸­æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œä»¥æˆ‘ä»¬å‰é¢çš„RVOä¾‹å­ä¸ºä¾‹ï¼š

```c++
BigObject createBigObject() {
    return BigObject(); // è¿”å›ä¸€ä¸ªæ— åä¸´æ—¶å¯¹è±¡
}

int main() {
    BigObject myObj = createBigObject();
    return 0;
}
```

è®©æˆ‘ä»¬æ¥å¯¹æ¯”ä¸€ä¸‹å¼€å¯ RVO å’Œæœªå¼€å¯ RVO æ—¶çš„æ±‡ç¼–ä»£ç å·®å¼‚ï¼Œè¿™æ ·å¯¹æ¯”ä¼šæ›´æœ‰è¯´æœåŠ›ã€‚

**æœªå¼€å¯RVOä¼˜åŒ–æ—¶**ï¼ˆä½¿ç”¨ç±»ä¼¼`-O0 -fno-elide-constructors`çš„ç¼–è¯‘é€‰é¡¹ï¼‰ï¼š

```assembly
createBigObject:
    ; rdiåŒ…å«è¿”å›å€¼çš„åœ°å€
    
    ; åœ¨è¿”å›åœ°å€æ„é€ BigObject
    call BigObject::BigObject()  ; è°ƒç”¨æ„é€ å‡½æ•°
    ret                           ; è¿”å›
    
main:
    ; ä¸ºmyObjåˆ†é…ç©ºé—´
    sub rsp, 40000        ; å‡è®¾BigObjectå ç”¨40000å­—èŠ‚
    
    ; ä¸ºä¸´æ—¶è¿”å›å€¼åˆ†é…ç©ºé—´
    sub rsp, 40000        ; å†åˆ†é…ä¸€å—ç©ºé—´å­˜å‚¨å‡½æ•°è¿”å›å€¼
    
    ; è°ƒç”¨createBigObject
    lea rdi, [rsp]        ; ä¼ é€’ä¸´æ—¶è¿”å›å€¼çš„åœ°å€
    call createBigObject
    
    ; ç°åœ¨éœ€è¦æŠŠä¸´æ—¶è¿”å›å€¼å¤åˆ¶åˆ°myObj
    lea rdi, [rsp+40000]  ; ç›®æ ‡åœ°å€(myObj)
    lea rsi, [rsp]        ; æºåœ°å€(ä¸´æ—¶è¿”å›å€¼)
    call BigObject::BigObject(BigObject const&)  ; è°ƒç”¨å¤åˆ¶æ„é€ å‡½æ•°
    
    ; é‡Šæ”¾ä¸´æ—¶è¿”å›å€¼
    lea rdi, [rsp]
    call BigObject::~BigObject  ; è°ƒç”¨ä¸´æ—¶å¯¹è±¡çš„ææ„å‡½æ•°
    
    add rsp, 40000        ; é‡Šæ”¾ä¸´æ—¶è¿”å›å€¼çš„ç©ºé—´
    add rsp, 40000        ; é‡Šæ”¾myObjçš„ç©ºé—´
    xor eax, eax          ; è¿”å›0
    ret
```

**å¼€å¯RVOä¼˜åŒ–æ—¶**ï¼ˆä½¿ç”¨ç±»ä¼¼`-O2`çš„ç¼–è¯‘é€‰é¡¹ï¼‰ï¼š

```assembly
createBigObject:
    ; rdiä¸­å·²ç»åŒ…å«äº†ç›®æ ‡å¯¹è±¡çš„åœ°å€
    
    ; ç›´æ¥åœ¨ç›®æ ‡åœ°å€ä¸Šæ„é€ BigObject
    mov QWORD PTR [rdi], 0    ; åˆå§‹åŒ–éƒ¨åˆ†æ•°æ®
    mov QWORD PTR [rdi+8], 0  ; åˆå§‹åŒ–æ›´å¤šæ•°æ®
    ; ...æ›´å¤šåˆå§‹åŒ–ä»£ç ...
    
    ; è¿”å›ï¼ˆå¯¹è±¡å·²ç»æ„é€ åœ¨è°ƒç”¨è€…æä¾›çš„å†…å­˜ä¸­ï¼‰
    ret
    
main:
    ; ä¸ºmyObjåˆ†é…ç©ºé—´
    sub rsp, 40000        ; å‡è®¾BigObjectå ç”¨40000å­—èŠ‚
    
    ; è°ƒç”¨createBigObjectï¼Œå¹¶ä¼ é€’myObjçš„åœ°å€ä½œä¸ºéšè—å‚æ•°
    lea rdi, [rsp]        ; å°†myObjçš„åœ°å€åŠ è½½åˆ°rdiå¯„å­˜å™¨ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°ï¼‰
    call createBigObject
    
    ; myObjå·²ç»æ„é€ å¥½äº†ï¼Œæ¸…ç†å¹¶è¿”å›
    add rsp, 40000
    xor eax, eax          ; è¿”å›0
    ret
```

çœ‹ä¸€çœ¼è¿™ä¸¤æ®µæ±‡ç¼–ä»£ç ï¼Œå·®å¼‚æ˜¾è€Œæ˜“è§ã€‚æœªä¼˜åŒ–çš„ç‰ˆæœ¬æ˜æ˜¾æ›´å¤æ‚ï¼šå®ƒè¦åˆ†é…ä¸¤å—å†…å­˜ç©ºé—´ï¼Œè€Œä¸æ˜¯ä¸€å—ï¼›å®ƒè°ƒç”¨äº†æ„é€ å‡½æ•°ï¼Œç„¶ååˆè°ƒç”¨å¤åˆ¶æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ï¼›å®ƒéœ€è¦è¿›è¡Œå†…å­˜å¤åˆ¶ï¼Œè¿˜æœ‰æ›´å¤šçš„æ ˆæ“ä½œã€‚

ç›¸æ¯”ä¹‹ä¸‹ï¼ŒRVOä¼˜åŒ–ç‰ˆæœ¬ç®€æ´æ˜äº†ï¼šåªåˆ†é…ä¸€å—å†…å­˜ç©ºé—´ï¼Œåªè°ƒç”¨ä¸€æ¬¡æ„é€ å‡½æ•°ï¼Œæ²¡æœ‰å¤åˆ¶ï¼Œæ²¡æœ‰ææ„ï¼Œä¹Ÿæ²¡æœ‰é¢å¤–çš„æ ˆæ“ä½œã€‚å¯¹äºå¤§å¯¹è±¡æ¥è¯´ï¼Œè¿™ç§å·®å¼‚å¸¦æ¥çš„æ€§èƒ½æå‡æ˜¯ç›¸å½“å¯è§‚çš„ï¼

### NRVOä¸RVOæœ‰ä½•ä¸åŒï¼Ÿ

é‚£ NRVO å‘¢ï¼Ÿå®ƒä¸ RVO åœ¨å®ç°ä¸Šæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

åœ¨ RVO ä¸­ï¼Œç¼–è¯‘å™¨ä¸€çœ‹åˆ°`return BigObject()`å°±çŸ¥é“è¿™æ˜¯ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œç›´æ¥åœ¨ç›®æ ‡ä½ç½®æ„é€ å®ƒå¾ˆå®¹æ˜“ã€‚

è€Œ NRVO è¦å¤æ‚ä¸€äº›ã€‚å½“ç¼–è¯‘å™¨çœ‹åˆ°`BigObject obj;`æ—¶ï¼Œå®ƒä¸ç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯å¦åªç”¨äºè¿”å›ã€‚åªæœ‰åˆ†ææ•´ä¸ªå‡½æ•°åï¼Œç¡®è®¤ obj æ²¡æœ‰è¢«å¤šæ¬¡ä¿®æ”¹æˆ–ä»¥å¤æ‚æ–¹å¼ä½¿ç”¨ï¼Œæ‰èƒ½å°†å®ƒç›´æ¥æ„é€ åœ¨è¿”å›ä½ç½®ã€‚

**ä¸¾ä¸ªä¾‹å­**ï¼š

```c++
BigObject createComplex(bool condition) {
    BigObject obj1;
    BigObject obj2;
    // ...
    if (condition) {
        obj1 = obj2;  // obj1è¢«ä¿®æ”¹äº†ï¼
        return obj1;
    }
    return obj2;
}
```

è¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨å¯èƒ½æ— æ³•åº”ç”¨NRVOï¼Œå› ä¸ºï¼š

+ å¯èƒ½è¿”å›ä¸åŒçš„å¯¹è±¡ï¼ˆobj1æˆ–obj2ï¼‰
+ å¯¹è±¡åœ¨è¿”å›å‰è¢«ä¿®æ”¹äº†
+ å‡½æ•°é€»è¾‘ä¾èµ–è¿è¡Œæ—¶æ¡ä»¶

**ç®€å•æ¥è¯´**ï¼š

+ RVOï¼šç›´æ¥æ˜äº†ï¼Œå®¹æ˜“å®ç°ï¼Œä¼˜åŒ–æˆåŠŸç‡é«˜
+ NRVOï¼šéœ€è¦æ›´å…¨é¢çš„ä»£ç åˆ†æï¼Œå®ç°æ›´å¤æ‚

è™½ç„¶åŸç†æœ‰å·®å¼‚ï¼Œä½†æˆåŠŸåº”ç”¨åçš„æ•ˆæœæ˜¯ç›¸åŒçš„ï¼š**å¯¹è±¡éƒ½ç›´æ¥åœ¨æœ€ç»ˆä½ç½®ä¸Šæ„é€ ï¼Œå®Œå…¨é¿å…äº†å¤åˆ¶ã€‚**

### æ¥çœ‹ä¸ªå®é™…ä¾‹å­

è®©æˆ‘ä»¬ç”¨å®é™…ä»£ç æ¥éªŒè¯ä¸€ä¸‹ RVO å’Œ NRVO çš„æ•ˆæœï¼š

```c++
#include <iostream>
#include <chrono>
using namespace std;
using namespace std::chrono;

class BigObject {
private:
    int* data; // æŒ‡é’ˆï¼Œè€Œä¸æ˜¯æ•°ç»„
public:
    BigObject() {
        data = new int[1000000]; // åœ¨å †ä¸Šåˆ†é…
        for (int i = 0; i < 1000000; i++) {
            data[i] = i;
        }
        cout << "æ„é€ å‡½æ•°è¢«è°ƒç”¨" << endl;
    }

    BigObject(const BigObject& other) {
        data = new int[1000000]; // åœ¨å †ä¸Šåˆ†é…
        for (int i = 0; i < 1000000; i++) {
            data[i] = other.data[i];
        }
        cout << "å¤åˆ¶æ„é€ å‡½æ•°è¢«è°ƒç”¨" << endl;
    }

    ~BigObject() {
        delete[] data; // è®°å¾—é‡Šæ”¾å†…å­˜
    }
};

// RVOç¤ºä¾‹
BigObject createWithRVO() {
    return BigObject(); // è¿”å›ä¸´æ—¶å¯¹è±¡
}
// NRVOç¤ºä¾‹
BigObject createWithNRVO() {
    BigObject obj;
    return obj; // è¿”å›å…·åå¯¹è±¡
}

int main() {
    // æµ‹è¯•RVO
    auto start = high_resolution_clock::now();
    BigObject obj1 = createWithRVO();
    auto end = high_resolution_clock::now();
    cout << "RVOè€—æ—¶: " << duration_cast<microseconds>(end - start).count() << "us" << endl;

    // æµ‹è¯•NRVO
    start = high_resolution_clock::now();
    BigObject obj2 = createWithNRVO();
    end = high_resolution_clock::now();
    cout << "NRVOè€—æ—¶: " << duration_cast<microseconds>(end - start).count() << "us" << endl;

    return 0;
}

```

è¿è¡Œè¿™æ®µä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°æ˜æ˜¾ä¸åŒçš„ç»“æœï¼Œè¿™å–å†³äºç¼–è¯‘å™¨æ˜¯å¦å¯ç”¨äº† RVO/NRVO ä¼˜åŒ–ã€‚

**ç¦ç”¨RVOä¼˜åŒ–æ—¶**ï¼ˆä½¿ç”¨ç¼–è¯‘é€‰é¡¹ï¼š`g++ -fno-elide-constructors -o run test.cpp -std=c++11`ï¼‰ï¼š

```text
æ„é€ å‡½æ•°è¢«è°ƒç”¨
å¤åˆ¶æ„é€ å‡½æ•°è¢«è°ƒç”¨
å¤åˆ¶æ„é€ å‡½æ•°è¢«è°ƒç”¨
RVOè€—æ—¶: 14428us
æ„é€ å‡½æ•°è¢«è°ƒç”¨
å¤åˆ¶æ„é€ å‡½æ•°è¢«è°ƒç”¨
å¤åˆ¶æ„é€ å‡½æ•°è¢«è°ƒç”¨
NRVOè€—æ—¶: 9674us
```

**å¯ç”¨RVOä¼˜åŒ–æ—¶**ï¼ˆé»˜è®¤é€‰é¡¹ï¼š`g++ -o run test.cpp -std=c++11`ï¼‰ï¼š

```text
æ„é€ å‡½æ•°è¢«è°ƒç”¨
RVOè€—æ—¶: 4413us
æ„é€ å‡½æ•°è¢«è°ƒç”¨
NRVOè€—æ—¶: 4424us
```

çœ‹åˆ°æ²¡ï¼Ÿå·®åˆ«è›®å¤§ï¼

+ **ç¦ç”¨ä¼˜åŒ–æ—¶**ï¼Œæ¯ä¸ªå‡½æ•°è°ƒç”¨éƒ½è¦å¤åˆ¶ä¸¤æ¬¡å¯¹è±¡ï¼Œè€—æ—¶æŒºé•¿ã€‚
+ **å¯ç”¨ä¼˜åŒ–å**ï¼Œå¤åˆ¶æ„é€ å‡½æ•°ç›´æ¥æ¶ˆå¤±äº†ï¼åªéœ€æ„é€ ä¸€æ¬¡å¯¹è±¡ï¼Œé€Ÿåº¦æ•´æ•´å¿«äº†2-3å€å¤šã€‚

å³ä½¿æ˜¯åœ¨ç¦ç”¨ä¼˜åŒ–æ—¶ï¼Œä½ å¯èƒ½æ³¨æ„åˆ° NRVO æ¯” RVO ç¨å¿« â€”â€” è¿™å¯èƒ½åªæ˜¯æµ‹è¯•è¯¯å·®ï¼Œä½†ç¡®å®æœ‰è¶£ã€‚ä¸è¿‡é‡ç‚¹æ˜¯ï¼šå¼€å¯ä¼˜åŒ–åï¼Œä¸¤è€…æ€§èƒ½åŸºæœ¬ä¸€è‡´ï¼Œå®Œå…¨ç¬¦åˆæˆ‘ä»¬çš„ç†è®ºåˆ†æã€‚

è¿™å°±æ˜¯ RVO å’Œ NRVO çš„å¨åŠ›ï¼å®ƒä»¬ä¸æ˜¯é­”æ³•ï¼Œè€Œæ˜¯å®å®åœ¨åœ¨çš„æ€§èƒ½æå‡ï¼Œç‰¹åˆ«æ˜¯å½“ä½ çš„å‡½æ•°éœ€è¦è¿”å›å¤§å¯¹è±¡æ—¶ã€‚

## å››ã€ä»€ä¹ˆæ—¶å€™ä¼šå¤±æ•ˆï¼ŸRVO å’Œ NRVO çš„é™åˆ¶æ¡ä»¶

å‰é¢æˆ‘ä»¬äº†è§£äº† RVO å’Œ NRVO è¿™ä¸¤ä¸ªå¼ºå¤§çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œä½†å®ƒä»¬ä¹Ÿä¸æ˜¯ä¸‡èƒ½çš„ã€‚ä»€ä¹ˆæƒ…å†µä¸‹è¿™äº›ä¼˜åŒ–ä¼šå¤±æ•ˆå‘¢ï¼Ÿè®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹å‡ ç§å¸¸è§æƒ…å†µã€‚

### 1. å¤šä¸ªè¿”å›è¯­å¥æŒ‡å‘ä¸åŒå¯¹è±¡
å½“å‡½æ•°é‡Œæœ‰å¤šä¸ªè¿”å›è¯­å¥ï¼Œå¹¶ä¸”è¿”å›çš„æ˜¯ä¸åŒçš„å¯¹è±¡æ—¶ï¼Œç¼–è¯‘å™¨å°±æ— æ³•ç¡®å®šåº”è¯¥ä¸ºå“ªä¸ªå¯¹è±¡åº”ç”¨ä¼˜åŒ–ï¼š

```c++
BigObject createObject(bool condition) {
    BigObject obj1;
    BigObject obj2;
    
    if (condition) {
        return obj1;  // è¿”å›ç¬¬ä¸€ä¸ªå¯¹è±¡
    } else {
        return obj2;  // è¿”å›ç¬¬äºŒä¸ªå¯¹è±¡
    }
}
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨é€šå¸¸æ— æ³•åº”ç”¨NRVOï¼Œå› ä¸ºå®ƒä¸èƒ½ç¡®å®šæ˜¯`obj1`è¿˜æ˜¯`obj2`ä¼šè¢«è¿”å›ã€‚è¿™å®Œå…¨å–å†³äºè¿è¡Œæ—¶çš„`condition`å€¼ã€‚

### 2. è¿”å›çš„å¯¹è±¡æ˜¯å‡½æ•°å‚æ•°
å¦‚æœå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªå‚æ•°ï¼Œç¼–è¯‘å™¨é€šå¸¸æ— æ³•åº”ç”¨RVOï¼š

```c++
BigObject returnParameter(BigObject param) {
    return param;  // è¿”å›çš„æ˜¯å‡½æ•°å‚æ•°
}
```

è¿™é‡Œçš„`param`å·²ç»åœ¨è°ƒç”¨è€…é‚£é‡Œæ„é€ å¥½äº†ï¼Œå‡½æ•°åªæ˜¯è¿”å›äº†å®ƒçš„ä¸€ä¸ªå‰¯æœ¬ã€‚ç¼–è¯‘å™¨æ— æ³•åœ¨è°ƒç”¨è€…çš„æ ˆä¸Š"é¢„å…ˆ"æ„é€ è¿™ä¸ªå¯¹è±¡ï¼Œå› ä¸ºå®ƒå·²ç»å­˜åœ¨äº†ã€‚

### 3. è¿”å›çš„æ˜¯ç±»æˆå‘˜å˜é‡
å½“å‡½æ•°è¿”å›ç±»çš„æˆå‘˜å˜é‡æ—¶ï¼Œè¿™ä¸ªå˜é‡å·²ç»ä½œä¸ºå¯¹è±¡çš„ä¸€éƒ¨åˆ†å­˜åœ¨äº†ï¼Œç¼–è¯‘å™¨é€šå¸¸ä¹Ÿæ— æ³•åº”ç”¨RVOï¼š

```c++
class Container {
    BigObject member;
public:
    BigObject getMember() {
        return member;  // è¿”å›çš„æ˜¯ç±»æˆå‘˜å˜é‡
    }
};
```

å› ä¸º`member`çš„ç”Ÿå‘½å‘¨æœŸä¸å‡½æ•°è°ƒç”¨æ— å…³ï¼ˆå®ƒæ˜¯`Container`å¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼‰ï¼Œç¼–è¯‘å™¨æ— æ³•å°†å®ƒç›´æ¥æ„é€ åœ¨è¿”å›å€¼ä½ç½®ã€‚

### 4. å¤æ‚æ§åˆ¶æµ
å½“å‡½æ•°ä¸­æœ‰å¤æ‚çš„æ§åˆ¶æµï¼ˆå¦‚å¤šå±‚åµŒå¥—çš„æ¡ä»¶è¯­å¥ã€å¾ªç¯ã€å¼‚å¸¸å¤„ç†ç­‰ï¼‰æ—¶ï¼Œç¼–è¯‘å™¨å¯èƒ½éš¾ä»¥åˆ†æå¹¶åº”ç”¨RVO/NRVOï¼š

```c++
BigObject complexFunction() {
    BigObject obj;
    try {
        // ä¸€äº›å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„ä»£ç 
        if (someCondition) {
            throw SomeException();
        }
    } catch (...) {
        return obj;  // åœ¨å¼‚å¸¸å¤„ç†ä¸­è¿”å›
    }
    // æ›´å¤šå¤æ‚æ§åˆ¶æµ...
    return obj;
}
```

å¤æ‚çš„æ§åˆ¶æµä¼šä½¿ç¼–è¯‘å™¨éš¾ä»¥ç¡®å®šè¿”å›è·¯å¾„å’Œè¿”å›å¯¹è±¡çš„æƒ…å†µï¼Œä»è€Œå½±å“ä¼˜åŒ–ã€‚

### å¦‚ä½•ç¡®è®¤ä¼˜åŒ–æ˜¯å¦ç”Ÿæ•ˆï¼Ÿ
æƒ³çŸ¥é“ä½ çš„ä»£ç æ˜¯å¦è§¦å‘äº† RVO/NRVO ä¼˜åŒ–ï¼Ÿæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯æ·»åŠ æ‰“å°è¯­å¥åˆ°æ„é€ å‡½æ•°å’Œå¤åˆ¶æ„é€ å‡½æ•°ä¸­ï¼Œç„¶åè¿è¡Œçœ‹çœ‹ï¼š

```c++
class Tracer {
public:
    Tracer() { cout << "æ„é€ å‡½æ•°" << endl; }
    Tracer(const Tracer&) { cout << "å¤åˆ¶æ„é€ å‡½æ•°" << endl; }
    ~Tracer() { cout << "ææ„å‡½æ•°" << endl; }
};

Tracer getTracer() {
    return Tracer();
}

int main() {
    Tracer t = getTracer();
    return 0;
}
```

å¦‚æœåªçœ‹åˆ°"æ„é€ å‡½æ•°"å’Œ"ææ„å‡½æ•°"çš„è¾“å‡ºï¼Œæ²¡æœ‰çœ‹åˆ°"å¤åˆ¶æ„é€ å‡½æ•°"ï¼Œé‚£ä¹ˆRVOå°±æˆåŠŸäº†ï¼

### å°è´´å£«ï¼šå¦‚ä½•æé«˜ä¼˜åŒ–æˆåŠŸç‡ï¼Ÿ
1. **å°½é‡è¿”å›ä¸´æ—¶å¯¹è±¡**ï¼ˆRVO æ¯” NRVO æ›´å®¹æ˜“è¢«åº”ç”¨ï¼‰
2. **ä¸€ä¸ªå‡½æ•°åªè¿”å›ä¸€ä¸ªå¯¹è±¡**ï¼ˆé¿å…å¤šä¸ªè¿”å›è¯­å¥è¿”å›ä¸åŒå¯¹è±¡ï¼‰

è®°ä½è¿™äº›å°æŠ€å·§ï¼Œä½ çš„ä»£ç å°±èƒ½æ›´å¥½åœ°åˆ©ç”¨è¿™äº›å¼ºå¤§çš„ä¼˜åŒ–åŠŸèƒ½äº†ï¼

## äº”ã€C++17ï¼šå¼ºåˆ¶çš„å¤åˆ¶çœç•¥

å‰é¢æˆ‘ä»¬è®²äº†è¿™ä¹ˆå¤š RVO å’Œ NRVO çš„å¥½å¤„ï¼Œä½†ä½ çŸ¥é“å—ï¼Ÿåœ¨ C++17 ä¹‹å‰ï¼Œè¿™äº›ä¼˜åŒ–å…¶å®åªæ˜¯ç¼–è¯‘å™¨çš„"å¥½å¿ƒ"ï¼Œå¹¶ä¸æ˜¯è¯­è¨€æ ‡å‡†è¦æ±‚å¿…é¡»åšçš„äº‹æƒ…ï¼

### ä»"å¯é€‰"åˆ°"å¿…é€‰"
åœ¨ C++17 ä¹‹å‰ï¼Œç¼–è¯‘å™¨å¯ä»¥é€‰æ‹©æ˜¯å¦åº”ç”¨ RVO å’Œ NRVO ä¼˜åŒ–ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿ä½ çš„ä»£ç å†™å¾—å†å®Œç¾ï¼Œæ»¡è¶³äº†æ‰€æœ‰ä¼˜åŒ–æ¡ä»¶ï¼Œç¼–è¯‘å™¨ä¹Ÿå¯ä»¥è¯´ï¼š"ä¸ï¼Œæˆ‘å°±æ˜¯ä¸æƒ³ä¼˜åŒ–ã€‚"å½“ç„¶ï¼Œå®é™…ä¸Šå¤§å¤šæ•°ç¼–è¯‘å™¨éƒ½ä¼šå°½å¯èƒ½åœ°è¿›è¡Œè¿™äº›ä¼˜åŒ–ï¼Œå› ä¸ºå®ƒä»¬ç¡®å®èƒ½å¸¦æ¥å¾ˆå¤§çš„æ€§èƒ½æå‡ã€‚

ä½†ä» C++17 å¼€å§‹ï¼Œå¯¹äº RVO è¿™ç§æƒ…å†µï¼ˆå³è¿”å›ä¸´æ—¶å¯¹è±¡ï¼‰ï¼Œæ ‡å‡†æ˜ç¡®è¦æ±‚ **ç¼–è¯‘å™¨å¿…é¡»çœç•¥å¤åˆ¶/ç§»åŠ¨æ“ä½œ**ã€‚è¿™å°±æ˜¯æ‰€è°“çš„"å¼ºåˆ¶çš„å¤åˆ¶çœç•¥"ï¼ˆmandatory copy elisionï¼‰ã€‚

### è¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿ

ç”¨å¤§ç™½è¯è¯´ï¼Œå°±æ˜¯ C++17 æŠŠ"æƒ…åˆ†"å˜æˆäº†"æœ¬åˆ†"ã€‚ç¼–è¯‘å™¨ä¸å†èƒ½å·æ‡’ï¼Œå¿…é¡»ä¸ºä¸´æ—¶å¯¹è±¡çš„è¿”å›åšä¼˜åŒ–ã€‚

æœ€æœ‰è¶£çš„å˜åŒ–æ˜¯ï¼Œä»¥ä¸‹ä»£ç åœ¨ C++17 ä¹‹å‰å¯èƒ½æ— æ³•ç¼–è¯‘ï¼Œä½†åœ¨ C++17 ä¸­ä¸€å®šèƒ½ç¼–è¯‘å¹¶æ­£å¸¸å·¥ä½œï¼š

```c++
class NonCopyable {
public:
    NonCopyable() = default;
    // ç¦æ­¢å¤åˆ¶
    NonCopyable(const NonCopyable&) = delete;
    NonCopyable& operator=(const NonCopyable&) = delete;
    // ç¦æ­¢ç§»åŠ¨
    NonCopyable(NonCopyable&&) = delete;
    NonCopyable& operator=(NonCopyable&&) = delete;
};

NonCopyable createNonCopyable() {
    return NonCopyable(); // C++17å‰å¯èƒ½æŠ¥é”™ï¼ŒC++17ä¸€å®šæ²¡é—®é¢˜
}

int main() {
    NonCopyable obj = createNonCopyable(); // åŒä¸Š
    return 0;
}
```

è¿™æ®µä»£ç çœ‹èµ·æ¥å¾ˆçŸ›ç›¾ï¼šæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ—¢ä¸èƒ½å¤åˆ¶ä¹Ÿä¸èƒ½ç§»åŠ¨çš„ç±»ï¼Œç„¶åå´è¯•å›¾è¿”å›å®ƒçš„ä¸€ä¸ªä¸´æ—¶å¯¹è±¡ã€‚æŒ‰ç†è¯´ï¼Œæ—¢ç„¶ä¸èƒ½å¤åˆ¶ä¹Ÿä¸èƒ½ç§»åŠ¨ï¼Œè¿™ä¸ªå¯¹è±¡å°±ä¸åº”è¯¥èƒ½å¤Ÿä»å‡½æ•°è¿”å›åˆ°è°ƒç”¨è€…é‚£é‡Œã€‚

ä½†åœ¨ C++17 ä¸­ï¼Œè¿™æ®µä»£ç æ˜¯å®Œå…¨åˆæ³•çš„ï¼å› ä¸ºæ ‡å‡†è¦æ±‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨å¿…é¡»ç›´æ¥åœ¨`main`å‡½æ•°çš„`obj`å˜é‡çš„å†…å­˜ä½ç½®ä¸Šæ„é€ è¿™ä¸ª`NonCopyable`å¯¹è±¡ï¼Œå®Œå…¨è·³è¿‡ä»»ä½•å¤åˆ¶æˆ–ç§»åŠ¨æ“ä½œã€‚

### ä¸ºä»€ä¹ˆè¿™ä¸ªå˜åŒ–å¾ˆé‡è¦ï¼Ÿ
1ã€**ä»£ç è¡Œä¸ºæ›´å¯é¢„æµ‹**ï¼šæ— è®ºä½¿ç”¨å“ªä¸ªç¼–è¯‘å™¨ï¼Œä¼˜åŒ–æ•ˆæœéƒ½æ˜¯ä¸€æ ·çš„

2ã€**ä½¿ç”¨ä¸å¯å¤åˆ¶ç±»å‹æ›´çµæ´»**ï¼šå¦‚ä¸Šä¾‹æ‰€ç¤ºï¼Œå³ä½¿ç±»ç¦æ­¢äº†å¤åˆ¶å’Œç§»åŠ¨ï¼Œä¹Ÿèƒ½è½»æ¾è¿”å›

3ã€**æ€§èƒ½ä¿è¯æ›´å¼º**ï¼šæ ‡å‡†ä¿è¯ä¸´æ—¶å¯¹è±¡è¿”å›æ—¶ä¸ä¼šæœ‰é¢å¤–å¼€é”€

ä¸è¿‡è¦æ³¨æ„ï¼ŒNRVOï¼ˆè¿”å›å…·åå¯¹è±¡ï¼‰åœ¨ C++17 ä¸­ä»ç„¶æ˜¯å¯é€‰çš„ä¼˜åŒ–ï¼Œç¼–è¯‘å™¨å¯ä»¥è‡ªè¡Œå†³å®šæ˜¯å¦åº”ç”¨ã€‚åªæœ‰RVOï¼ˆè¿”å›ä¸´æ—¶å¯¹è±¡ï¼‰æ˜¯å¼ºåˆ¶çš„ã€‚

æ‰€ä»¥ï¼Œå¦‚æœä½ å¸Œæœ›ä»£ç åœ¨æ‰€æœ‰ C++17 ç¼–è¯‘å™¨ä¸Šéƒ½èƒ½è·å¾—ä¼˜åŒ–ï¼Œè¿”å›ä¸´æ—¶å¯¹è±¡ä¼šæ˜¯æ›´å®‰å…¨çš„é€‰æ‹©ï¼š

```c++
// åœ¨æ‰€æœ‰C++17ç¼–è¯‘å™¨ä¸Šéƒ½ä¼šè¢«ä¼˜åŒ–
BigObject getBigObject() {
    return BigObject();  // è¿”å›ä¸´æ—¶å¯¹è±¡ï¼Œå¼ºåˆ¶ä¼˜åŒ–
}

// å¯èƒ½ä¼šè¢«ä¼˜åŒ–ï¼Œå–å†³äºç¼–è¯‘å™¨
BigObject getBigObject2() {
    BigObject obj;
    return obj;  // è¿”å›å…·åå¯¹è±¡ï¼Œä¼˜åŒ–æ˜¯å¯é€‰çš„
}
```

## å…­ã€å®æˆ˜åº”ç”¨ï¼šå¦‚ä½•å……åˆ†åˆ©ç”¨ RVO å’Œ NRVO

å¥½äº†ï¼Œäº†è§£äº†è¿™ä¹ˆå¤šç†è®ºçŸ¥è¯†ï¼Œç°åœ¨è¯¥è°ˆè°ˆæ€ä¹ˆåœ¨æ—¥å¸¸ç¼–ç ä¸­å®é™…è¿ç”¨è¿™äº›æŠ€å·§äº†ï¼ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹å¦‚ä½•å†™å‡ºèƒ½å¤Ÿå……åˆ†åˆ©ç”¨RVOå’ŒNRVOçš„ä»£ç ã€‚

### 1. å°½å¯èƒ½ä½¿ç”¨è¿”å›å€¼ï¼Œè€Œä¸æ˜¯è¾“å‡ºå‚æ•°
åœ¨C++ä¸­ï¼Œæœ‰ä¸¤ç§å¸¸è§çš„æ–¹å¼å‘è°ƒç”¨è€…ä¼ é€’æ–°åˆ›å»ºçš„å¯¹è±¡ï¼šé€šè¿‡è¿”å›å€¼æˆ–é€šè¿‡è¾“å‡ºå‚æ•°ã€‚

```c++
// æ–¹å¼1ï¼šä½¿ç”¨è¾“å‡ºå‚æ•°
void createBigObject(BigObject& outObj) {
    // åˆå§‹åŒ–outObj...
    outObj.setData(42);
}

// æ–¹å¼2ï¼šä½¿ç”¨è¿”å›å€¼
BigObject createBigObject() {
    BigObject obj;
    obj.setData(42);
    return obj;
}
```

**å“ªç§æ›´å¥½ï¼Ÿ** æ¯«æ— ç–‘é—®æ˜¯ç¬¬äºŒç§ï¼

ä½¿ç”¨è¿”å›å€¼ä¸ä»…ä»£ç æ›´åŠ æ¸…æ™°ï¼ˆè¡¨æ˜å‡½æ•°çš„ç›®çš„æ˜¯"åˆ›å»º"å’Œ"è¿”å›"æŸç‰©ï¼‰ï¼Œè€Œä¸”èƒ½å¤Ÿåˆ©ç”¨ RVO/NRVO ä¼˜åŒ–æ€§èƒ½ã€‚è€Œç¬¬ä¸€ç§æ–¹å¼æ— æ³•åˆ©ç”¨è¿™äº›ä¼˜åŒ–ã€‚

åœ¨ç°ä»£ C++ ä¸­ï¼Œä½ å®Œå…¨ä¸éœ€è¦æ‹…å¿ƒè¿”å›å¤§å¯¹è±¡ä¼šå½±å“æ€§èƒ½ã€‚ç›¸åï¼Œä½ åº”è¯¥æ‹¥æŠ±è¿”å›å€¼é£æ ¼ï¼

### 2. åœ¨å‡½æ•°æœ«å°¾ç›´æ¥è¿”å›å±€éƒ¨å˜é‡
çœ‹çœ‹ä¸‹é¢ä¸¤ç§å†™æ³•ï¼š

```c++
// ä¸å¥½çš„å†™æ³•
BigObject createBigObject() {
    BigObject result;
    // åˆå§‹åŒ–result...
    BigObject temp = result; // å¤šä½™çš„å¤åˆ¶
    return temp;
}

// æ›´å¥½çš„å†™æ³•
BigObject createBigObject() {
    BigObject result;
    // åˆå§‹åŒ–result...
    return result; // ç›´æ¥è¿”å›ï¼Œå¯èƒ½è§¦å‘NRVO
}
```

ç¬¬ä¸€ç§å†™æ³•ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå¤šä½™çš„`temp`å¯¹è±¡ï¼Œå¹¶åšäº†ä¸€æ¬¡ä¸å¿…è¦çš„å¤åˆ¶ã€‚è¿™ä¸ä»…å¢åŠ äº†ä»£ç çš„å¤æ‚æ€§ï¼Œè¿˜ç ´åäº†NRVOä¼˜åŒ–çš„æ¡ä»¶ã€‚

ç¬¬äºŒç§å†™æ³•ç®€å•ç›´æ¥ï¼Œè€Œä¸”æ›´æœ‰å¯èƒ½è§¦å‘ NRVO ä¼˜åŒ–ã€‚è®°ä½ï¼š**ç›´æ¥è¿”å›ä½ æƒ³è¦è¿”å›çš„å±€éƒ¨å˜é‡ï¼Œä¸è¦ç»•å¼¯å­ï¼**

### 3. å°å¿ƒä½¿ç”¨std::move
åˆå­¦ C++11 çš„åŒå­¦å¯èƒ½ä¼šæœ‰ä¸€ä¸ªå¸¸è§è¯¯åŒºï¼šè®¤ä¸ºç»™æ‰€æœ‰è¿”å›çš„å¯¹è±¡éƒ½åŠ ä¸Š`std::move`ä¼šæé«˜æ•ˆç‡ã€‚å®é™…ä¸Šï¼Œè¿™é€šå¸¸æ˜¯ä¸€ä¸ªå·¨å¤§çš„é”™è¯¯ï¼

```c++
// é”™è¯¯ç¤ºèŒƒï¼ä¼šç ´åRVO/NRVO
BigObject createBigObject() {
    BigObject obj;
    // ...
    return std::move(obj); // âŒ ä¸è¦è¿™æ ·åšï¼å¯èƒ½ä¼šé˜»æ­¢NRVOï¼
}

// æ­£ç¡®åšæ³•ï¼šç›´æ¥è¿”å›å±€éƒ¨å˜é‡
BigObject createBigObject() {
    BigObject obj;
    // ...
    return obj; // âœ… è®©ç¼–è¯‘å™¨åšä¼˜åŒ–
}
```

ä¸ºä»€ä¹ˆ`std::move`åè€Œä¼šé™ä½æ€§èƒ½ï¼Ÿå› ä¸ºå®ƒå‘Šè¯‰ç¼–è¯‘å™¨ï¼š"æˆ‘è¦ç§»åŠ¨è¿™ä¸ªå¯¹è±¡"ï¼Œè¿™å°±é˜»æ­¢äº†ç¼–è¯‘å™¨ç›´æ¥åœ¨ç›®æ ‡ä½ç½®æ„é€ å¯¹è±¡çš„ä¼˜åŒ–è·¯å¾„ã€‚è®°ä½ï¼š**åœ¨è¿”å›å±€éƒ¨å˜é‡æ—¶ï¼Œä¸è¦ä½¿ç”¨** `std::move`ï¼

å”¯ä¸€åº”è¯¥ä½¿ç”¨ `std::move`çš„æƒ…å†µæ˜¯å½“ä½ ç¡®å®š RVO/NRVO æ— æ³•åº”ç”¨ï¼Œè€Œä½ åˆæƒ³é¿å…å¤åˆ¶çš„æ—¶å€™ï¼š

```c++
BigObject createBigObject(bool condition) {
    BigObject obj1;
    BigObject obj2;
    
    // å¤šè¿”å›è·¯å¾„æƒ…å†µä¸‹ï¼ŒNRVOå¯èƒ½å¤±æ•ˆ
    // æ­¤æ—¶ä½¿ç”¨ç§»åŠ¨è¯­ä¹‰ä½œä¸º"å¤‡èƒ"
    if (condition) {
        return std::move(obj1); // è¿™é‡Œä½¿ç”¨moveæ˜¯åˆç†çš„
    } else {
        return std::move(obj2); // è¿™é‡Œä¹Ÿæ˜¯
    }
}
```

### 4. ä½¿ç”¨å³å€¼å¼•ç”¨å’Œç§»åŠ¨æ„é€ å‡½æ•°ä½œä¸ºåå¤‡

ä» C++11 å¼€å§‹ï¼Œæˆ‘ä»¬æœ‰äº†ç§»åŠ¨è¯­ä¹‰ã€‚å³ä½¿åœ¨ RVO/NRVO æ— æ³•åº”ç”¨çš„åœºæ™¯ï¼Œç§»åŠ¨è¯­ä¹‰ä¹Ÿèƒ½æä¾›æ¯”å¤åˆ¶æ›´é«˜æ•ˆçš„æ–¹æ¡ˆï¼š

```c++
class BigObject {
private:
    vector<int> data; // å¯èƒ½å¾ˆå¤§çš„æ•°æ®
public:
    // ç§»åŠ¨æ„é€ å‡½æ•°
    BigObject(BigObject&& other) noexcept
        : data(std::move(other.data)) { // åªæ˜¯è½¬ç§»æŒ‡é’ˆï¼Œä¸å¤åˆ¶æ•°æ®
        cout << "ç§»åŠ¨æ„é€ " << endl;
    }
    
    // å¸¸è§„å¤åˆ¶æ„é€ å‡½æ•°
    BigObject(const BigObject& other)
        : data(other.data) { // å¤åˆ¶æ‰€æœ‰æ•°æ®ï¼Œå¯èƒ½å¾ˆæ…¢
        cout << "å¤åˆ¶æ„é€ " << endl;
    }
};
```

é€šè¿‡å®ç°ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œå³ä½¿åœ¨RVO/NRVOå¤±æ•ˆçš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šé€‰æ‹©è°ƒç”¨ç§»åŠ¨æ„é€ è€Œä¸æ˜¯å¤åˆ¶æ„é€ ï¼Œè¿™èƒ½æ˜¾è‘—æå‡æ€§èƒ½ã€‚

### å®æˆ˜å°è´´å£«æ€»ç»“

1ã€**ä¼˜å…ˆä½¿ç”¨è¿”å›å€¼é£æ ¼**ï¼Œè€Œä¸æ˜¯è¾“å‡ºå‚æ•°

2ã€**ç›´æ¥è¿”å›å±€éƒ¨å˜é‡**ï¼Œä¸è¦åˆ›å»ºä¸´æ—¶å‰¯æœ¬

3ã€**ä¸è¦å¯¹è¿”å›çš„å±€éƒ¨å˜é‡ä½¿ç”¨**`std::move`ï¼Œé™¤éä½ ç¡®å®š RVO/NRVO æ— æ³•åº”ç”¨

4ã€**å®ç°ç§»åŠ¨æ„é€ å‡½æ•°**ä½œä¸ºåå¤‡ä¼˜åŒ–

5ã€**é˜…è¯»ç¼–è¯‘å™¨ç”Ÿæˆçš„æ±‡ç¼–ä»£ç **ï¼ˆå¦‚æœä½ æƒ³ç¡®è®¤ä¼˜åŒ–æ˜¯å¦ç”Ÿæ•ˆï¼‰

æŒæ¡äº†è¿™äº›æŠ€å·§ï¼Œä½ å°±èƒ½å†™å‡ºæ—¢æ¸…æ™°åˆé«˜æ•ˆçš„C++ä»£ç ï¼Œå……åˆ†åˆ©ç”¨ç¼–è¯‘å™¨ä¸ºä½ æä¾›çš„è¿™äº›å…è´¹çš„æ€§èƒ½ä¼˜åŒ–ï¼

## ä¸ƒã€å®é™…æµ‹é‡ï¼šéªŒè¯ä¼˜åŒ–æ•ˆæœ
ç†è®ºè®²å¾—å†å¤šï¼Œä¸å¦‚äº²è‡ªéªŒè¯ä¸€ä¸‹ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªæ›´å…¨é¢çš„åŸºå‡†æµ‹è¯•ä»£ç ï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥æµ‹é‡ä¸åŒæƒ…å†µä¸‹çš„æ€§èƒ½å·®å¼‚ï¼š

```c++
#include <iostream>
#include <chrono>
#include <vector>
#include <string>
using namespace std;
using namespace std::chrono;

// ä¸€ä¸ªè¶³å¤Ÿå¤§çš„ç±»ï¼Œä½¿æ€§èƒ½å·®å¼‚æ˜æ˜¾
class BigObject {
private:
    vector<int> data;
    string name;
public:
    BigObject(size_t size = 1000000) : data(size) {
        for (size_t i = 0; i < size; i++) {
            data[i] = static_cast<int>(i);
        }
        name = "BigObject";
    }
    
    BigObject(const BigObject& other) : data(other.data), name(other.name) {
        cout << "å¤åˆ¶æ„é€ : å¤åˆ¶äº† " << data.size() << " ä¸ªå…ƒç´ " << endl;
    }
    
    BigObject(BigObject&& other) noexcept : 
        data(std::move(other.data)), name(std::move(other.name)) {
        cout << "ç§»åŠ¨æ„é€ è¢«è°ƒç”¨" << endl;
    }
    
    BigObject& operator=(const BigObject& other) {
        if (this != &other) {
            data = other.data;
            name = other.name;
            cout << "å¤åˆ¶èµ‹å€¼: å¤åˆ¶äº† " << data.size() << " ä¸ªå…ƒç´ " << endl;
        }
        return *this;
    }
    
    BigObject& operator=(BigObject&& other) noexcept {
        if (this != &other) {
            data = std::move(other.data);
            name = std::move(other.name);
            cout << "ç§»åŠ¨èµ‹å€¼è¢«è°ƒç”¨" << endl;
        }
        return *this;
    }
    
    ~BigObject() {
        // ææ„å‡½æ•°
    }
    
    size_t getSize() const { return data.size(); }
};

// ä½¿ç”¨RVOï¼ˆè¿”å›ä¸´æ—¶å¯¹è±¡ï¼‰
BigObject createWithRVO(size_t size) {
    return BigObject(size);
}

// ä½¿ç”¨NRVOï¼ˆè¿”å›å…·åå¯¹è±¡ï¼‰
BigObject createWithNRVO(size_t size) {
    BigObject obj(size);
    return obj;
}

// æ•…æ„é˜»æ­¢RVO/NRVO
BigObject createWithDisabledOptimization(size_t size, bool flag) {
    BigObject obj1(size);
    BigObject obj2(size);
    
    if (flag) {
        return obj1;
    } else {
        return obj2;
    }
}

// ä½¿ç”¨ç§»åŠ¨è¯­ä¹‰
BigObject createWithMove(size_t size, bool flag) {
    BigObject obj1(size);
    BigObject obj2(size);
    
    if (flag) {
        return std::move(obj1);
    } else {
        return std::move(obj2);
    }
}

// è¿è¡ŒåŸºå‡†æµ‹è¯•
template<typename Func>
long long runBenchmark(Func func, int iterations) {
    auto start = high_resolution_clock::now();
    
    for (int i = 0; i < iterations; i++) {
        BigObject obj = func();
        // åšä¸€äº›æ“ä½œä»¥é˜²æ­¢ç¼–è¯‘å™¨è¿‡åº¦ä¼˜åŒ–
        if (obj.getSize() < 0) cout << "ä¸å¯èƒ½å‘ç”Ÿ" << endl;
    }
    
    auto end = high_resolution_clock::now();
    return duration_cast<milliseconds>(end - start).count();
}

int main() {
    const int iterations = 10;
    const size_t objSize = 1000000;
    
    cout << "æµ‹è¯•RVOä¼˜åŒ–..." << endl;
    auto rvoTime = runBenchmark([objSize]() { 
        return createWithRVO(objSize); 
    }, iterations);
    
    cout << "\næµ‹è¯•NRVOä¼˜åŒ–..." << endl;
    auto nrvoTime = runBenchmark([objSize]() { 
        return createWithNRVO(objSize); 
    }, iterations);
    
    cout << "\næµ‹è¯•æ— ä¼˜åŒ–æƒ…å†µ..." << endl;
    auto noOptTime = runBenchmark([objSize]() { 
        return createWithDisabledOptimization(objSize, rand() % 2); 
    }, iterations);
    
    cout << "\næµ‹è¯•ç§»åŠ¨è¯­ä¹‰..." << endl;
    auto moveTime = runBenchmark([objSize]() { 
        return createWithMove(objSize, rand() % 2); 
    }, iterations);
    
    cout << "\næ€§èƒ½æ¯”è¾ƒ:" << endl;
    cout << "RVO: " << rvoTime << "ms" << endl;
    cout << "NRVO: " << nrvoTime << "ms" << endl;
    cout << "æ— ä¼˜åŒ–: " << noOptTime << "ms" << endl;
    cout << "ç§»åŠ¨è¯­ä¹‰: " << moveTime << "ms" << endl;
    
    return 0;
}
```

åœ¨ Visual Studio 2022 ä¸Šçš„æµ‹è¯•ç»“æœ:

```text
æµ‹è¯•RVOä¼˜åŒ–...

æµ‹è¯•NRVOä¼˜åŒ–...

æµ‹è¯•æ— ä¼˜åŒ–æƒ…å†µ...
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨

æµ‹è¯•ç§»åŠ¨è¯­ä¹‰...
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨
ç§»åŠ¨æ„é€ è¢«è°ƒç”¨

æ€§èƒ½æ¯”è¾ƒ:
RVO: 127ms
NRVO: 118ms
æ— ä¼˜åŒ–: 241ms
ç§»åŠ¨è¯­ä¹‰: 243ms
```

ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼š

+ RVO å’Œ NRVO çš„æ€§èƒ½å‡ ä¹ç›¸åŒï¼Œéƒ½éå¸¸ä¼˜ç§€
+ æœ‰è¶£çš„æ˜¯ï¼Œ"æ— ä¼˜åŒ–æƒ…å†µ"å’Œ"æ˜¾å¼ä½¿ç”¨ç§»åŠ¨è¯­ä¹‰"çš„æ€§èƒ½ä¹Ÿå‡ ä¹ç›¸åŒ
+ æœ€ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œå³ä½¿åœ¨"æ— ä¼˜åŒ–æƒ…å†µ"ä¸‹ï¼Œä¹Ÿè°ƒç”¨äº†ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œè€Œä¸æ˜¯å¤åˆ¶æ„é€ å‡½æ•°ï¼

### ç¼–è¯‘å™¨å’Œå¹³å°çš„å½±å“
ä¸è¿‡ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæµ‹è¯•ç»“æœä¼šå—åˆ°ç¼–è¯‘å™¨ã€ç¼–è¯‘é€‰é¡¹å’Œå¹³å°çš„å½±å“ã€‚æˆ‘æ˜¯åœ¨Visual Studio 2022ä¸Šè¿›è¡Œçš„æµ‹è¯•ï¼Œå‘ç°äº†ä¸€äº›æœ‰è¶£çš„ç°è±¡ï¼š

**å…³äºç§»åŠ¨æ„é€ å‡½æ•°çš„é‡è¦å‘ç°**ï¼š

å¦‚æœæ³¨é‡Šæ‰`BigObject`ç±»çš„ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œæµ‹è¯•ç»“æœä¼šæœ‰æ˜¾è‘—å˜åŒ–ï¼š

+ "æ— ä¼˜åŒ–æƒ…å†µ"å’Œ"ç§»åŠ¨è¯­ä¹‰"æµ‹è¯•éƒ½ä¼šè°ƒç”¨å¤åˆ¶æ„é€ å‡½æ•°
+ ä¸¤è€…çš„æ€§èƒ½å‡ ä¹å®Œå…¨ç›¸åŒ

åä¹‹ï¼Œå¦‚æœå®šä¹‰äº†ç§»åŠ¨æ„é€ å‡½æ•°ï¼š

+ ä¸¤ç§æƒ…å†µéƒ½ä¼šè°ƒç”¨ç§»åŠ¨æ„é€ å‡½æ•°
+ æ€§èƒ½åŒæ ·ä¼šéå¸¸æ¥è¿‘

è¿™ä¸ªç°è±¡è§£é‡Šäº†ä¸ºä»€ä¹ˆåœ¨æŸäº›æµ‹è¯•ç¯å¢ƒä¸­ï¼Œ"æ— ä¼˜åŒ–"å’Œ"ç§»åŠ¨è¯­ä¹‰"çš„æ€§èƒ½å·®å¼‚ä¸æ˜æ˜¾ã€‚å®ƒè¯´æ˜ï¼š

1ã€**C++ç¼–è¯‘å™¨éå¸¸æ™ºèƒ½**ï¼šå³ä½¿åœ¨æ— æ³•åº”ç”¨RVO/NRVOçš„æƒ…å†µä¸‹ï¼Œå¦‚æœæœ‰ç§»åŠ¨æ„é€ å‡½æ•°å¯ç”¨ï¼Œç°ä»£ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨é€‰æ‹©ç§»åŠ¨è€Œéå¤åˆ¶

2ã€ **æ·»åŠ std::moveå¹¶ä¸æ€»æ˜¯å¿…è¦çš„**ï¼šåœ¨å¤šè¿”å›è·¯å¾„çš„æƒ…å†µä¸‹ï¼Œå³ä½¿ä¸æ˜¾å¼ä½¿ç”¨`std::move`ï¼Œç¼–è¯‘å™¨ä¹Ÿå¯èƒ½è‡ªåŠ¨åº”ç”¨ç§»åŠ¨è¯­ä¹‰

3ã€ **ä½†å®šä¹‰ç§»åŠ¨æ„é€ å‡½æ•°å¾ˆé‡è¦**ï¼šè¦è®©ç¼–è¯‘å™¨èƒ½å¤Ÿé€‰æ‹©ç§»åŠ¨è€Œä¸æ˜¯å¤åˆ¶ï¼Œå¿…é¡»å®šä¹‰ç§»åŠ¨æ„é€ å‡½æ•°

è¿™ä¸ªæµ‹è¯•æé†’æˆ‘ä»¬ï¼šåœ¨è¿›è¡Œæ€§èƒ½ä¼˜åŒ–æ—¶ï¼ŒåŠ¡å¿…åœ¨è‡ªå·±çš„å®é™…ç¯å¢ƒä¸­æµ‹è¯•ï¼Œå› ä¸ºä¸åŒç¼–è¯‘å™¨å’Œä¸åŒç¼–è¯‘é€‰é¡¹å¯èƒ½å¯¼è‡´ä¸åŒçš„ä¼˜åŒ–ç»“æœã€‚

è¿™ä¹Ÿè¿›ä¸€æ­¥å¼ºè°ƒäº† C++ æ ‡å‡†åº“ä¸­"Rule of Five"ï¼ˆäº”æ³•åˆ™ï¼‰çš„é‡è¦æ€§ï¼šå¦‚æœä½ å®šä¹‰äº†ä»»ä½•ä¸€ä¸ªå¤åˆ¶æ„é€ ã€å¤åˆ¶èµ‹å€¼ã€ç§»åŠ¨æ„é€ ã€ç§»åŠ¨èµ‹å€¼æˆ–ææ„å‡½æ•°ï¼Œé€šå¸¸åº”è¯¥è€ƒè™‘å®šä¹‰æ‰€æœ‰äº”ä¸ªå‡½æ•°ï¼Œä»¥ç¡®ä¿ç±»çš„è¡Œä¸ºä¸€è‡´ä¸”æ€§èƒ½æœ€ä¼˜ã€‚

## å…«ã€æ€»ç»“ä¸æœ€ä½³å®è·µ
è®²äº†è¿™ä¹ˆå¤šï¼Œæ˜¯æ—¶å€™æŠŠé‡ç‚¹å†…å®¹ç®€å•æ€»ç»“ä¸€ä¸‹äº†ï¼

### RVOä¸NRVOï¼šä¸å†æ˜¯"å¤§å¯¹è±¡åˆ«è¿”å›"
ä»¥å‰æˆ‘ä»¬å¸¸è¢«å‘Šè¯«ï¼š"C++è¿”å›å¤§å¯¹è±¡å¾ˆæ…¢ï¼Œå°½é‡ç”¨æŒ‡é’ˆæˆ–å¼•ç”¨ä¼ é€’"ã€‚ç°åœ¨çœ‹æ¥ï¼Œè¿™ä¸ªè¯´æ³•å·²ç»è¿‡æ—¶å•¦ï¼

æœ‰äº†RVOå’ŒNRVOè¿™ä¸¤ä¸ªå¼ºå¤§çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œè¿”å›å¯¹è±¡ä¸å†æ˜¯æ€§èƒ½ç“¶é¢ˆï¼š

1. **RVOå¤„ç†ä¸´æ—¶å¯¹è±¡è¿”å›**ï¼š`return BigObject();`
2. **NRVOå¤„ç†å±€éƒ¨å˜é‡è¿”å›**ï¼š`BigObject obj; return obj;`
3. **C++17è®©RVOæˆä¸ºå¿…é€‰é¡¹**ï¼šç¼–è¯‘å™¨å¿…é¡»ä¼˜åŒ–ä¸´æ—¶å¯¹è±¡è¿”å›
4. **ç§»åŠ¨è¯­ä¹‰æ˜¯ä¸é”™çš„å¤‡èƒ**ï¼šå½“RVO/NRVOå¤±æ•ˆæ—¶çš„ä¿åº•æ–¹æ¡ˆ

**æœ€ä½³ç¼–ç å®è·µåŒ…æ‹¬**ï¼šç›´æ¥è¿”å›å¯¹è±¡è€Œéç”¨è¾“å‡ºå‚æ•°ã€ç›´æ¥è¿”å›å±€éƒ¨å˜é‡ä¸åšé¢å¤–å¤åˆ¶ã€ä¸å¯¹è¿”å›å±€éƒ¨å˜é‡ä½¿ç”¨std::moveã€å®ç°ç§»åŠ¨æ„é€ å‡½æ•°ä½œä¸ºåå¤‡ã€ä½¿ç”¨ç°ä»£ç¼–è¯‘å™¨å¹¶å¼€å¯ä¼˜åŒ–ç­‰ã€‚

### åˆ«è¢«"è¿‡æ—©ä¼˜åŒ–"å›°ä½

æœ‰å¥åè¨€ï¼š"è¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æº"ã€‚ä½†åˆ©ç”¨ RVO/NRVO å¹¶éè¿‡æ—©ä¼˜åŒ– â€” è¿™äº›å†™æ³•æœ¬èº«å°±æ˜¯ç°ä»£C++çš„è‡ªç„¶è¡¨è¾¾ï¼Œä»£ç æ›´æ¸…æ™°ï¼Œè¿˜èƒ½è·å¾—æ›´å¥½æ€§èƒ½ï¼Œä½•ä¹è€Œä¸ä¸ºï¼Ÿ

## ç»“è¯­ï¼šä¸åªæ˜¯ä¸€ä¸ªä¼˜åŒ–æŠ€å·§

RVO å’Œ NRVO ä»£è¡¨äº† C++ çš„ä¸€ä¸ªé‡è¦ç†å¿µï¼š**é›¶å¼€é”€æŠ½è±¡**ã€‚é€šè¿‡å®ƒä»¬ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºæ—¢æ¸…æ™°åˆé«˜æ•ˆçš„ä»£ç ã€‚è¿™æ­£æ˜¯C++çš„é­…åŠ›æ‰€åœ¨ï¼

å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®ä½ æ›´å¥½ç†è§£å’Œåˆ©ç”¨è¿™ä¸¤ä¸ªå¼ºå¤§çš„ä¼˜åŒ–æŠ€æœ¯ã€‚C++çš„ä¼˜åŒ–æŠ€å·§è¿˜æœ‰å¾ˆå¤šï¼Œåç»­æˆ‘ä¼šç»§ç»­åˆ†äº«æ›´å¤šå®ç”¨çš„ C++ æ€§èƒ½ä¼˜åŒ–çŸ¥è¯†ã€‚

å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€Œ**è·Ÿç€å°åº·å­¦ç¼–ç¨‹**ã€ï¼Œæˆ‘ä¼šå®šæœŸåˆ†äº« Linux C/C++ åç«¯æŠ€æœ¯ï¼Œä»¥åŠè®¡ç®—æœºåŸºç¡€ç­‰çŸ¥è¯†ï¼Œå¸¦ä½ ä¸€èµ·æ¢ç´¢ç¼–ç¨‹çš„å¥¥ç§˜ã€‚

å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œåˆ«å¿˜äº†ç‚¹ã€Œ**èµ**ã€ğŸ‘ã€ç‚¹ä¸ªã€Œ**åœ¨çœ‹**ã€ğŸ‘€ã€**åˆ†äº«**ç»™ä½ çš„ç¨‹åºå‘˜æœ‹å‹ä»¬ï¼ä½ çš„æ¯ä¸€æ¬¡äº’åŠ¨ï¼Œéƒ½æ˜¯æˆ‘åˆ›ä½œçš„æœ€å¤§åŠ¨åŠ›ï¼

ä¸‹æœŸè§ï¼

#### æ€ä¹ˆå…³æ³¨æˆ‘çš„å…¬ä¼—å·ï¼Ÿ

**ç‚¹å‡»ä¸‹æ–¹å…¬ä¼—å·åç‰‡å³å¯å…³æ³¨**ã€‚

![](https://files.mdnice.com/user/71186/0dde803d-d52f-4ed8-b74b-b7f3da5817b9.png)


å¦å¤–ï¼Œå°åº·è¿˜å»ºäº†ä¸€ä¸ªæŠ€æœ¯äº¤æµç¾¤ï¼Œä¸“é—¨èŠæŠ€æœ¯ã€ç­”ç–‘è§£æƒ‘ã€‚å¦‚æœä½ åœ¨è¯»æ–‡ç« æ—¶ç¢°åˆ°ä¸æ‡‚çš„åœ°æ–¹ï¼Œéšæ—¶æ¬¢è¿æ¥ç¾¤é‡Œæé—®ï¼æˆ‘ä¼šå°½åŠ›å¸®å¤§å®¶è§£ç­”ï¼Œç¾¤é‡Œè¿˜æœ‰ä¸å°‘æŠ€æœ¯å¤§ä½¬åœ¨çº¿æ”¯æ´ï¼Œå’±ä»¬ä¸€èµ·å­¦ä¹ è¿›æ­¥ï¼Œäº’ç›¸æˆé•¿ï¼

![](https://files.mdnice.com/user/48364/971ccaa3-8f57-4e33-8bc9-d0863eeade81.png)