å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°åº·ã€‚ä»Šå¤©æˆ‘ä»¬æ¥èŠä¸€èŠç¨‹åºå‘˜å™©æ¢¦ä¸­çš„å¸¸å®¢â€”â€”ç¨‹åºå´©æºƒé—®é¢˜ã€‚ä½œä¸ºä¸€åC++å¼€å‘è€…ï¼Œæˆ‘æ•¢æ‰“èµŒä½ ä¸€å®šç»å†è¿‡è¿™æ ·çš„åœºæ™¯ï¼š

> ä½ æ˜¯å¦æ›¾åœ¨æ·±å¤œé‡Œï¼Œå¯¹ç€ç»ˆç«¯å±å¹•ä¸Šçš„"Segmentation fault (core dumped)"å‘å‘†ï¼Ÿ
>
> ä½ æ˜¯å¦æ›¾ç»ä¸ºäº†ä¸€ä¸ªç¥ç§˜çš„å´©æºƒé—®é¢˜ï¼Œå½»å¤œéš¾çœ ï¼Œå´æ— ä»ä¸‹æ‰‹ï¼Ÿ
>
> ä½ æ˜¯å¦æ›¾ç»ç¾¡æ…•é‚£äº›èƒ½è¿…é€Ÿå®šä½å´©æºƒé—®é¢˜çš„å¤§ä½¬ï¼Œè§‰å¾—é‚£æ˜¯ä¸€ç§"ç¥ç§˜æŠ€èƒ½"ï¼Ÿ
>

å¦‚æœä½ ç‚¹å¤´äº†ï¼Œé‚£ä¹ˆæ­å–œä½ ï¼Œä»Šå¤©è¿™ç¯‡æ–‡ç« å°±æ˜¯ä¸ºä½ é‡èº«å®šåšçš„ï¼

>æƒ³ç³»ç»Ÿå­¦ä¹ æ›´å¤š C++ çŸ¥è¯†ï¼Ÿæ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€Œ**è·Ÿç€å°åº·ç¼–ç¨‹**ã€ï¼Œæˆ‘ä¼šæŒç»­æ›´æ–° Cã€ C++ã€Linuxã€åç«¯å¼€å‘ç­‰é«˜è´¨é‡æŠ€æœ¯æ–‡ç« ã€‚ä¹Ÿå¯ä»¥åŠ æˆ‘çš„ä¸ªäººå¾®ä¿¡ï¼Œä¸€èµ·è¿›ç¾¤è®¨è®ºå­¦ä¹ ï¼
>
> 
> <table>
> <tr>
> <td align="center">
> <img src="https://github.com/xiaokangcoding/follow-xiaokang-coding/raw/main/images/qrcode-wechat-official.png" width="200">
> <br>
> <em>å…¬ä¼—å·ã€Œè·Ÿç€å­¦å°åº·ç¼–ç¨‹ã€</em>
> </td>
> <td align="center">
> <img src="https://github.com/xiaokangcoding/follow-xiaokang-coding/raw/main/images/qrcode-personal-wechat.png" width="200">
> <br>
> <em>ä¸ªäººå¾®ä¿¡ï¼ˆå¤‡æ³¨ï¼šåŠ ç¾¤ï¼‰</em>
> </td>
> </tr>
> </table>

## ä¸€ã€ä»€ä¹ˆæ˜¯core dumpï¼Ÿåˆ«è¢«è¿™ä¸ªåå­—å“åˆ°

å…ˆåˆ«è¢«"core dump"è¿™ä¸ªå¬èµ·æ¥å¾ˆé«˜å¤§ä¸Šçš„åå­—å“åˆ°ã€‚ç®€å•æ¥è¯´ï¼Œ**core dumpå°±æ˜¯ç¨‹åºå´©æºƒæ—¶çš„"ç°åœºç…§ç‰‡"**ã€‚

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ çš„ç¨‹åºå°±åƒä¸€ä¸ªåœ¨é«˜é€Ÿå…¬è·¯ä¸Šå¥”é©°çš„èµ›è½¦ã€‚çªç„¶ï¼Œ"ç °"çš„ä¸€å£°ï¼Œå®ƒæ’å¢™äº†ï¼ˆå´©æºƒäº†ï¼‰ã€‚æ­¤æ—¶æ“ä½œç³»ç»Ÿä¼šç«‹å³æ‹ä¸‹äº‹æ•…ç°åœºçš„å…¨æ™¯ç…§ç‰‡ï¼ŒæŠŠè½¦å­çš„çŠ¶æ€ã€è·¯å†µã€æ–¹å‘ç›˜ä½ç½®ç­‰ä¿¡æ¯éƒ½è®°å½•ä¸‹æ¥ - è¿™å°±æ˜¯core dumpæ–‡ä»¶ã€‚

å®ƒåŒ…å«äº†ç¨‹åºå´©æºƒé‚£ä¸€åˆ»çš„**æ‰€æœ‰å†…å­˜ä¿¡æ¯**ã€**å¯„å­˜å™¨çŠ¶æ€**ã€**è°ƒç”¨æ ˆ**ç­‰å…³é”®æ•°æ®ï¼Œæ˜¯æˆ‘ä»¬ç ´æ¡ˆçš„é‡è¦çº¿ç´¢ï¼

## äºŒã€è®©core dumpç°èº«ï¼šè®¾ç½®ç¯å¢ƒæ‰èƒ½ç•™ä¸‹"ç½ªè¯"
åœ¨å¾ˆå¤šLinuxç³»ç»Ÿä¸­ï¼Œcore dumpåŠŸèƒ½é»˜è®¤æ˜¯å…³é—­çš„ã€‚æ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¦è®©ç³»ç»Ÿåœ¨ç¨‹åºå´©æºƒæ—¶ä¹–ä¹–äº¤å‡º"ç°åœºç…§ç‰‡"ã€‚

```bash
# æŸ¥çœ‹å½“å‰core dumpè®¾ç½®
ulimit -c

# å¦‚æœæ˜¾ç¤º0ï¼Œè¯´æ˜core dumpåŠŸèƒ½è¢«ç¦ç”¨äº†
# å¼€å¯core dumpåŠŸèƒ½ï¼ˆä¸é™åˆ¶å¤§å°ï¼‰
ulimit -c unlimited

# è®¾ç½®coreæ–‡ä»¶çš„å­˜æ”¾ä½ç½®å’Œå‘½åæ–¹å¼ï¼ˆä»¥Ubuntuä¸ºä¾‹ï¼‰
sudo sh -c 'echo "kernel.core_pattern=/tmp/core-%e-%p-%t" > /etc/sysctl.d/50-coredump.conf'
sudo sysctl -p /etc/sysctl.d/50-coredump.conf
```

è¿™æ ·è®¾ç½®åï¼Œå½“ç¨‹åºå´©æºƒæ—¶ï¼Œç³»ç»Ÿä¼šåœ¨ /tmp ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª core æ–‡ä»¶ï¼Œæ–‡ä»¶ååŒ…å«ç¨‹åºå(-e)ã€è¿›ç¨‹ID(-p)å’Œæ—¶é—´æˆ³(-t)ã€‚

## ä¸‰ã€åˆ¶é€ ä¸€ä¸ªå´©æºƒç°åœºï¼šæ¥ä¸ª"çœŸå®æ¡ˆä¾‹"
ä¸ºäº†è®©å¤§å®¶æœ‰ç›´è§‚æ„Ÿå—ï¼Œæˆ‘ä»¬å…ˆåˆ¶é€ ä¸€ä¸ªå…¸å‹çš„C++ç¨‹åºå´©æºƒï¼š

```cpp
// crash.cpp - ä¸€ä¸ªä¼šå´©æºƒçš„å°ç¨‹åº
#include <iostream>

void dangerous_function() {
    int* ptr = nullptr;  // ç©ºæŒ‡é’ˆ
    *ptr = 42;           // ç¾éš¾å³å°†å‘ç”Ÿï¼
}

void another_function() {
    dangerous_function();
}

int main() {
    std::cout << "å‡†å¤‡å´©æºƒï¼Œè¯·ç³»å¥½å®‰å…¨å¸¦..." << std::endl;
    another_function();
    std::cout << "è¿™è¡Œæ°¸è¿œä¸ä¼šæ‰§è¡Œåˆ°..." << std::endl;
    return 0;
}
```

ç¼–è¯‘å¹¶è¿è¡Œå®ƒï¼š

```bash
g++ -g crash.cpp -o crash  # -gé€‰é¡¹å¾ˆé‡è¦ï¼å®ƒä¼šåŠ å…¥è°ƒè¯•ä¿¡æ¯
./crash
```

"ç °ï¼"ç¨‹åºå´©æºƒäº†ï¼Œç»ˆç«¯æ˜¾ç¤ºï¼š

```plain
å‡†å¤‡å´©æºƒï¼Œè¯·ç³»å¥½å®‰å…¨å¸¦...
Segmentation fault (core dumped)
```

ç°åœ¨å»/tmpç›®å½•çœ‹çœ‹ï¼Œåº”è¯¥èƒ½æ‰¾åˆ°ä¸€ä¸ªåä¸º`core-crash-è¿›ç¨‹ID-æ—¶é—´æˆ³`çš„æ–‡ä»¶ã€‚è¿™å°±æ˜¯æˆ‘ä»¬çš„"ç°åœºç…§ç‰‡"ï¼

## å››ã€ä¾¦æ¢å·¥ä½œå¼€å§‹ï¼šè§£è¯»core dumpæ–‡ä»¶
æœ‰äº†core dumpæ–‡ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ç ´æ¡ˆäº†ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·â€”â€”GDBï¼ˆGNUè°ƒè¯•å™¨ï¼‰ã€‚

```bash
gdb ./crash /tmp/core-crash-xxxx-xxxx
```

ä¸€è¿›å…¥GDBï¼Œå®ƒå°±ä¼šå‘Šè¯‰ä½ ç¨‹åºæ˜¯åœ¨å“ªé‡Œå´©æºƒçš„ï¼š

```plain
Core was generated by `./crash'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x0000555555555175 in dangerous_function() at crash.cpp:5
5       *ptr = 42;  // ç¾éš¾å³å°†å‘ç”Ÿï¼
```

çœ‹ï¼å®ƒç›´æ¥æŒ‡å‡ºäº†é—®é¢˜æ‰€åœ¨ï¼šcrash.cppæ–‡ä»¶çš„ç¬¬ 5 è¡Œï¼Œæˆ‘ä»¬è¯•å›¾å¾€ç©ºæŒ‡é’ˆå†™å…¥æ•°æ®ã€‚

## äº”ã€æ·±å…¥è°ƒæŸ¥ï¼šæŸ¥çœ‹å®Œæ•´è°ƒç”¨æ ˆ
ä½†è¿™åªæ˜¯å†°å±±ä¸€è§’ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£æ›´å¤šä¿¡æ¯ï¼Œæ¯”å¦‚ç¨‹åºæ˜¯ä»å“ªé‡Œè°ƒç”¨åˆ°å´©æºƒç‚¹çš„ã€‚ä½¿ç”¨`bt`å‘½ä»¤å¯ä»¥æŸ¥çœ‹å®Œæ•´è°ƒç”¨æ ˆï¼š

```bash
(gdb) bt
#0  0x0000555555555175 in dangerous_function() at crash.cpp:5
#1  0x00005555555551a3 in another_function() at crash.cpp:9
#2  0x00005555555551bf in main() at crash.cpp:14
```

è¿™ä¸ªè°ƒç”¨æ ˆæ¸…æ¥šåœ°å±•ç¤ºäº†ç¨‹åºçš„æ‰§è¡Œè·¯å¾„ï¼šmainå‡½æ•°è°ƒç”¨äº†another_functionï¼Œè€Œanother_function åˆè°ƒç”¨äº† dangerous_functionï¼Œæœ€ç»ˆåœ¨ dangerous_function ä¸­å´©æºƒã€‚

## å…­ã€æ”¶é›†æ›´å¤šè¯æ®ï¼šæŸ¥çœ‹å˜é‡å€¼
æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥æ£€æŸ¥å´©æºƒæ—¶å„ä¸ªå˜é‡çš„å€¼ï¼š

```bash
(gdb) frame 0
#0  0x0000555555555175 in dangerous_function() at crash.cpp:5
5       *ptr = 42;  // ç¾éš¾å³å°†å‘ç”Ÿï¼

(gdb) print ptr
$1 = (int *) 0x0
```

è¿™è¯å®äº† ptr ç¡®å®æ˜¯ä¸€ä¸ªç©ºæŒ‡é’ˆ(0x0)ã€‚

æˆ‘ä»¬è¿˜å¯ä»¥æ£€æŸ¥å…¶ä»–æ ˆå¸§ä¸­çš„å˜é‡ï¼š

```bash
(gdb) frame 2
#2  0x00005555555551bf in main() at crash.cpp:14
14        another_function();

(gdb) list
9       void another_function() {
10          dangerous_function();
11      }
12      
13      int main() {
14          std::cout << "å‡†å¤‡å´©æºƒï¼Œè¯·ç³»å¥½å®‰å…¨å¸¦..." << std::endl;
15          another_function();
16          std::cout << "è¿™è¡Œæ°¸è¿œä¸ä¼šæ‰§è¡Œåˆ°..." << std::endl;
17          return 0;
18      }
```

è¿™æ ·æˆ‘ä»¬å°±è·å¾—äº†æ›´å¤šä»£ç ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

## ä¸ƒã€å®æˆ˜ï¼šæ›´å¤æ‚çš„æ¡ˆä¾‹åˆ†æ
è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªåœ¨å®é™…å¼€å‘ä¸­éå¸¸å…¸å‹ä¸”å¸¸è§çš„æ¡ˆä¾‹ï¼š**é‡Šæ”¾åä½¿ç”¨ï¼ˆUse After Freeï¼‰** é”™è¯¯ã€‚è¿™ç±»é—®é¢˜ç‰¹åˆ«å®¹æ˜“äº§ç”Ÿcore dumpï¼Œä¸”å¸¸å¸¸è®©å¼€å‘è€…å¤´ç–¼ä¸å·²ã€‚

```cpp
// uaf_crash.cpp
#include <iostream>
#include <string>
#include <vector>

class User {
private:
std::string name;
int* score;  // åŠ¨æ€åˆ†é…çš„ç§¯åˆ†

public:
User(const std::string& username, int initial_score) : name(username) {
    score = new int(initial_score);
    std::cout << "åˆ›å»ºç”¨æˆ·: " << name << ", åˆå§‹ç§¯åˆ†: " << *score << std::endl;
}

~User() {
    std::cout << "é”€æ¯ç”¨æˆ·: " << name << std::endl;
    delete score;  // é‡Šæ”¾å†…å­˜
    score = nullptr;  // è¿™æ˜¯ä¸ªå¥½ä¹ æƒ¯ï¼Œä½†åœ¨ææ„å‡½æ•°ä¸­å…¶å®æ²¡æœ‰å®é™…ä½œç”¨
}

void add_points(int points) {
    *score += points;
    std::cout << name << " è·å¾— " << points << " ç§¯åˆ†ï¼Œå½“å‰æ€»åˆ†: " << *score << std::endl;
}

std::string get_name() const {
    return name;
}

int get_score() const {
    return *score;  // ç›´æ¥è§£å¼•ç”¨ï¼Œä½†å¦‚æœscoreå·²ç»è¢«é‡Šæ”¾ï¼Œè¿™é‡Œä¼šå´©æºƒ
}
};

// è¿™ä¸ªå‡½æ•°ä¿å­˜äº†å¯¹å·²åˆ é™¤å¯¹è±¡çš„å¼•ç”¨ï¼
void process_later(const std::vector<User*>& users) {
    // å‡è®¾è¿™æ˜¯ä¸€ä¸ªå»¶è¿Ÿå¤„ç†å‡½æ•°ï¼Œåœ¨ä¸»ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†æ‰§è¡Œåæ‰ä¼šè¿è¡Œ
    std::cout << "\nè¿›è¡Œå»¶è¿Ÿå¤„ç†..." << std::endl;

    for (const auto& user : users) {
        std::cout << "å¤„ç†ç”¨æˆ·: " << user->get_name();
        std::cout << ", ç§¯åˆ†: " << user->get_score() << std::endl;
    }
}

int main() {
    std::vector<User*> active_users;
    std::vector<User*> users_for_processing;

    // åˆ›å»ºä¸€äº›ç”¨æˆ·
    User* alice = new User("Alice", 100);
    User* bob = new User("Bob", 150);
    User* charlie = new User("Charlie", 200);

    active_users.push_back(alice);
    active_users.push_back(bob);
    active_users.push_back(charlie);

    // ä¸ºä¸€äº›ç”¨æˆ·å¢åŠ ç§¯åˆ†
    alice->add_points(50);
    charlie->add_points(25);

    // å°†ç”¨æˆ·åŠ å…¥åˆ°å¾…å¤„ç†é˜Ÿåˆ—
    users_for_processing.push_back(alice);
    users_for_processing.push_back(bob);

    std::cout << "\nåˆ é™¤ä¸€äº›ç”¨æˆ·..." << std::endl;
    // æ¨¡æ‹Ÿç”¨æˆ·æ³¨é”€ï¼Œåˆ é™¤Bob
    for (auto it = active_users.begin(); it != active_users.end(); ) {
        if ((*it)->get_name() == "Bob") {
            delete *it;  // é‡Šæ”¾Bobçš„å†…å­˜
            it = active_users.erase(it);  // ä»æ´»è·ƒç”¨æˆ·åˆ—è¡¨ç§»é™¤
        } else {
            ++it;
        }
    }

    // è¿™é‡Œçš„é—®é¢˜æ˜¯ï¼šBobå·²ç»è¢«åˆ é™¤ï¼Œä½†users_for_processingä¸­ä»ç„¶ä¿ç•™äº†æŒ‡å‘Bobçš„æŒ‡é’ˆ
    // å½“è°ƒç”¨process_lateræ—¶ï¼Œå°è¯•è®¿é—®Bobçš„æˆå‘˜å°†å¯¼è‡´å´©æºƒ
    process_later(users_for_processing);  // è¿™é‡Œä¼šå´©æºƒï¼

    // æ¸…ç†å‰©ä½™ç”¨æˆ·
    for (auto user : active_users) {
        delete user;
    }

    return 0;
}
```

ç¼–è¯‘å¹¶è¿è¡Œè¿™ä¸ªç¨‹åºï¼š

```bash
g++ -g uaf_crash.cpp -o uaf_crash
./uaf_crash
```

ç¨‹åºä¼šè¾“å‡ºï¼š

```plain
åˆ›å»ºç”¨æˆ·: Alice, åˆå§‹ç§¯åˆ†: 100
åˆ›å»ºç”¨æˆ·: Bob, åˆå§‹ç§¯åˆ†: 150
åˆ›å»ºç”¨æˆ·: Charlie, åˆå§‹ç§¯åˆ†: 200
Alice è·å¾— 50 ç§¯åˆ†ï¼Œå½“å‰æ€»åˆ†: 150
Charlie è·å¾— 25 ç§¯åˆ†ï¼Œå½“å‰æ€»åˆ†: 225

åˆ é™¤ä¸€äº›ç”¨æˆ·...
é”€æ¯ç”¨æˆ·: Bob

è¿›è¡Œå»¶è¿Ÿå¤„ç†...
å¤„ç†ç”¨æˆ·: Alice, ç§¯åˆ†: 150
Segmentation fault (core dumped)
```

å®Œç¾ï¼æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªcore dumpã€‚ç°åœ¨ç”¨ GDB åˆ†æï¼š

```bash
gdb ./uaf_crash /tmp/core-uaf_crash-xxxx-xxxx
```

GDBä¼šå‘Šè¯‰æˆ‘ä»¬å´©æºƒçš„ä½ç½®ï¼š

```plain
warning: Section `.reg-xstate/3522' in core file too small.
#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50
50	../sysdeps/unix/sysv/linux/raise.c: No such file or directory.

```

æŸ¥çœ‹æ›´å¤šä¿¡æ¯ï¼š

```bash
(gdb) bt
#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50
#1  0x00007fdc31ebb859 in __GI_abort () at abort.c:79
#2  0x00007fdc32154ee6 in ?? () from /lib/x86_64-linux-gnu/libstdc++.so.6
#3  0x00007fdc32166f8c in ?? () from /lib/x86_64-linux-gnu/libstdc++.so.6
#4  0x00007fdc32166ff7 in std::terminate() () from /lib/x86_64-linux-gnu/libstdc++.so.6
#5  0x00007fdc32167258 in __cxa_throw () from /lib/x86_64-linux-gnu/libstdc++.so.6
#6  0x00007fdc321549ba in ?? () from /lib/x86_64-linux-gnu/libstdc++.so.6
#7  0x00007fdc3220c73a in void std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >::_M_construct<char*>(char*, char*, std::forward_iterator_tag) () from /lib/x86_64-linux-gnu/libstdc++.so.6
#8  0x0000562f0f6f6d39 in User::get_name[abi:cxx11]() const (this=0x562f3f227710) at test2.cpp:29
#9  0x0000562f0f6f64d0 in process_later (users=std::vector of length 2, capacity 2 = {...}) at test2.cpp:43
#10 0x0000562f0f6f68c9 in main () at test2.cpp:83

(gdb) frame 8
#8  0x0000562f0f6f6d39 in User::get_name[abi:cxx11]() const (this=0x562f3f227710) at test2.cpp:29
29	        return name;

(gdb) p *this
$1 = {name = <error reading variable: Cannot create a lazy string with address 0x0, and a non-zero length.>, score = 0x0}
```

çœ‹åˆ°é—®é¢˜äº†å—ï¼Ÿæˆ‘ä»¬å‘ç°ï¼šç¨‹åºåœ¨`User::get_name()`æ–¹æ³•ä¸­å´©æºƒï¼Œå°è¯•è®¿é—®ç©ºæŒ‡é’ˆ

é€šè¿‡è°ƒç”¨æ ˆï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å´©æºƒå‘ç”Ÿåœ¨`process_later`å‡½æ•°ä¸­ï¼Œæœ€ç»ˆè¿½æº¯åˆ°mainå‡½æ•°çš„ç¬¬29è¡Œã€‚

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„**Use After Free**ï¼ˆé‡Šæ”¾åä½¿ç”¨ï¼‰é”™è¯¯ï¼šæˆ‘ä»¬åœ¨ç¬¬ 74 è¡Œåˆ é™¤äº† Bob å¯¹è±¡ï¼Œä½†åœ¨ç¬¬43è¡Œçš„`process_later`å‡½æ•°ä¸­ä»ç„¶å°è¯•ä½¿ç”¨æŒ‡å‘å·²åˆ é™¤å¯¹è±¡çš„æŒ‡é’ˆã€‚

### å¦‚ä½•ä¿®å¤è¿™ç±»é—®é¢˜ï¼Ÿ
**ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ**ï¼šä½¿ç”¨`std::shared_ptr`å¯ä»¥é¿å…è¿™ç±»é—®é¢˜ 

```cpp
std::vector<std::shared_ptr<User>> active_users;
std::vector<std::shared_ptr<User>> users_for_processing;

auto alice = std::make_shared<User>("Alice", 100);
```



è¿™ä¸ªä¾‹å­å±•ç¤ºäº†C++ä¸­æœ€å¸¸è§ä¸”æœ€éš¾è°ƒè¯•çš„é—®é¢˜ä¹‹ä¸€ï¼šæ‚¬ç©ºæŒ‡é’ˆï¼ˆdangling pointersï¼‰ã€‚åœ¨å¤æ‚ç³»ç»Ÿä¸­ï¼Œå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ä¸å½“ç»å¸¸å¯¼è‡´è¿™ç±»é—®é¢˜ï¼Œè€Œ core dump åˆ†ææ˜¯å‘ç°å®ƒä»¬çš„æœ‰åŠ›å·¥å…·ã€‚

## å…«ã€å¸¸è§å´©æºƒç±»å‹åŠè§£å†³æ–¹æ³•
é€šè¿‡core dumpæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥è¯Šæ–­å‡ºå¾ˆå¤šå¸¸è§çš„å´©æºƒç±»å‹ï¼š

1ã€ **ç©ºæŒ‡é’ˆè§£å¼•ç”¨**ï¼ˆåˆšæ‰ç¬¬ä¸€ä¸ªä¾‹å­ï¼‰ 
+ ç—‡çŠ¶ï¼šè®¿é—®åœ°å€0x0é™„è¿‘çš„å†…å­˜
+ è§£å†³ï¼šä½¿ç”¨å‰æ£€æŸ¥æŒ‡é’ˆæ˜¯å¦ä¸ºnullptr

2ã€ **æ•°ç»„è¶Šç•Œ**
+ ç—‡çŠ¶ï¼šè®¿é—®æ•°ç»„è¾¹ç•Œä¹‹å¤–çš„å†…å­˜
+ è§£å†³ï¼šç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…ï¼Œä½¿ç”¨at()ç­‰å¸¦è¾¹ç•Œæ£€æŸ¥çš„æ–¹æ³•

3ã€ **ä½¿ç”¨å·²é‡Šæ”¾çš„å†…å­˜ï¼ˆæ‚¬ç©ºæŒ‡é’ˆï¼‰**
+ ç—‡çŠ¶ï¼šè®¿é—®å·²ç»è¢«freeæˆ–deleteçš„å†…å­˜
+ è§£å†³ï¼šé‡Šæ”¾åå°†æŒ‡é’ˆç½®ç©ºï¼Œä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ

4ã€ **æ ˆæº¢å‡º**
+ ç—‡çŠ¶ï¼šé€’å½’å¤ªæ·±æˆ–å±€éƒ¨å˜é‡å¤ªå¤§
+ è§£å†³ï¼šæ§åˆ¶é€’å½’æ·±åº¦ï¼Œå¤§æ•°ç»„ä½¿ç”¨å †å†…å­˜

5ã€ **å¤šçº¿ç¨‹æ•°æ®ç«äº‰**
+ ç—‡çŠ¶ï¼šä¸ç¡®å®šä½ç½®å´©æºƒï¼Œä¸æ—¶åºæœ‰å…³
+ è§£å†³ï¼šæ­£ç¡®ä½¿ç”¨é”æˆ–å…¶ä»–åŒæ­¥æœºåˆ¶

## ä¹ã€é¢„é˜²èƒœäºæ²»ç–—ï¼šé¿å…å´©æºƒçš„æœ€ä½³å®è·µ
1ã€ **ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ**ï¼š`std::unique_ptr`å’Œ`std::shared_ptr`å¯ä»¥è‡ªåŠ¨ç®¡ç†å†…å­˜ 

```cpp
std::unique_ptr<int[]> data = std::make_unique<int[]>(10);
```

2ã€ **ä½¿ç”¨è¾¹ç•Œæ£€æŸ¥**ï¼šä¼˜å…ˆä½¿ç”¨STLå®¹å™¨ï¼Œä½¿ç”¨at()è€Œé[] 

```cpp
std::vector<int> vec = {1, 2, 3};
try {
    vec.at(5) = 10;  // ä¼šæŠ›å‡ºå¼‚å¸¸è€Œéå´©æºƒ
} catch (const std::out_of_range& e) {
    std::cerr << "æ•è·åˆ°å¼‚å¸¸: " << e.what() << std::endl;
}
```

3ã€ **å¯ç”¨ç¼–è¯‘å™¨è­¦å‘Š**ï¼š 

```bash
g++ -Wall -Wextra -Werror -g program.cpp -o program
```

4ã€ **ä½¿ç”¨é™æ€åˆ†æå·¥å…·**ï¼šå¦‚cppcheckã€Clang Static Analyzer

5ã€ **å†…å­˜æ£€æŸ¥å·¥å…·**ï¼šå¦‚Valgrindã€AddressSanitizer 

```bash
g++ -g -fsanitize=address program.cpp -o program
```

## åã€æ€»ç»“ï¼šæˆä¸ºC++å´©æºƒç°åœºçš„"ç¥æ¢"
é€šè¿‡æœ¬æ–‡çš„å­¦ä¹ ï¼Œä½ ç°åœ¨åº”è¯¥æŒæ¡äº†ï¼š

1. å¦‚ä½•è®¾ç½®ç³»ç»Ÿç”Ÿæˆ core dump æ–‡ä»¶
2. å¦‚ä½•ä½¿ç”¨ GDB åˆ†æ core dump æ‰¾å‡ºå´©æºƒåŸå› 
3. å¦‚ä½•è¯†åˆ«å¹¶è§£å†³å¸¸è§çš„å´©æºƒé—®é¢˜
4. å¦‚ä½•é¢„é˜²ç¨‹åºå´©æºƒ

è®°ä½ï¼Œè°ƒè¯•ç¨‹åºå´©æºƒå°±åƒä¾¦æ¢ç ´æ¡ˆ - éœ€è¦ä»”ç»†æ”¶é›†è¯æ®ï¼ˆcore dumpï¼‰ï¼Œåˆ†æçº¿ç´¢ï¼ˆè°ƒç”¨æ ˆã€å˜é‡å€¼ï¼‰ï¼Œæœ€ç»ˆæ‰¾å‡º"å‡¶æ‰‹"ï¼ˆbugï¼‰ã€‚

å½“ä¸‹æ¬¡ä½ çš„ç¨‹åºå´©æºƒæ—¶ï¼Œä¸è¦æƒŠæ…Œï¼Œæ‹¿å‡ºä½ çš„"ä¾¦æ¢å·¥å…·ç®±"ï¼Œæ²‰ç€å†·é™åœ°è¯´ï¼š"ç»™æˆ‘ä¸€ä¸ªcore dumpï¼Œæˆ‘èƒ½å‘Šè¯‰ä½ å“ªé‡Œå‡ºäº†é—®é¢˜ï¼"

---

**å½©è›‹**ï¼šå¦‚æœä½ æƒ³æµ‹è¯•è‡ªå·±æ˜¯å¦çœŸçš„æŒæ¡äº†è¿™äº›çŸ¥è¯†ï¼Œå¯ä»¥å°è¯•åˆ†æä»¥ä¸‹å´©æºƒä»£ç å¹¶æ‰¾å‡ºé—®é¢˜æ‰€åœ¨ï¼š

```cpp
#include <iostream>
#include <string>

class Person {
private:
char* name;
int age;

public:
Person(const std::string& n, int a) : age(a) {
    name = new char[n.length() + 1];
    strcpy(name, n.c_str());
    std::cout << "Person created: " << name << std::endl;
}

// ææ„å‡½æ•°
~Person() {
    std::cout << "Person destroyed: " << name << std::endl;
    delete[] name;
}

// æ‹·è´æ„é€ å‡½æ•° - æœ‰é‡å¤§ç¼ºé™·ï¼
Person(const Person& other) : age(other.age) {
    // æµ…æ‹·è´ï¼åªå¤åˆ¶äº†æŒ‡é’ˆï¼Œæ²¡æœ‰å¤åˆ¶å†…å®¹
    name = other.name;  // å±é™©ï¼ä¸¤ä¸ªå¯¹è±¡æŒ‡å‘åŒä¸€å—å†…å­˜
}

void introduce() {
    std::cout << "Hi, I'm " << name << ", " << age << " years old." << std::endl;
}
};

int main() {
    {
        Person original("Alice", 30);
        original.introduce();

        // åˆ›å»ºä¸€ä¸ªå‰¯æœ¬
        Person copy = original;  // ä½¿ç”¨æœ‰ç¼ºé™·çš„æ‹·è´æ„é€ å‡½æ•°
        copy.introduce();

        // è¿™é‡Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿå½“originalå’Œcopyéƒ½è¢«é”€æ¯æ—¶...
    }  // ä½œç”¨åŸŸç»“æŸï¼Œä¸¤ä¸ªå¯¹è±¡éƒ½ä¼šè¢«é”€æ¯

    std::cout << "Program finished." << std::endl;  // è¿™è¡Œä¼šæ‰§è¡Œå—ï¼Ÿ

    return 0;
}
```

**æç¤º**ï¼šè¿™ä¸ªç¨‹åºä¼šåœ¨å“ªé‡Œå´©æºƒï¼Ÿä¸ºä»€ä¹ˆï¼Ÿå¦‚ä½•ä¿®å¤å®ƒï¼Ÿ

å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©ä½ åœ¨ C++ ç¨‹åºå´©æºƒé—®é¢˜é¢å‰æ›´åŠ ä»å®¹ï¼å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€è®¨è®ºï¼

è§‰å¾—ä¸é”™çš„è¯ï¼Œè®°å¾—**ç‚¹èµ**ã€**åœ¨çœ‹**ã€**è½¬å‘**,æ”¯æŒä¸€ä¸‹æˆ‘å“¦~

ğŸ‘‰ å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€Œ**è·Ÿç€å°åº·å­¦ç¼–ç¨‹**ã€ï¼Œè§£é”æ›´å¤š C++ æŠ€èƒ½ï¼

## ğŸš€ è·Ÿæˆ‘å­¦ï¼Œä½ èƒ½æ”¶è·å•¥ï¼Ÿ

åœ¨è¿™é‡Œï¼Œä½ ä¸ä»…èƒ½çœ‹åˆ°å¹²è´§ï¼Œè¿˜èƒ½çœŸæ­£å­¦åˆ°èƒ½ç”¨çš„æŠ€èƒ½ï¼š

+ **Linux å®æˆ˜æŠ€å·§**ï¼šæœåŠ¡å™¨è°ƒä¼˜ã€å¸¸ç”¨å‘½ä»¤ã€Shell è„šæœ¬ï¼Œè®©ä½ åƒé«˜æ‰‹ä¸€æ ·æ“ä½œç³»ç»Ÿã€‚
+ **C/C++ åå°å¼€å‘**ï¼šä»åŸºç¡€è¯­æ³•åˆ°é«˜æ€§èƒ½ç¼–ç¨‹ï¼Œå¸¦ä½ å†™å‡ºç¨³ã€å¿«ã€å¯ç»´æŠ¤çš„æœåŠ¡ç«¯ä»£ç ã€‚
+ **C/C++ é¡¹ç›®å®æˆ˜**ï¼šçœŸå®é¡¹ç›®æ¡ˆä¾‹ï¼Œæ•™ä½ ä»éœ€æ±‚åˆ°ä¸Šçº¿å®Œæ•´æµç¨‹ï¼ŒæŒæ¡å¼€å‘å¥—è·¯å’Œæœ€ä½³å®è·µã€‚
+ **å¸¸ç”¨å¼€å‘å·¥å…·**ï¼šè°ƒè¯•ã€ç‰ˆæœ¬æ§åˆ¶ã€æ„å»ºå·¥å…·ã€æ€§èƒ½åˆ†æå·¥å…·ï¼Œè®©å¼€å‘æ•ˆç‡å¤§å¹…æå‡ã€‚
+ **æ€§èƒ½ä¼˜åŒ–**ï¼šCPU/å†…å­˜/IO è°ƒä¼˜æŠ€å·§ï¼Œå®šä½ç“¶é¢ˆï¼Œè®©ä½ çš„ç¨‹åºè·‘å¾—æ›´å¿«æ›´ç¨³ã€‚
+ **é¡¹ç›®æ¶æ„è®¾è®¡**ï¼šå¾®æœåŠ¡ã€åˆ†å±‚æ¶æ„ã€æ¨¡å—è®¾è®¡æ€è·¯ï¼Œå¸®ä½ æ„å»ºå¯æ‰©å±•ã€æ˜“ç»´æŠ¤çš„ç³»ç»Ÿã€‚
+ **Go åç«¯å¼€å‘**ï¼šå¾®æœåŠ¡ã€äº‘åŸç”Ÿå®æˆ˜ï¼Œæ•™ä½ ç”¨ Go æ­å»ºé«˜å¹¶å‘ã€é«˜å¯ç”¨ç³»ç»Ÿã€‚
+ **ç¼–ç¨‹é¢è¯•å¹²è´§ & ç®—æ³•**ï¼šæ ¸å¿ƒç®—æ³•å¥—è·¯ã€é¢è¯•é«˜é¢‘é¢˜è§£æï¼Œè®©ä½ ä¸å†æ‰‹å¿™è„šä¹±ã€‚
+ **è®¡ç®—æœºåŸºç¡€æ¢³ç†**ï¼šæ“ä½œç³»ç»Ÿã€ç½‘ç»œã€æ•°æ®ç»“æ„ã€å¹¶å‘åŸç†ï¼ŒçŸ¥è¯†ä½“ç³»æ¸…æ™°æ˜äº†ã€‚
+ **æˆé•¿è·¯çº¿å›¾**ï¼šç³»ç»Ÿè§„åˆ’ä½ çš„å­¦ä¹ è·¯å¾„ï¼Œä»åˆå­¦åˆ°é«˜çº§ï¼Œå¸®ä½ å°‘èµ°å¼¯è·¯ã€‚

å†…å®¹**æ·±å…¥æµ…å‡ºã€å®ç”¨æœ‰è¶£**ï¼Œå†ä¹Ÿä¸ç”¨çœ‹ä¹¦çœ‹åˆ°ç¡ç€ã€‚  
æ— è®ºæ˜¯é¢è¯•å†²åˆºï¼Œè¿˜æ˜¯æŠ€èƒ½å‡çº§ï¼Œè¿™é‡Œéƒ½æ˜¯ä½ çš„â€œæŠ€æœ¯åŠ æ²¹ç«™â€ã€‚


## ğŸ‘€ æƒ³åŠ å…¥ï¼Ÿå¾ˆç®€å•ï¼
**æ‰«ä¸€æ‰«ä¸‹é¢äºŒç»´ç **ï¼Œä¸€é”®å…³æ³¨å…¬ä¼—å·ï¼Œå¼€å¯ä½ çš„æŠ€æœ¯å­¦ä¹ ä¹‹æ—…ï¼

![](https://files.mdnice.com/user/71186/0dde803d-d52f-4ed8-b74b-b7f3da5817b9.png)

å¦å¤–ï¼Œæˆ‘è¿˜å»ºäº†ä¸€ä¸ª**æŠ€æœ¯äº¤æµç¾¤**ï¼Œé‡Œé¢éƒ½æ˜¯è®¤çœŸå†™ä»£ç çš„å°ä¼™ä¼´ï¼Œä¸å¹ç‰›ã€ä¸é—²èŠï¼ŒåªèŠæŠ€æœ¯ã€‚  
æœ‰é—®é¢˜ï¼Ÿå¤§å®¶ä¸€å—å„¿è®¨è®ºï¼Œæ¯”ä¸€ä¸ªäººé—·å¤´å­¦æ•ˆç‡é«˜å¤šäº†ï¼

![](https://files.mdnice.com/user/48364/4ebc72e9-e4bb-447a-9a92-8367a178df6d.png)

æŠ€æœ¯è¿™æ¡è·¯ï¼Œä¸€ä¸ªäººèµ°å®¹æ˜“è¿·è·¯ï¼Œä¸€ç¾¤äººèµ°æ‰æœ‰æ–¹å‘ã€‚  
è·Ÿä¸ŠèŠ‚å¥ï¼Œæˆ‘ä»¬ä¸€èµ·å˜å¼º ğŸ’ª