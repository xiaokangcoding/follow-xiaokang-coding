> "ä½ è¿™ç¨‹åºæ€ä¹ˆè¿™ä¹ˆå¡å•Šï¼Ÿèƒ½ä¸èƒ½ä¼˜åŒ–ä¸€ä¸‹ï¼Ÿ"  
â€”â€” ä½ çš„leaderï¼Œå¤§æ¦‚ç‡
>

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°åº·ã€‚

ä½ æœ‰æ²¡æœ‰è¿™æ ·çš„ç»å†ï¼šè¾›è¾›è‹¦è‹¦å†™å®Œçš„ C++ ç¨‹åºï¼ŒåŠŸèƒ½æµ‹è¯•ä¸€åˆ‡æ­£å¸¸ï¼Œä½†ä¸€åˆ°ç”Ÿäº§ç¯å¢ƒå°±è¢«åæ§½"å¤ªæ…¢äº†"ï¼Ÿä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬ç»å¸¸è¢«è¦æ±‚è§£å†³æ€§èƒ½é—®é¢˜ï¼Œä½†å¦‚ä½•æ‰¾å‡ºç¨‹åºçš„æ€§èƒ½ç“¶é¢ˆï¼Œå´æ˜¯å¾ˆå¤šäººçš„ç›²åŒºã€‚

ä»Šå¤©ï¼Œæˆ‘å°±ç”¨å¤§ç™½è¯å¸¦ä½ å…¥é—¨ **Linux ç¯å¢ƒä¸‹ C/C++ ç¨‹åºçš„æ€§èƒ½åˆ†æ**(**å¸¦å®æˆ˜æ¡ˆä¾‹**)ï¼Œè®©ä½ é¢å¯¹æ€§èƒ½é—®é¢˜æ—¶ä¸å†æŠ“çã€‚ä¸éœ€è¦é«˜æ·±çš„ç†è®ºï¼Œä¸éœ€è¦å¤æ‚çš„å·¥å…·ï¼Œè¿™ç¯‡æ–‡ç« è¯»å®Œï¼Œä½ å°±èƒ½å®æˆ˜äº†ï¼

>æƒ³ç³»ç»Ÿå­¦ä¹ æ›´å¤š C++ çŸ¥è¯†ï¼Ÿæ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€Œ**è·Ÿç€å°åº·ç¼–ç¨‹**ã€ï¼Œæˆ‘ä¼šæŒç»­æ›´æ–° Cã€ C++ã€Linuxã€åç«¯å¼€å‘ç­‰é«˜è´¨é‡æŠ€æœ¯æ–‡ç« ã€‚ä¹Ÿå¯ä»¥åŠ æˆ‘çš„ä¸ªäººå¾®ä¿¡ï¼Œä¸€èµ·è¿›ç¾¤è®¨è®ºå­¦ä¹ ï¼
>
> 
> <table>
> <tr>
> <td align="center">
> <img src="https://github.com/xiaokangcoding/follow-xiaokang-coding/raw/main/images/qrcode-wechat-official.png" width="200">
> <br>
> <em>å…¬ä¼—å·ã€Œè·Ÿç€å­¦å°åº·ç¼–ç¨‹ã€</em>
> </td>
> <td align="center">
> <img src="https://github.com/xiaokangcoding/follow-xiaokang-coding/raw/main/images/qrcode-personal-wechat.png" width="200">
> <br>
> <em>ä¸ªäººå¾®ä¿¡ï¼ˆå¤‡æ³¨ï¼šåŠ ç¾¤ï¼‰</em>
> </td>
> </tr>
> </table>

## ä¸ºä»€ä¹ˆç¨‹åºä¼šæ…¢ï¼Ÿ

åœ¨æ·±å…¥å·¥å…·å’Œæ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥èŠèŠä¸ºä»€ä¹ˆç¨‹åºä¼šæ…¢ã€‚ä¸€ä¸ªç¨‹åºä¸»è¦åœ¨ä¸‰ä¸ªæ–¹é¢æ¶ˆè€—èµ„æºï¼š

1. **CPUæ—¶é—´** - è®¡ç®—å¤ªå¤šã€ç®—æ³•æ•ˆç‡ä½
2. **å†…å­˜ä½¿ç”¨** - å†…å­˜æ³„æ¼ã€é¢‘ç¹ç”³è¯·é‡Šæ”¾å†…å­˜
3. **I/Oæ“ä½œ** - æ–‡ä»¶è¯»å†™ã€ç½‘ç»œé€šä¿¡å¤ªé¢‘ç¹

ä»Šå¤©æˆ‘ä»¬ä¸»è¦èšç„¦**CPUæ€§èƒ½åˆ†æ**ï¼Œå› ä¸ºè¿™é€šå¸¸æ˜¯æœ€ç›´æ¥å½±å“ç¨‹åºé€Ÿåº¦çš„å› ç´ ã€‚å†…å­˜å’Œ I/O é—®é¢˜å’±ä»¬åé¢å†ä¸“é—¨è®²ã€‚

## è°æ˜¯ CPU æ—¶é—´çš„å¤§æˆ·ï¼Ÿç”¨ top æ‰¾å‡ºæ¥

æ—¢ç„¶è¦åˆ†ææ€§èƒ½ï¼Œé‚£é¦–å…ˆå¾—çŸ¥é“æ˜¯ä¸æ˜¯æˆ‘ä»¬çš„ç¨‹åºçœŸçš„è€— CPUã€‚æœ€ç›´è§‚çš„æ–¹æ³•å°±æ˜¯ç”¨`top`å‘½ä»¤å®æ—¶ç›‘æ§ç¨‹åºçš„ CPU å’Œå†…å­˜ä½¿ç”¨æƒ…å†µï¼š

```bash
$ top -p $(pgrep è¿›ç¨‹å)
```

è¿™æ ·ä½ å°±èƒ½çœ‹åˆ°ç¨‹åºçš„ CPU ä½¿ç”¨ç‡ã€‚å¦‚æœä¸€ä¸ªç¨‹åºå ç”¨ CPU æ¥è¿‘ 100%ï¼Œé‚£å®ƒå…«æˆæ˜¯æœ‰æ€§èƒ½é—®é¢˜äº†ã€‚è€Œä¸”é€šè¿‡ topï¼Œä½ è¿˜èƒ½çœ‹åˆ°ç¨‹åºä½¿ç”¨äº†å¤šå°‘å†…å­˜ç­‰ä¿¡æ¯ï¼Œè¿™äº›éƒ½æ˜¯åˆ¤æ–­ç¨‹åºå¥åº·çŠ¶å†µçš„é‡è¦æŒ‡æ ‡ã€‚

## å…¥é—¨çº§å·¥å…·ï¼štimeå‘½ä»¤

å‘ç°ç¨‹åºç¡®å®åƒ CPU åï¼Œæˆ‘ä»¬éœ€è¦æ›´å…·ä½“åœ°çŸ¥é“å®ƒåˆ°åº•æ…¢åœ¨å“ªé‡Œã€‚è¿™æ—¶å¯ä»¥ç”¨ Linux è‡ªå¸¦çš„ `time` å‘½ä»¤æ¥åˆ†æç¨‹åºçš„è¿è¡Œæ—¶é—´æ„æˆï¼š

```bash
$ time ./my_program
```

æ‰§è¡Œåä½ ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„è¾“å‡ºï¼š

```bash
real    0m1.234s
user    0m1.000s
sys     0m0.234s
```

+ **real**ï¼šå®é™…ç»è¿‡çš„æ—¶é—´ï¼ˆå¢™ä¸Šæ—¶é’Ÿæ—¶é—´ï¼‰
+ **user**ï¼šCPUåœ¨ç”¨æˆ·æ€çš„æ‰§è¡Œæ—¶é—´
+ **sys**ï¼šCPUåœ¨å†…æ ¸æ€çš„æ‰§è¡Œæ—¶é—´

å¦‚æœ`user`æ—¶é—´ç‰¹åˆ«é•¿ï¼Œè¯´æ˜ä½ çš„ç¨‹åºè®¡ç®—é‡å¤ªå¤§ï¼›å¦‚æœ`sys`æ—¶é—´ç‰¹åˆ«é•¿ï¼Œè¯´æ˜ä½ çš„ç¨‹åºç³»ç»Ÿè°ƒç”¨å¤ªå¤šã€‚

æ‰“ä¸ªæ¯”æ–¹ï¼Œè¿™å°±åƒä½ å»é¤å…åƒé¥­ï¼š

+ **real**æ—¶é—´æ˜¯ä»ä½ è¿›é—¨åˆ°å‡ºé—¨çš„æ€»æ—¶é—´
+ **user**æ—¶é—´æ˜¯ä½ å®é™…åƒé¥­çš„æ—¶é—´
+ **sys**æ—¶é—´æ˜¯æœåŠ¡å‘˜ç«¯èœã€æ”¶æ‹¾æ¡Œå­çš„æ—¶é—´

## æ€§èƒ½åˆ†æçš„ç§˜å¯†æ­¦å™¨ï¼šperf

`time`å’Œ`top`åªèƒ½å‘Šè¯‰ä½ ç¨‹åºæ…¢ï¼Œä½†å…·ä½“æ…¢åœ¨å“ªä¸ªå‡½æ•°ï¼Œè¿˜å¾—é ä¸“ä¸šå·¥å…·ã€‚Linuxä¸‹æœ€å¼ºå¤§çš„æ€§èƒ½åˆ†æå·¥å…·ä¹‹ä¸€å°±æ˜¯`perf`ã€‚

### å®‰è£…perf

```bash
# Ubuntu/Debian
$ sudo apt-get install linux-tools-common linux-tools-generic

# CentOS/RHEL
$ sudo yum install perf
```

### å®æˆ˜ï¼šæ‰¾å‡ºCPUæ€æ‰‹

ç¨‹åºæ…¢äº†ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾å‡ºå…·ä½“æ˜¯å“ªæ®µä»£ç æ‹–äº†åè…¿ã€‚perf å°±æ˜¯æœ€å¥½çš„ä¾¦æ¢å·¥å…·ï¼š

```bash
# å¼€å‘ç¯å¢ƒï¼šä»å¯åŠ¨å¼€å§‹è®°å½•
$ sudo perf record -g ./slow_program

# ç”Ÿäº§ç¯å¢ƒï¼šå¯¹è¿è¡Œä¸­ç¨‹åºé‡‡æ ·30ç§’
$ sudo perf record -p <è¿›ç¨‹ID> -g -F 99 sleep 30

# åˆ†æç»“æœ
$ perf report
```

å¼€å‘ç¯å¢ƒç”¨ç¬¬ä¸€ç§æ–¹å¼ï¼Œèƒ½çœ‹åˆ°ç¨‹åºä»å¯åŠ¨åˆ°ç»“æŸçš„å…¨è¿‡ç¨‹ï¼›ç”Ÿäº§ç¯å¢ƒç”¨ç¬¬äºŒç§æ–¹å¼ï¼Œä¸ç”¨é‡å¯æœåŠ¡å°±èƒ½é‡‡æ ·æ•°æ®ã€‚`perf report`ä¼šæ˜¾ç¤ºå“ªäº›å‡½æ•°æœ€è€— CPUï¼Œç›´æ¥æŒ‡å‡ºé—®é¢˜æ‰€åœ¨ï¼

æˆ‘æ›¾ç»é‡åˆ°è¿‡ä¸€ä¸ªå®é™…æ¡ˆä¾‹ï¼šç¨‹åºå¤„ç†å¤§é‡æ•°æ®éå¸¸æ…¢ï¼Œç”¨ perf ä¸€çœ‹ï¼Œå‘ç° 80% çš„ CPU æ—¶é—´éƒ½èŠ±åœ¨äº†ä¸€ä¸ªå­—ç¬¦ä¸²å¤„ç†å‡½æ•°ä¸Šã€‚æŠŠè¿™ä¸ªå‡½æ•°ä¼˜åŒ–åï¼Œæ•´ä¸ªç¨‹åºé€Ÿåº¦æå‡äº† 5 å€ã€‚

## æ›´ç›´è§‚çš„ç«ç„°å›¾ï¼šFlameGraph

perf çš„è¾“å‡ºæœ‰æ—¶å€™ä¸å¤Ÿç›´è§‚ï¼Œè¿™æ—¶å€™å°±éœ€è¦"ç«ç„°å›¾"(FlameGraph)å‡ºåœºäº†ã€‚ç«ç„°å›¾èƒ½æŠŠ perf çš„ç»“æœå¯è§†åŒ–ï¼Œä¸€çœ¼å°±èƒ½çœ‹å‡ºå“ªä¸ªå‡½æ•°æœ€è€—æ—¶ã€‚

### ç”Ÿæˆç«ç„°å›¾

```bash
# å…ˆè®°å½•perfæ•°æ®
$ sudo perf record -p <è¿›ç¨‹ID> -g -F 99 sleep 30

# å¯¼å‡ºæ•°æ®
$ perf script > perf.out

# ç”¨FlameGraphå·¥å…·ç”ŸæˆSVGå›¾
$ git clone https://github.com/brendangregg/FlameGraph.git
$ cd FlameGraph
$ ./stackcollapse-perf.pl ../perf.out > ../perf.folded
$ ./flamegraph.pl ../perf.folded > ../flamegraph.svg

# ä½¿ç”¨ firefox æ‰“å¼€
$ firefox flamegraph.svg
```

ç„¶åç”¨æµè§ˆå™¨æ‰“å¼€ç”Ÿæˆçš„ svg æ–‡ä»¶ï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªç‚«é…·çš„ç«ç„°å›¾ï¼å›¾ä¸­å®½åº¦è¶Šå¤§çš„å‡½æ•°ï¼Œå ç”¨çš„ CPU æ—¶é—´å°±è¶Šå¤šã€‚

## å®æˆ˜æ¡ˆä¾‹ï¼šä¼˜åŒ–ä¸€ä¸ªæ—¥å¿—è§£æç¨‹åº

å‰å‡ å¤©æˆ‘æœ‰ä¸ªå°éœ€æ±‚ï¼Œéœ€è¦è§£æä¸€äº›æœåŠ¡å™¨æ—¥å¿—æ–‡ä»¶ï¼Œæå–å‡ºæ‰€æœ‰ **ERROR** çº§åˆ«çš„æ—¥å¿—ï¼Œå¹¶ç”Ÿæˆä¸ªç®€å•æŠ¥å‘Šã€‚æˆ‘å†™äº†ä¸ªç¬¬ä¸€ç‰ˆçš„ç¨‹åºï¼Œä½†åœ¨å¤„ç†ä¸€ä¸ª **893MB** çš„æ—¥å¿—æ–‡ä»¶æ—¶ï¼Œè·‘äº†æ•´æ•´ 3 åˆ†é’Ÿæ‰å‡ºç»“æœï¼Œè¿™ä¹Ÿå¤ªæ…¢äº†å§ï¼

ä»£ç æ˜¯è¿™æ ·çš„ï¼š

```c++
// slow_parser.cpp
#include <iostream>
#include <fstream>
#include <string>
#include <regex>
#include <vector>

struct LogEntry {
    std::string timestamp;
    std::string level;
    std::string message;
};

std::vector<LogEntry> parse_log(const std::string& filename) {
    std::vector<LogEntry> entries;
    std::ifstream file(filename);
    std::string line;
    
    // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£ææ—¥å¿—æ ¼å¼ï¼š[æ—¶é—´æˆ³] [æ—¥å¿—çº§åˆ«] æ¶ˆæ¯å†…å®¹
    std::regex log_pattern(R"(\[(.*?)\]\s*\[(.*?)\]\s*(.*))");
    
    while (std::getline(file, line)) {
        std::smatch matches;
        if (std::regex_search(line, matches, log_pattern)) {
            LogEntry entry;
            entry.timestamp = matches[1];
            entry.level = matches[2];
            entry.message = matches[3];
            
            // åªä¿ç•™ERRORçº§åˆ«çš„æ—¥å¿—
            if (entry.level == "ERROR") {
                entries.push_back(entry);
            }
        }
    }
    
    return entries;
}

int main(int argc, char* argv[]) {
    if (argc != 2) {
        std::cerr << "ç”¨æ³•: " << argv[0] << " <æ—¥å¿—æ–‡ä»¶è·¯å¾„>" << std::endl;
        return 1;
    }
    
    std::cout << "å¼€å§‹è§£ææ—¥å¿—æ–‡ä»¶: " << argv[1] << std::endl;
    auto entries = parse_log(argv[1]);
    std::cout << "å…±å‘ç° " << entries.size() << " æ¡ERRORçº§åˆ«æ—¥å¿—" << std::endl;
    
    // è¾“å‡ºå‰10æ¡é”™è¯¯æ—¥å¿—
    int count = 0;
    for (const auto& entry : entries) {
        if (count++ < 10) {
            std::cout << entry.timestamp << ": " << entry.message << std::endl;
        } else {
            break;
        }
    }
    
    return 0;
}
```

ç¼–è¯‘å¹¶æµ‹è¯•äº†ä¸‹è¿è¡Œæ—¶é—´ï¼š

```bash
$ g++ -g slow_parser.cpp -o slow_parser
$ time ./slow_parser server.log
```

è¿è¡Œç»“æœï¼š

```bash
real	3m0.753s
user	2m54.315s
sys	0m6.399s
```

å·®ä¸å¤š 3 åˆ†é’Ÿï¼Œå¤ªç¦»è°±äº†ï¼æˆ‘å†³å®šç”¨ perf æ¥åˆ†æä¸€ä¸‹åˆ°åº•æ˜¯å“ªé‡Œæ…¢ï¼š

```bash
$ perf record -g ./slow_parser server.log
$ perf report
```

perf report çš„ç»“æœè®©æˆ‘çœ¼å‰ä¸€äº®ï¼š

```bash
Samples: 197K of event 'cycles', Event count (approx.): 94623200788
  Children      Self  Command  Shared Object        Symbol
+   77.46%    15.58%  a.out    a.out                [.] std::__detail::_Executor<__gnu_cxx::__normal_iterator<char const*, std::__cxx11::basic_string<char, sâ—†
+   76.84%     5.75%  a.out    a.out                [.] std::__detail::_Executor<__gnu_cxx::__normal_iterator<char const*, std::__cxx11::basic_string<char, s
+   75.84%     5.91%  a.out    a.out                [.] std::__detail::_Executor<__gnu_cxx::__normal_iterator<char const*, std::__cxx11::basic_string<char, s
+   75.01%     4.26%  a.out    a.out                [.] std::__detail::_Executor<__gnu_cxx::__normal_iterator<char const*, std::__cxx11::basic_string<char, s
+   71.60%     0.62%  a.out    a.out                [.] std::__detail::_Executor<__gnu_cxx::__normal_iterator<char const*, std::__cxx11::basic_string<char, s
...
+   48.18%     0.05%  a.out    a.out                [.] std::regex_search<__gnu_cxx::__normal_iterator<char const*, std::__cxx11::basic_string<char, std::cha
...
```

è¿™é‡Œéœ€è¦ç†è§£ä¸¤ä¸ªå…³é”®åˆ—ï¼š

+ **Self**ï¼šå‡½æ•°è‡ªèº«æ¶ˆè€—çš„CPUæ—¶é—´ç™¾åˆ†æ¯”
+ **Children**ï¼šå‡½æ•°åŠå…¶è°ƒç”¨çš„æ‰€æœ‰å­å‡½æ•°æ¶ˆè€—çš„CPUæ—¶é—´ç™¾åˆ†æ¯”

ç®€å•è¯´ï¼ŒSelf å‘Šè¯‰ä½ "è¿™ä¸ªå‡½æ•°æœ¬èº«"æœ‰å¤šæ…¢ï¼ŒChildren å‘Šè¯‰ä½ "è¿™ä¸ªå‡½æ•°åŠå®ƒè°ƒç”¨çš„æ‰€æœ‰å‡½æ•°"ä¸€å…±æœ‰å¤šæ…¢ã€‚æ€§èƒ½ä¼˜åŒ–æ—¶ï¼Œé€šå¸¸å…ˆçœ‹ Children é«˜çš„å‡½æ•°æ‰¾åˆ°çƒ­ç‚¹è°ƒç”¨é“¾ï¼Œå†çœ‹ Self é«˜çš„å‡½æ•°æ‰¾åˆ°çœŸæ­£è€—æ—¶çš„ä»£ç ã€‚

è™½ç„¶è¾“å‡ºç»“æœæœ‰ç‚¹å¤æ‚ï¼Œä½†å¾ˆæ˜æ˜¾ï¼Œå¤§éƒ¨åˆ† CPU æ—¶é—´éƒ½èŠ±åœ¨äº† `std::__detail::_Executor`å’Œ`std::regex_search` è¿™äº›å‡½æ•°ä¸Šï¼Œè¿™äº›éƒ½æ˜¯æ­£åˆ™è¡¨è¾¾å¼ç›¸å…³çš„å‡½æ•°ï¼çœ‹æ¥æ­£åˆ™è¡¨è¾¾å¼æ˜¯ç½ªé­ç¥¸é¦–ã€‚

å…¶å®æƒ³æƒ³ä¹Ÿå¯¹ï¼Œæ­£åˆ™è¡¨è¾¾å¼è™½ç„¶åŠŸèƒ½å¼ºå¤§ï¼Œä½†åœ¨å¤„ç†å¤§é‡æ–‡æœ¬æ—¶ï¼Œæ€§èƒ½ç¡®å®ä¸å¤ªç†æƒ³ã€‚äºæ˜¯æˆ‘å†³å®šç”¨æ™®é€šçš„å­—ç¬¦ä¸²å¤„ç†å‡½æ•°æ¥æ›¿ä»£æ­£åˆ™è¡¨è¾¾å¼ï¼š

```cpp
// fast_parser.cpp
#include <iostream>
#include <fstream>
#include <string>
#include <vector>
#include <chrono>

struct LogEntry {
    std::string timestamp;
    std::string level;
    std::string message;
};

std::vector<LogEntry> parse_log(const std::string& filename) {
    std::vector<LogEntry> entries;
    std::ifstream file(filename);
    std::string line;
    
    // é¢„åˆ†é…ç©ºé—´ï¼Œå‡å°‘å†…å­˜é‡æ–°åˆ†é…
    entries.reserve(10000);
    
    // ä½¿ç”¨å­—ç¬¦ä¸²æœç´¢å’Œæˆªå–æ›¿ä»£æ­£åˆ™è¡¨è¾¾å¼
    while (std::getline(file, line)) {
        size_t first_bracket = line.find('[');
        size_t second_bracket = line.find(']', first_bracket);
        size_t third_bracket = line.find('[', second_bracket);
        size_t fourth_bracket = line.find(']', third_bracket);
        
        if (first_bracket != std::string::npos && second_bracket != std::string::npos &&
            third_bracket != std::string::npos && fourth_bracket != std::string::npos) {
            
            LogEntry entry;
            entry.timestamp = line.substr(first_bracket + 1, second_bracket - first_bracket - 1);
            entry.level = line.substr(third_bracket + 1, fourth_bracket - third_bracket - 1);
            entry.message = line.substr(fourth_bracket + 1);
            
            // å»é™¤æ¶ˆæ¯å‰é¢çš„ç©ºæ ¼
            size_t message_start = entry.message.find_first_not_of(' ');
            if (message_start != std::string::npos) {
                entry.message = entry.message.substr(message_start);
            }
            
            // åªä¿ç•™ERRORçº§åˆ«çš„æ—¥å¿—
            if (entry.level == "ERROR") {
                entries.push_back(entry);
            }
        }
    }
    
    return entries;
}

int main(int argc, char* argv[]) {
    if (argc != 2) {
        std::cerr << "ç”¨æ³•: " << argv[0] << " <æ—¥å¿—æ–‡ä»¶è·¯å¾„>" << std::endl;
        return 1;
    }
    
    auto start_time = std::chrono::high_resolution_clock::now();
    
    std::cout << "å¼€å§‹è§£ææ—¥å¿—æ–‡ä»¶: " << argv[1] << std::endl;
    auto entries = parse_log(argv[1]);
    std::cout << "å…±å‘ç° " << entries.size() << " æ¡ERRORçº§åˆ«æ—¥å¿—" << std::endl;
    
    // è¾“å‡ºå‰10æ¡é”™è¯¯æ—¥å¿—
    int count = 0;
    for (const auto& entry : entries) {
        if (count++ < 10) {
            std::cout << entry.timestamp << ": " << entry.message << std::endl;
        } else {
            break;
        }
    }
    
    auto end_time = std::chrono::high_resolution_clock::now();
    auto duration = std::chrono::duration_cast<std::chrono::milliseconds>(end_time - start_time);
    std::cout << "å¤„ç†è€—æ—¶: " << duration.count() / 1000.0 << " ç§’" << std::endl;
    
    return 0;
}
```

å†æ¬¡ç¼–è¯‘è¿è¡Œï¼š

```bash
$ g++ -O2 fast_parser.cpp -o fast_parser
$ time ./fast_parser server.log
```

ä¼˜åŒ–åçš„ç»“æœï¼š

```bash
real	0m8.188s
user	0m7.240s
sys	0m0.945s
```

å“‡ï¼åªç”¨äº† 8 ç§’å¤šï¼ç›¸æ¯”åŸæ¥çš„ 3 åˆ†é’Ÿï¼Œè¿™ç®€ç›´å°±æ˜¯å¤©å£¤ä¹‹åˆ«å•Šï¼Œé€Ÿåº¦æå‡äº† 20 å¤šå€ï¼

**ä¸»è¦ä¼˜åŒ–ç‚¹ï¼š**

1. ä½¿ç”¨åŸºæœ¬çš„å­—ç¬¦ä¸²æ“ä½œæ›¿ä»£äº†æ­£åˆ™è¡¨è¾¾å¼
2. é¢„åˆ†é…äº† vector çš„ç©ºé—´ï¼Œå‡å°‘å†…å­˜é‡æ–°åˆ†é…
3. å¢åŠ äº† -O2 ç¼–è¯‘ä¼˜åŒ–é€‰é¡¹
4. æ·»åŠ äº†æ—¶é—´æµ‹é‡ä»£ç ï¼Œæ–¹ä¾¿å¯¹æ¯”æ€§èƒ½

**è¿™ä¸ªå°å®éªŒç»™æˆ‘çš„å¯ç¤ºæ˜¯**ï¼šè™½ç„¶æ­£åˆ™è¡¨è¾¾å¼å†™èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œä½†åœ¨å¤„ç†å¤§é‡æ•°æ®æ—¶ï¼Œå¯èƒ½æˆä¸ºä¸¥é‡çš„æ€§èƒ½ç“¶é¢ˆã€‚

ç”¨æ€§èƒ½åˆ†æå·¥å…·æ‰¾å‡ºè¿™äº›ç“¶é¢ˆï¼Œç„¶åç”¨æ›´é«˜æ•ˆçš„æ–¹æ³•æ›¿ä»£ï¼Œå°±èƒ½å¤§å¹…æå‡ç¨‹åºæ€§èƒ½ã€‚è¿™åœ¨å®é™…å·¥ä½œä¸­å¯æ˜¯èƒ½çœä¸‹ä¸å°‘æ—¶é—´çš„æŠ€èƒ½å•Šï¼

## æ€§èƒ½åˆ†æçš„å®ç”¨æŠ€å·§

1ã€ **å…ˆç”¨ç®€å•å·¥å…·**ï¼šä¸è¦ä¸€ä¸Šæ¥å°±ç”¨å¤æ‚å·¥å…·ã€‚å…ˆç”¨ timeã€top è¿™äº›ç®€å•å‘½ä»¤ï¼Œç¡®å®šé—®é¢˜å¤§è‡´åœ¨å“ªã€‚

2ã€**äºŒå…«åŸåˆ™**ï¼šç¨‹åº 80% çš„æ—¶é—´å¾€å¾€èŠ±åœ¨ 20% çš„ä»£ç ä¸Šã€‚æ‰¾åˆ°è¿™ 20% çš„"çƒ­ç‚¹"ä»£ç æ˜¯å…³é”®ã€‚

3ã€ **äºŒåˆ†æŸ¥æ‰¾æ³•æ‰¾æ€§èƒ½é—®é¢˜**ï¼šå¦‚æœé¡¹ç›®å¾ˆå¤§ï¼Œä¸çŸ¥é“ä»å“ªä¸‹æ‰‹ï¼Œå¯ä»¥è¯•è¯•"äºŒåˆ†æ³•"ï¼š
+ æŠŠç¨‹åºçš„åŠŸèƒ½æ¨¡å—åˆ†æˆä¸¤åŠ
+ æš‚æ—¶ç¦ç”¨ä¸€åŠï¼Œçœ‹é—®é¢˜æ˜¯å¦è¿˜å­˜åœ¨
+ æ ¹æ®ç»“æœï¼Œç»§ç»­å¯¹æœ‰é—®é¢˜çš„é‚£ä¸€åŠå†åˆ†æˆä¸¤åŠ
+ å¦‚æ­¤åå¤ï¼Œç›´åˆ°å®šä½åˆ°å…·ä½“æ¨¡å—

4ã€**ç¼–è¯‘ä¼˜åŒ–**ï¼šåˆ«å¿˜äº†ç¼–è¯‘æ—¶çš„ä¼˜åŒ–é€‰é¡¹ï¼Œæ¯”å¦‚ï¼š

```bash
$ g++ -O2 your_program.cpp -o your_program
```

5ã€**ä½¿ç”¨æ€§èƒ½åˆ†æå™¨**ï¼šé™¤äº† perfï¼Œè¿˜æœ‰å¾ˆå¤šå¥½ç”¨çš„å·¥å…·ï¼Œæ¯”å¦‚ Valgrind çš„Callgrindã€gperftoolsç­‰ã€‚

6ã€**ä¸è¦è¿‡æ—©ä¼˜åŒ–**ï¼šå…ˆè®©ç¨‹åºæ­£ç¡®è¿è¡Œï¼Œå†è€ƒè™‘æ€§èƒ½ä¼˜åŒ–ã€‚è¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºï¼

## æ€»ç»“ï¼šæ€§èƒ½åˆ†æçš„"ä¸‰æ¿æ–§"

å¦‚æœä½ æ˜¯åˆå­¦è€…ï¼Œè®°ä½è¿™ä¸ªç®€å•çš„æµç¨‹å°±å¤Ÿäº†ï¼š

1. **ç”¨ top ç›‘æ§ CPU ä½¿ç”¨ç‡**
2. **ç”¨ time æµ‹é‡æ€»æ‰§è¡Œæ—¶é—´**
3. **ç”¨ perf æ‰¾å‡ºå…·ä½“çš„çƒ­ç‚¹å‡½æ•°**

æŒæ¡äº†è¿™"ä¸‰æ¿æ–§"ï¼ŒåŸºæœ¬ä¸Šå°±èƒ½åº”å¯¹ 80% çš„æ€§èƒ½é—®é¢˜äº†ã€‚è‡³äºå†…å­˜å’Œ I/O æ–¹é¢çš„æ€§èƒ½åˆ†æï¼Œæˆ‘ä»¬ä¹‹åå†è¯¦ç»†è®²è§£ã€‚

è®°ä½ï¼Œæ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€é—¨å®æˆ˜æ€§å¾ˆå¼ºçš„æŠ€æœ¯ï¼Œå¤šç»ƒä¹ ï¼Œå¤šåˆ†æï¼Œä½ å¾ˆå¿«å°±èƒ½æˆä¸ºæ€§èƒ½è°ƒä¼˜é«˜æ‰‹ï¼

---

åŠ¨åŠ¨æ‰‹æŒ‡ç‚¹ä¸ªã€Œ**åœ¨çœ‹**ã€ğŸ‘€å’Œã€Œ**èµ**ã€ğŸ‘ï¼Œæˆ–è€…è½¬å‘ç»™èº«è¾¹çš„å¼€å‘è€…å°ä¼™ä¼´ï¼æ¯ä¸€æ¬¡äº’åŠ¨éƒ½æ˜¯å¯¹æˆ‘æœ€å¤§çš„é¼“åŠ±ï¼Œä¹Ÿä¼šè®©æ›´å¤šéœ€è¦çš„äººçœ‹åˆ°è¿™ç¯‡æ–‡ç« ï¼

ä¸‹ç¯‡æ–‡ç« æˆ‘ä»¬å°†è¯¦ç»†ä»‹ç» Linuxä¸‹C/C++ ç¨‹åºçš„å†…å­˜å’Œ I/O æ€§èƒ½åˆ†ææ–¹æ³•ï¼Œæ•¬è¯·æœŸå¾…ï¼

æƒ³å­¦ä¹ æ›´å¤š C/C++ æ€§èƒ½ä¼˜åŒ–å’Œ Linux åç«¯å¼€å‘çŸ¥è¯†ï¼Ÿæ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€Œ**è·Ÿç€å°åº·å­¦ç¼–ç¨‹**ã€ï¼ŒæŒç»­åˆ†äº«ç¡¬æ ¸æŠ€æœ¯å¹²è´§å’Œé¢è¯•ç§˜ç±ï¼

## ğŸš€ è·Ÿæˆ‘å­¦ï¼Œä½ èƒ½æ”¶è·å•¥ï¼Ÿ

åœ¨è¿™é‡Œï¼Œä½ ä¸ä»…èƒ½çœ‹åˆ°å¹²è´§ï¼Œè¿˜èƒ½çœŸæ­£å­¦åˆ°èƒ½ç”¨çš„æŠ€èƒ½ï¼š

+ **Linux å®æˆ˜æŠ€å·§**ï¼šæœåŠ¡å™¨è°ƒä¼˜ã€å¸¸ç”¨å‘½ä»¤ã€Shell è„šæœ¬ï¼Œè®©ä½ åƒé«˜æ‰‹ä¸€æ ·æ“ä½œç³»ç»Ÿã€‚
+ **C/C++ åå°å¼€å‘**ï¼šä»åŸºç¡€è¯­æ³•åˆ°é«˜æ€§èƒ½ç¼–ç¨‹ï¼Œå¸¦ä½ å†™å‡ºç¨³ã€å¿«ã€å¯ç»´æŠ¤çš„æœåŠ¡ç«¯ä»£ç ã€‚
+ **C/C++ é¡¹ç›®å®æˆ˜**ï¼šçœŸå®é¡¹ç›®æ¡ˆä¾‹ï¼Œæ•™ä½ ä»éœ€æ±‚åˆ°ä¸Šçº¿å®Œæ•´æµç¨‹ï¼ŒæŒæ¡å¼€å‘å¥—è·¯å’Œæœ€ä½³å®è·µã€‚
+ **å¸¸ç”¨å¼€å‘å·¥å…·**ï¼šè°ƒè¯•ã€ç‰ˆæœ¬æ§åˆ¶ã€æ„å»ºå·¥å…·ã€æ€§èƒ½åˆ†æå·¥å…·ï¼Œè®©å¼€å‘æ•ˆç‡å¤§å¹…æå‡ã€‚
+ **æ€§èƒ½ä¼˜åŒ–**ï¼šCPU/å†…å­˜/IO è°ƒä¼˜æŠ€å·§ï¼Œå®šä½ç“¶é¢ˆï¼Œè®©ä½ çš„ç¨‹åºè·‘å¾—æ›´å¿«æ›´ç¨³ã€‚
+ **é¡¹ç›®æ¶æ„è®¾è®¡**ï¼šå¾®æœåŠ¡ã€åˆ†å±‚æ¶æ„ã€æ¨¡å—è®¾è®¡æ€è·¯ï¼Œå¸®ä½ æ„å»ºå¯æ‰©å±•ã€æ˜“ç»´æŠ¤çš„ç³»ç»Ÿã€‚
+ **Go åç«¯å¼€å‘**ï¼šå¾®æœåŠ¡ã€äº‘åŸç”Ÿå®æˆ˜ï¼Œæ•™ä½ ç”¨ Go æ­å»ºé«˜å¹¶å‘ã€é«˜å¯ç”¨ç³»ç»Ÿã€‚
+ **ç¼–ç¨‹é¢è¯•å¹²è´§ & ç®—æ³•**ï¼šæ ¸å¿ƒç®—æ³•å¥—è·¯ã€é¢è¯•é«˜é¢‘é¢˜è§£æï¼Œè®©ä½ ä¸å†æ‰‹å¿™è„šä¹±ã€‚
+ **è®¡ç®—æœºåŸºç¡€æ¢³ç†**ï¼šæ“ä½œç³»ç»Ÿã€ç½‘ç»œã€æ•°æ®ç»“æ„ã€å¹¶å‘åŸç†ï¼ŒçŸ¥è¯†ä½“ç³»æ¸…æ™°æ˜äº†ã€‚
+ **æˆé•¿è·¯çº¿å›¾**ï¼šç³»ç»Ÿè§„åˆ’ä½ çš„å­¦ä¹ è·¯å¾„ï¼Œä»åˆå­¦åˆ°é«˜çº§ï¼Œå¸®ä½ å°‘èµ°å¼¯è·¯ã€‚

å†…å®¹**æ·±å…¥æµ…å‡ºã€å®ç”¨æœ‰è¶£**ï¼Œå†ä¹Ÿä¸ç”¨çœ‹ä¹¦çœ‹åˆ°ç¡ç€ã€‚  
æ— è®ºæ˜¯é¢è¯•å†²åˆºï¼Œè¿˜æ˜¯æŠ€èƒ½å‡çº§ï¼Œè¿™é‡Œéƒ½æ˜¯ä½ çš„â€œæŠ€æœ¯åŠ æ²¹ç«™â€ã€‚


## ğŸ‘€ æƒ³åŠ å…¥ï¼Ÿå¾ˆç®€å•ï¼
**æ‰«ä¸€æ‰«ä¸‹é¢äºŒç»´ç **ï¼Œä¸€é”®å…³æ³¨å…¬ä¼—å·ï¼Œå¼€å¯ä½ çš„æŠ€æœ¯å­¦ä¹ ä¹‹æ—…ï¼

![](https://files.mdnice.com/user/71186/0dde803d-d52f-4ed8-b74b-b7f3da5817b9.png)

å¦å¤–ï¼Œæˆ‘è¿˜å»ºäº†ä¸€ä¸ª**æŠ€æœ¯äº¤æµç¾¤**ï¼Œé‡Œé¢éƒ½æ˜¯è®¤çœŸå†™ä»£ç çš„å°ä¼™ä¼´ï¼Œä¸å¹ç‰›ã€ä¸é—²èŠï¼ŒåªèŠæŠ€æœ¯ã€‚  
æœ‰é—®é¢˜ï¼Ÿå¤§å®¶ä¸€å—å„¿è®¨è®ºï¼Œæ¯”ä¸€ä¸ªäººé—·å¤´å­¦æ•ˆç‡é«˜å¤šäº†ï¼

![](https://files.mdnice.com/user/48364/4ebc72e9-e4bb-447a-9a92-8367a178df6d.png)

æŠ€æœ¯è¿™æ¡è·¯ï¼Œä¸€ä¸ªäººèµ°å®¹æ˜“è¿·è·¯ï¼Œä¸€ç¾¤äººèµ°æ‰æœ‰æ–¹å‘ã€‚  
è·Ÿä¸ŠèŠ‚å¥ï¼Œæˆ‘ä»¬ä¸€èµ·å˜å¼º ğŸ’ª